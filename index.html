<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDA Colombia â€“ GestiÃ³n Comercial</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --am:#FCD116;--az:#003893;--ro:#CE1126;
  --am-l:#fffbe8;--az-l:#eef3ff;--ro-l:#fff0f0;
  --vd:#1a6b3c;--vd-l:#e8f7ee;
  --na:#c05e00;--na-l:#fff4e5;
  --mo:#5b21b6;--mo-l:#f0ebff;
  --bg:#f5f3ef;--card:#ffffff;
  --txt:#18181b;--txt2:#71717a;--txt3:#a1a1aa;
  --bd:#e4e4e7;--bd2:#d4d4d8;
  --sh:0 1px 3px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.07);
  --sh2:0 8px 32px rgba(0,0,0,.14);
  --r:12px;--r2:8px;
  --font:'DM Sans',sans-serif;--serif:'Fraunces',serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--txt);min-height:100vh;line-height:1.5;-webkit-font-smoothing:antialiased}

/* FLAG */
.flag-stripe{height:8px;background:linear-gradient(to right,var(--am) 0 40%,var(--az) 40% 70%,var(--ro) 70% 100%)}

/* HEADER */
.header{background:var(--az);color:#fff;padding:16px 28px;display:flex;align-items:center;gap:14px;position:relative;overflow:hidden}
.header::after{content:'';position:absolute;right:-40px;top:-40px;width:200px;height:200px;background:rgba(255,255,255,.04);border-radius:50%}
.h-seal{width:50px;height:50px;background:var(--am);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;box-shadow:0 0 0 4px rgba(255,255,255,.18);z-index:1;position:relative}
.h-copy{z-index:1}
.h-copy h1{font-family:var(--serif);font-size:clamp(15px,2vw,22px);font-weight:900;line-height:1}
.h-copy h1 span{color:var(--am)}
.h-copy p{font-size:11px;opacity:.6;margin-top:2px;font-weight:300}
.flag-mini{margin-left:auto;width:40px;height:26px;border-radius:3px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 2px 8px rgba(0,0,0,.3);flex-shrink:0;z-index:1;position:relative}
.flag-mini div:nth-child(1){flex:2;background:var(--am)}
.flag-mini div:nth-child(2){flex:1;background:var(--az)}
.flag-mini div:nth-child(3){flex:1;background:var(--ro)}

/* AUTH BAR */
.auth-bar{background:var(--card);border-bottom:1px solid var(--bd);padding:10px 28px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.auth-avatar{width:32px;height:32px;border-radius:50%;border:2px solid var(--vd)}
.auth-name{font-size:12px;font-weight:600;color:var(--txt)}
.auth-email{font-size:10px;color:var(--txt2)}
.btn-auth{display:flex;align-items:center;gap:7px;padding:8px 16px;border-radius:var(--r);font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;border:none;transition:all .2s}
.btn-signin{background:#fff;color:var(--txt);border:1.5px solid var(--bd);box-shadow:0 1px 4px rgba(0,0,0,.08)}
.btn-signin:hover{border-color:var(--az);box-shadow:0 2px 8px rgba(0,56,147,.15)}
.btn-signout{background:var(--ro-l);color:var(--ro);border:1.5px solid #fca5a5;font-size:11px;padding:5px 12px}
.auth-status{font-size:11px;padding:4px 10px;border-radius:20px;font-weight:600}
.auth-status.ok{background:var(--vd-l);color:var(--vd)}
.auth-status.warn{background:var(--na-l);color:var(--na)}
.auth-status.err{background:var(--ro-l);color:var(--ro)}
.drive-info{font-size:10px;color:var(--txt2);display:flex;align-items:center;gap:4px}

/* MAIN */
.main{max-width:1300px;margin:0 auto;padding:24px 20px 72px}

/* LOGIN SCREEN */
.login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center;gap:20px}
.login-card{background:var(--card);border-radius:16px;padding:40px 36px;max-width:420px;width:100%;box-shadow:var(--sh2)}
.login-flag{display:flex;gap:0;border-radius:8px;overflow:hidden;width:80px;height:50px;margin:0 auto 20px;box-shadow:var(--sh)}
.login-flag div:nth-child(1){flex:2;background:var(--am)}
.login-flag div:nth-child(2){flex:1;background:var(--az)}
.login-flag div:nth-child(3){flex:1;background:var(--ro)}
.login-title{font-family:var(--serif);font-size:26px;font-weight:900;color:var(--az);margin-bottom:4px}
.login-sub{font-size:12px;color:var(--txt2);margin-bottom:28px;line-height:1.6}
.btn-google{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:13px;border-radius:var(--r);border:1.5px solid var(--bd);background:#fff;font-family:var(--font);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--txt);box-shadow:0 1px 4px rgba(0,0,0,.08)}
.btn-google:hover{border-color:var(--az);box-shadow:0 4px 16px rgba(0,56,147,.15);transform:translateY(-1px)}
.btn-google svg{flex-shrink:0}
.login-note{font-size:10px;color:var(--txt3);margin-top:14px;line-height:1.6}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.tbtn{display:flex;align-items:center;gap:5px;padding:7px 13px;border-radius:var(--r2);font-family:var(--font);font-size:11px;font-weight:600;cursor:pointer;border:1.5px solid var(--bd);background:var(--card);color:var(--txt2);transition:all .18s}
.tbtn:hover{border-color:var(--az);color:var(--az);background:var(--az-l)}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--bd2);display:inline-block;flex-shrink:0}
.sync-dot.syncing{background:var(--am);animation:pulse .8s infinite}
.sync-dot.synced{background:var(--vd)}
.sync-dot.error{background:var(--ro)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* TODAY BANNER */
.today-banner{display:none;align-items:center;gap:14px;background:var(--az);color:#fff;border-radius:var(--r);padding:14px 20px;margin-bottom:16px;animation:slideDown .3s ease}
@keyframes slideDown{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.tb-btn{margin-left:auto;background:var(--am);color:var(--az);border:none;border-radius:var(--r2);padding:7px 14px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0}
.tb-btn:hover{background:#ffe066}

/* UPLOAD / MONTH PANEL */
.upload{background:var(--card);border-radius:var(--r);border:2px dashed var(--bd);padding:24px;margin-bottom:18px;box-shadow:var(--sh)}
.upload-h{font-family:var(--serif);font-size:17px;color:var(--az);margin-bottom:3px}
.upload-s{font-size:11px;color:var(--txt2);margin-bottom:18px}
.sync-msg{font-size:11px;font-weight:600;padding:5px 12px;border-radius:6px;margin-bottom:12px;display:none}
.sync-msg.ok{background:var(--vd-l);color:var(--vd)}
.sync-msg.warn{background:var(--na-l);color:var(--na)}

/* MONTHS GRID */
.months-section{background:var(--card);border-radius:var(--r);padding:20px;margin-bottom:18px;box-shadow:var(--sh)}
.ms-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px}
.ms-title{font-family:var(--serif);font-size:15px;color:var(--az);font-weight:700}
.months-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px}
.month-chip{border:1.5px solid var(--bd);border-radius:var(--r2);padding:10px 12px;cursor:pointer;transition:all .18s;background:var(--bg);position:relative}
.month-chip:hover{border-color:var(--az);background:var(--az-l)}
.month-chip.selected{border-color:var(--az);background:var(--az-l)}
.month-chip.loaded{border-color:var(--vd);background:var(--vd-l)}
.month-chip.loaded.selected{border-color:var(--az);background:var(--az-l)}
.mc-year{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.4px}
.mc-month{font-size:13px;font-weight:700;color:var(--txt)}
.mc-count{font-size:10px;color:var(--txt2);margin-top:2px}
.mc-badge{position:absolute;top:6px;right:6px;width:8px;height:8px;border-radius:50%;background:var(--vd)}
.month-chip:not(.loaded) .mc-badge{display:none}
.mc-sel-badge{position:absolute;top:6px;right:6px;width:16px;height:16px;border-radius:50%;background:var(--az);display:none;align-items:center;justify-content:center;font-size:9px;color:#fff;font-weight:700}
.month-chip.selected .mc-sel-badge{display:flex}
.month-chip.selected .mc-badge{display:none}
.no-months{text-align:center;padding:24px;color:var(--txt2);font-size:12px;grid-column:1/-1}

/* YEAR SLOTS (upload) */
.yg{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px;margin-bottom:16px}
.yc{border:2px solid var(--bd);border-radius:var(--r);padding:13px;background:var(--bg);transition:all .2s}
.yc.loaded{border-color:var(--vd);background:var(--vd-l)}
.yc-head{display:flex;align-items:center;gap:6px;margin-bottom:9px}
.yb{background:var(--az);color:#fff;border-radius:20px;padding:2px 10px;font-size:11px;font-weight:700}
.yc.loaded .yb{background:var(--vd)}
.yi{font-size:11px;border:1.5px solid var(--bd);border-radius:6px;padding:2px 6px;font-family:var(--font);width:64px;outline:none}
.yr-btn{margin-left:auto;cursor:pointer;color:var(--ro);font-size:12px;opacity:.5;border:none;background:none}
.yr-btn:hover{opacity:1}
.fd{border:1.5px dashed var(--bd);border-radius:var(--r2);padding:10px;text-align:center;font-size:11px;color:var(--txt2);cursor:pointer;background:#fff;transition:all .18s;display:block}
.fd:hover{border-color:var(--az);color:var(--az);background:var(--az-l)}
.fd input{display:none}
.fst{margin-top:6px;font-size:10px;font-weight:600;color:var(--vd);display:none}
.yc.loaded .fst{display:block}
.mp{margin-top:8px;display:none}
.yc.loaded .mp{display:block}
.mlbl{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.mcs{display:flex;flex-wrap:wrap;gap:3px}
.chip{padding:2px 8px;border-radius:20px;font-size:10px;font-weight:600;cursor:pointer;border:1.5px solid var(--bd);background:#fff;color:var(--txt2);transition:all .14s;user-select:none}
.chip:hover{border-color:var(--az);color:var(--az)}
.chip.on{background:var(--az);color:#fff;border-color:var(--az)}
.macts{display:flex;gap:5px;margin-top:4px}
.mact{font-size:9px;font-weight:600;cursor:pointer;background:none;border:none;color:var(--txt2);text-decoration:underline;padding:0}
.mact:hover{color:var(--az)}
.add-slot{border:2px dashed var(--am);border-radius:var(--r);padding:13px;background:var(--am-l);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;font-size:12px;font-weight:700;color:#7a5200;transition:all .18s}
.add-slot:hover{background:var(--am)}

/* ANALYZE BTN */
.btn-analyze{background:var(--az);color:#fff;border:none;border-radius:var(--r);padding:11px 26px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all .2s;box-shadow:0 3px 12px rgba(0,56,147,.22)}
.btn-analyze:hover:not(:disabled){background:#0044b3;transform:translateY(-1px)}
.btn-analyze:disabled{background:var(--bd2);color:var(--txt3);box-shadow:none;cursor:not-allowed}
.loading-row{display:none;align-items:center;gap:10px}
.prog{flex:1;height:4px;background:var(--bd);border-radius:2px;overflow:hidden;min-width:80px}
.prog-fill{height:100%;background:var(--am);border-radius:2px;animation:prog 1.3s ease infinite;width:35%}
@keyframes prog{0%{margin-left:0;width:30%}50%{margin-left:30%;width:40%}100%{margin-left:65%;width:30%}}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.kpi{background:var(--card);border-radius:var(--r);padding:14px;box-shadow:var(--sh);position:relative;overflow:hidden;animation:fadeUp .4s ease both}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--az)}
.kpi:nth-child(2)::before{background:var(--vd)}
.kpi:nth-child(3)::before{background:var(--ro)}
.kpi:nth-child(4)::before{background:var(--am)}
.kpi:nth-child(5)::before{background:var(--na)}
.kpi-lbl{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.kpi-val{font-family:var(--serif);font-size:26px;font-weight:900;line-height:1;color:var(--az)}
.kpi:nth-child(2) .kpi-val{color:var(--vd)}
.kpi:nth-child(3) .kpi-val{color:var(--ro)}
.kpi:nth-child(4) .kpi-val{color:#7a5200}
.kpi:nth-child(5) .kpi-val{color:var(--na)}
.kpi-sub{font-size:10px;color:var(--txt3);margin-top:2px}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* CTX BAR */
.ctx-bar{background:var(--az-l);border:1px solid rgba(0,56,147,.15);border-radius:var(--r2);padding:7px 13px;margin-bottom:12px;font-size:11px;color:var(--az);display:flex;align-items:center;gap:7px;flex-wrap:wrap}

/* TABS */
.tabs{display:flex;gap:2px;background:var(--card);border-radius:var(--r) var(--r) 0 0;padding:7px 7px 0;border-bottom:2px solid var(--az);flex-wrap:wrap}
.tab{padding:7px 14px;border:none;border-radius:6px 6px 0 0;background:transparent;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:500;color:var(--txt2);transition:all .14s;display:flex;align-items:center;gap:4px;white-space:nowrap}
.tab:hover{background:var(--az-l);color:var(--az)}
.tab.on{background:var(--az);color:#fff;font-weight:700}
.tab.urgent.on{background:var(--ro);color:#fff}
.tab.urgent{color:var(--ro)}
.tab-n{background:rgba(255,255,255,.22);border-radius:20px;padding:1px 6px;font-size:10px;font-weight:700}
.tab:not(.on) .tab-n{background:var(--bd);color:var(--txt2)}
.panel{background:var(--card);border-radius:0 0 var(--r) var(--r);box-shadow:var(--sh);overflow:hidden;min-height:180px}

/* FILTER BAR */
.fbar{display:flex;align-items:center;gap:7px;padding:11px 16px;background:var(--bg);border-bottom:1px solid var(--bd);flex-wrap:wrap}
.fbar-lbl{font-size:10px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.3px}
.fbar input,.fbar select{border:1.5px solid var(--bd);border-radius:var(--r2);padding:5px 9px;font-family:var(--font);font-size:11px;background:#fff;color:var(--txt);outline:none;transition:border-color .18s}
.fbar input{width:160px}
.fbar input:focus,.fbar select:focus{border-color:var(--az)}
.fbar-cnt{font-size:11px;font-weight:600;color:var(--txt2);white-space:nowrap}
.btn-csv{background:var(--vd);color:#fff;border:none;border-radius:var(--r2);padding:5px 11px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;margin-left:auto;transition:all .18s}
.btn-csv:hover{background:#145c34}

/* TABLE */
.tbl-wrap{overflow:auto;max-height:520px}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:var(--az);color:#fff;padding:9px 13px;text-align:left;font-weight:600;font-size:11px;white-space:nowrap;position:sticky;top:0;z-index:2;letter-spacing:.2px}
tbody tr{border-bottom:1px solid var(--bd);transition:background .1s}
tbody tr:hover{background:var(--az-l)}
tbody td{padding:10px 13px;white-space:nowrap;max-width:190px;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
.td-placa{font-weight:700;color:var(--az);font-size:13px;letter-spacing:.5px}
.td-nombre{font-weight:500}
.td-tel{font-family:monospace;font-size:13px;font-weight:700;color:var(--vd)}

/* PILLS */
.pill{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
.p-az{background:var(--az-l);color:var(--az)}
.p-vd{background:var(--vd-l);color:var(--vd)}
.p-ro{background:var(--ro-l);color:var(--ro)}
.p-am{background:var(--am-l);color:#7a5200}
.p-na{background:var(--na-l);color:var(--na)}
.p-mo{background:var(--mo-l);color:var(--mo)}

/* VENCIMIENTO */
.venc{display:inline-flex;flex-direction:column;gap:1px}
.venc-fecha{font-size:11px;font-weight:600}
.venc-dias{font-size:10px;font-weight:700;border-radius:20px;padding:1px 7px;display:inline-block;margin-top:2px}
.v-vencido{background:var(--ro-l);color:var(--ro)}
.v-urgente{background:var(--ro-l);color:var(--ro)}
.v-pronto{background:var(--na-l);color:var(--na)}
.v-ok{background:var(--vd-l);color:var(--vd)}
.venc-edit-wrap{display:flex;flex-direction:column;gap:2px}
.venc-manual-badge{background:var(--mo-l);color:var(--mo);border:1.5px dashed var(--mo);border-radius:6px;padding:1px 6px;font-size:9px;font-weight:700;display:inline-block}
.btn-edit-venc{background:none;border:none;font-size:10px;color:var(--txt3);cursor:pointer;text-decoration:underline;padding:0;font-family:var(--font)}
.btn-edit-venc:hover{color:var(--mo)}
.venc-override-row{display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap}
.venc-override-row input{border:1.5px solid var(--mo);border-radius:6px;padding:4px 8px;font-family:var(--font);font-size:11px;outline:none;background:var(--mo-l)}
.venc-override-row button{padding:4px 10px;border-radius:6px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;border:none}
.btn-save-venc{background:var(--mo);color:#fff}

/* CALL BTNS */
.call-row{display:flex;align-items:center;gap:5px}
.btn-call{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;text-decoration:none;border:none;cursor:pointer;font-family:var(--font);transition:all .14s;white-space:nowrap}
.btn-tel{background:var(--vd-l);color:var(--vd);border:1px solid #86efac}
.btn-tel:hover{background:var(--vd);color:#fff}
.btn-wa{background:#e7fce8;color:#128c7e;border:1px solid #86efac}
.btn-wa:hover{background:#25d366;color:#fff}

/* GESTIÃ“N BADGE */
.gb{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;cursor:pointer;transition:all .16s;border:1.5px solid transparent}
.gb-pte{background:#f4f4f5;color:var(--txt2);border-color:var(--bd)}
.gb-pte:hover{border-color:var(--az);color:var(--az)}
.gb-gest{background:var(--am-l);color:#7a5200;border-color:var(--am)}
.gb-cont{background:var(--vd-l);color:var(--vd);border-color:#86efac}
.gb-agend{background:var(--az-l);color:var(--az);border-color:#93c5fd}
.gb-noint{background:var(--ro-l);color:var(--ro);border-color:#fca5a5}

/* CHECKS */
.chk{color:var(--vd);font-size:14px;font-weight:900}
.dash{color:var(--bd2);font-size:12px}

/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:var(--txt2)}
.empty-ico{font-size:44px;margin-bottom:8px}
.empty h3{font-family:var(--serif);color:var(--az);font-size:17px;margin-bottom:4px}
.empty p{font-size:12px}

/* CHARTS */
.charts{padding:20px;display:flex;flex-direction:column;gap:16px}
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:640px){.chart-grid{grid-template-columns:1fr}}
.cc{background:var(--bg);border-radius:var(--r);padding:14px}
.cc h3{font-family:var(--serif);font-size:13px;color:var(--az);margin-bottom:10px;font-weight:700}
.bar-row{display:flex;align-items:center;gap:7px;margin-bottom:6px;font-size:11px}
.bar-lbl{width:100px;flex-shrink:0;color:var(--txt2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-trk{flex:1;background:var(--bd);border-radius:20px;height:9px;overflow:hidden}
.bar-fill{height:100%;border-radius:20px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.bar-cnt{width:28px;text-align:right;font-weight:700;color:var(--txt)}
.stat-alerts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.alert-card{border-radius:var(--r);padding:14px;text-align:center}
.alert-card.vencidos{background:var(--ro-l);border:1.5px solid #fca5a5}
.alert-card.proximos{background:var(--na-l);border:1.5px solid #fbbf24}
.alert-card .ac-num{font-family:var(--serif);font-size:34px;font-weight:900}
.alert-card.vencidos .ac-num{color:var(--ro)}
.alert-card.proximos .ac-num{color:var(--na)}
.alert-card .ac-lbl{font-size:11px;font-weight:600}
.alert-card.vencidos .ac-lbl{color:var(--ro)}
.alert-card.proximos .ac-lbl{color:var(--na)}
.yr-stat{background:var(--card);border-radius:var(--r);padding:16px;box-shadow:var(--sh);border-top:3px solid var(--az)}

/* HOY */
.hoy-section{padding:18px}
.hoy-head{font-family:var(--serif);font-size:14px;color:var(--az);margin-bottom:12px;font-weight:700}
.hoy-block{border-radius:var(--r);padding:13px;margin-bottom:14px;border:1.5px solid}
.hoy-block.seguimientos{background:var(--vd-l);border-color:#86efac}
.hoy-block.vencen{background:var(--na-l);border-color:#fbbf24}
.hoy-block.empty-block{background:var(--bg);border-color:var(--bd);text-align:center;color:var(--txt2);font-size:12px;padding:16px}
.hoy-block-title{font-size:12px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:5px}
.hoy-block.seguimientos .hoy-block-title{color:var(--vd)}
.hoy-block.vencen .hoy-block-title{color:var(--na)}

/* MODAL */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.42);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.modal-bg.show{display:flex}
.modal{background:var(--card);border-radius:16px;padding:22px;max-width:520px;width:94vw;max-height:90vh;overflow-y:auto;position:relative;box-shadow:var(--sh2);animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(6px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal h3{font-family:var(--serif);font-size:17px;color:var(--az);margin-bottom:10px;font-weight:900;padding-right:22px}
.mcl{position:absolute;top:14px;right:14px;background:none;border:none;font-size:17px;cursor:pointer;color:var(--txt2);transition:color .14s}
.mcl:hover{color:var(--ro)}
.contact-cards{display:flex;gap:9px;margin-bottom:12px;flex-wrap:wrap}
.contact-card{flex:1;min-width:145px;border-radius:var(--r);padding:12px;text-align:center}
.cc-tel{background:var(--vd-l);border:1.5px solid #86efac}
.cc-wa{background:#e7fce8;border:1.5px solid #a7f3d0}
.cc-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px}
.cc-tel .cc-lbl{color:var(--vd)}
.cc-wa .cc-lbl{color:#128c7e}
.cc-num{font-family:monospace;font-size:18px;font-weight:700;letter-spacing:.5px;margin-bottom:7px}
.cc-tel .cc-num{color:var(--vd)}
.cc-wa .cc-num{color:#128c7e}
.venc-info{background:var(--am-l);border:1.5px solid var(--am);border-radius:var(--r2);padding:8px 12px;font-size:11px;margin-bottom:12px;display:flex;align-items:flex-start;gap:7px}
.fr{display:flex;flex-direction:column;gap:3px;margin-bottom:9px}
.fr label{font-size:10px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.3px}
.fr input,.fr select,.fr textarea{border:1.5px solid var(--bd);border-radius:var(--r2);padding:7px 9px;font-family:var(--font);font-size:12px;color:var(--txt);outline:none;transition:border-color .18s;background:#fff}
.fr input:focus,.fr select:focus,.fr textarea:focus{border-color:var(--az)}
.fr textarea{resize:vertical;min-height:60px}
.f2col{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.btn-save{background:var(--az);color:#fff;border:none;border-radius:var(--r);padding:10px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;width:100%;margin-top:4px;transition:all .18s}
.btn-save:hover{background:#0044b3}
.hist-wrap{border-top:1px solid var(--bd);margin-top:12px;padding-top:10px}
.hist-wrap h4{font-size:11px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.4px;margin-bottom:7px}
.hi{background:var(--bg);border-radius:var(--r2);padding:8px 11px;margin-bottom:5px;border-left:3px solid var(--az)}
.hi.llamada{border-left-color:var(--vd)}
.hi.whatsapp{border-left-color:#25d366}
.hi.sms{border-left-color:var(--na)}
.hi.visita{border-left-color:var(--mo)}
.hi-head{display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-bottom:2px}
.hi-tipo{font-size:10px;font-weight:700;text-transform:uppercase}
.hi-res{font-size:9px;font-weight:700;padding:1px 6px;border-radius:20px}
.hi-res.ok{background:var(--vd-l);color:var(--vd)}
.hi-res.bad{background:var(--ro-l);color:var(--ro)}
.hi-res.neutral{background:var(--bg);color:var(--txt2);border:1px solid var(--bd)}
.hi-fecha{font-size:9px;color:var(--txt3);margin-left:auto}
.hi-prox{font-size:9px;color:var(--na);font-weight:600}
.hi-nota{font-size:11px;color:var(--txt);margin-top:2px;line-height:1.4}
.hi-del{background:none;border:none;cursor:pointer;color:var(--txt3);font-size:11px;padding:0 2px;transition:color .14s}
.hi-del:hover{color:var(--ro)}

/* SETUP MODAL */
.setup-modal{max-width:580px}
.setup-steps{display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap}
.setup-step{padding:5px 11px;border:1.5px solid var(--bd);border-radius:20px;font-family:var(--font);font-size:11px;font-weight:600;cursor:pointer;background:#fff;color:var(--txt2);transition:all .16s}
.setup-step:hover{border-color:var(--az);color:var(--az)}
.setup-step.on{background:var(--az);color:#fff;border-color:var(--az)}
.info-box{background:var(--az-l);border-radius:var(--r2);padding:11px 13px;margin-bottom:12px;font-size:11px;color:var(--az);line-height:1.7}
.info-box a{color:var(--az);font-weight:700}
.info-box code{background:rgba(0,56,147,.12);padding:1px 5px;border-radius:4px;font-size:10px}
.code-block{background:#1e1e2e;border-radius:8px;padding:12px;margin-bottom:10px;position:relative}
.code-block pre{color:#cdd6f4;font-family:monospace;font-size:10px;white-space:pre-wrap;margin:0;line-height:1.6}
.btn-copy-code{position:absolute;top:7px;right:7px;background:var(--az);color:#fff;border:none;border-radius:5px;padding:3px 9px;font-size:10px;font-weight:700;cursor:pointer}
.btn-secondary{width:100%;margin-top:7px;background:var(--ro-l);color:var(--ro);border:1.5px solid #fca5a5;border-radius:var(--r);padding:8px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer}
.btn-secondary:hover{background:var(--ro);color:#fff}
.btn-ghost{background:var(--bg);color:var(--txt2);border:1.5px solid var(--bd);border-radius:var(--r);padding:8px;font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:all .16s}
.btn-ghost:hover{border-color:var(--az);color:var(--az)}
.tpl-vars{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:12px}
.tpl-var{background:var(--bg);border:1px solid var(--bd);border-radius:4px;padding:2px 6px;font-size:10px;font-family:monospace;color:var(--txt2)}

/* NOTIF */
.notif{position:fixed;bottom:16px;right:16px;background:var(--az);color:#fff;padding:9px 15px;border-radius:var(--r);font-size:12px;font-weight:500;box-shadow:var(--sh2);transform:translateY(80px);transition:transform .3s cubic-bezier(.4,0,.2,1);z-index:200;max-width:280px;line-height:1.4}
.notif.show{transform:translateY(0)}
.notif.ok{background:var(--vd)}
.notif.err{background:var(--ro)}

footer{text-align:center;padding:12px;font-size:10px;color:var(--txt3)}
footer em{color:var(--az);font-style:normal;font-weight:600}
@media(max-width:540px){
  .header{padding:10px 14px}
  .main{padding:12px 10px 40px}
  .stat-alerts{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="flag-stripe"></div>
<header class="header">
  <div class="h-seal">ğŸš—</div>
  <div class="h-copy">
    <h1>CDA <span>Colombia</span></h1>
    <p>GestiÃ³n Comercial Â· RevisiÃ³n TÃ©cnico-MecÃ¡nica</p>
  </div>
  <div class="flag-mini"><div></div><div></div><div></div></div>
</header>

<!-- AUTH BAR -->
<div class="auth-bar" id="authBar">
  <button class="btn-auth btn-signin" id="btnSignIn" onclick="signIn()" style="display:none">
    <svg width="16" height="16" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.293C4.672 5.166 6.656 3.58 9 3.58z"/></svg>
    Iniciar sesiÃ³n con Google
  </button>
  <img class="auth-avatar" id="authAvatar" style="display:none" src="" alt="">
  <div id="authInfo" style="display:none">
    <div class="auth-name" id="authName"></div>
    <div class="auth-email" id="authEmail"></div>
  </div>
  <div class="drive-info" id="driveInfo" style="display:none">
    <span>ğŸ“</span><span id="driveFolderName">CDA GestiÃ³n Comercial</span>
  </div>
  <div class="auth-status" id="authStatus"></div>
  <button class="btn-auth btn-signout" id="btnSignOut" onclick="signOut()" style="display:none">Cerrar sesiÃ³n</button>
  <button class="tbtn" id="btnSetup" onclick="openSetup()" style="margin-left:auto;display:none">âš™ï¸ Configurar</button>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="main">
  <div class="login-screen">
    <div class="login-card">
      <div class="login-flag"><div></div><div></div><div></div></div>
      <div class="login-title">CDA Colombia</div>
      <div class="login-sub">GestiÃ³n Comercial de Revisiones<br>TÃ©cnico-MecÃ¡nicas Â· RTM</div>
      <button class="btn-google" onclick="signIn()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.293C4.672 5.166 6.656 3.58 9 3.58z"/></svg>
        Continuar con Google
      </button>
      <div class="login-note">
        La app solicita acceso a Google Drive para guardar<br>
        los datos de gestiÃ³n de forma segura y privada.<br><br>
        <strong>Primera vez:</strong> Si aparece "app no verificada",<br>
        haz clic en <em>Avanzado â†’ Ir a la app</em>.
      </div>
    </div>
  </div>
</div>

<!-- APP (visible after login) -->
<div id="appScreen" class="main" style="display:none">

  <!-- TODAY BANNER -->
  <div class="today-banner" id="todayBanner">
    <div style="font-size:26px">ğŸ“…</div>
    <div style="flex:1">
      <strong id="tbTitle"></strong>
      <div style="font-size:11px;opacity:.75;margin-top:1px" id="tbSub"></div>
    </div>
    <button class="tb-btn" onclick="showTab('hoy')">Ver lista â†’</button>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <button class="tbtn" onclick="openTemplatesModal()">âœï¸ Plantillas</button>
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px">
      <span class="sync-dot" id="syncDot"></span>
      <span style="font-size:11px;color:var(--txt2)" id="syncLabel">Listo</span>
    </div>
  </div>

  <!-- MONTHS PANEL -->
  <div class="months-section" id="monthsSection">
    <div class="ms-head">
      <div class="ms-title">ğŸ“… PerÃ­odos disponibles en Drive</div>
      <button class="tbtn" onclick="refreshMonthsList()" id="btnRefreshMonths">ğŸ”„ Actualizar</button>
    </div>
    <div class="months-grid" id="monthsGrid">
      <div class="no-months">Cargando perÃ­odos desde Driveâ€¦</div>
    </div>
    <div style="margin-top:12px;font-size:11px;color:var(--txt2)">
      ğŸ’¡ Selecciona uno o varios meses para analizar Â· Haz clic en un mes para seleccionarlo/deseleccionarlo
    </div>
  </div>

  <!-- UPLOAD NEW MONTH -->
  <div class="upload">
    <h2 class="upload-h">ğŸ“‚ Cargar nuevo perÃ­odo</h2>
    <p class="upload-s">Sube los Excel de cada aÃ±o. Solo vehÃ­culos <strong>APROBADOS</strong> Â· Vencimiento = Fecha Final + 1 aÃ±o Â· Se guarda automÃ¡ticamente en Drive</p>
    <div id="syncMsg" class="sync-msg"></div>
    <div class="yg" id="yg"></div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <button class="btn-analyze" id="btnRun" onclick="runAnalysis()" disabled>ğŸ” Analizar perÃ­odos seleccionados</button>
      <div class="loading-row" id="loadingRow">
        <span style="font-size:11px;color:var(--txt2)">Procesandoâ€¦</span>
        <div class="prog"><div class="prog-fill"></div></div>
      </div>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results" style="display:none">
    <div class="kpi-row" id="kpiRow"></div>
    <div class="ctx-bar" id="ctxBar"></div>
    <div class="tabs" id="tabsRow"></div>
    <div class="panel" id="mainPanel">
      <div class="empty"><div class="empty-ico">ğŸ“Š</div><h3>Selecciona una pestaÃ±a</h3></div>
    </div>
  </div>
</div><!-- /appScreen -->

<!-- MODAL GESTIÃ“N -->
<div class="modal-bg" id="modalBg" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="mcl" onclick="closeModal()">âœ•</button>
    <h3 id="mTitle"></h3>
    <div id="mContact"></div>
    <div id="mVenc"></div>
    <div id="mForm"></div>
    <div id="mHist"></div>
  </div>
</div>

<!-- MODAL SETUP -->
<div class="modal-bg" id="setupBg" onclick="if(event.target===this)closeSetup()">
  <div class="modal setup-modal">
    <button class="mcl" onclick="closeSetup()">âœ•</button>
    <h3>âš™ï¸ ConfiguraciÃ³n</h3>
    <div class="setup-steps">
      <button class="setup-step on" id="ss1" onclick="showSetupStep(1)">1 Â· Client ID</button>
      <button class="setup-step" id="ss2" onclick="showSetupStep(2)">2 Â· Publicar app</button>
      <button class="setup-step" id="ss3" onclick="showSetupStep(3)">3 Â· Estado</button>
    </div>
    <div id="sp1">
      <div class="info-box">
        <strong>Obtener Google OAuth Client ID:</strong><br><br>
        1. Ve a <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a><br>
        2. Crea un proyecto nuevo â†’ nombre: <code>CDA Colombia</code><br>
        3. Ve a <strong>APIs y servicios â†’ Biblioteca</strong><br>
        4. Activa: <strong>Google Drive API</strong> y <strong>Google Sheets API</strong><br>
        5. Ve a <strong>APIs y servicios â†’ Credenciales</strong><br>
        6. Clic en <strong>Crear credencial â†’ ID de cliente OAuth</strong><br>
        7. Tipo de aplicaciÃ³n: <strong>AplicaciÃ³n web</strong><br>
        8. OrÃ­genes autorizados: agrega la URL de tu GitHub Pages<br>
        &nbsp;&nbsp;&nbsp;<code>https://TU_USUARIO.github.io</code><br>
        9. Copia el <strong>ID de cliente</strong> (termina en <code>.apps.googleusercontent.com</code>)
      </div>
      <div class="fr">
        <label>Client ID de OAuth</label>
        <input id="cfg_clientId" type="text" placeholder="12345-abc.apps.googleusercontent.com">
      </div>
      <button class="btn-save" onclick="saveClientId()">Guardar Client ID</button>
    </div>
    <div id="sp2" style="display:none">
      <div class="info-box">
        <strong>Publicar en GitHub Pages:</strong><br><br>
        1. Ve a <a href="https://github.com" target="_blank">github.com</a> â†’ crea cuenta si no tienes<br>
        2. Clic en <strong>New repository</strong><br>
        3. Nombre: <code>cda-gestion</code> Â· Visibilidad: <strong>Public</strong><br>
        4. Clic en <strong>Add file â†’ Upload files</strong><br>
        5. Sube este archivo HTML (renÃ³mbralo a <code>index.html</code>)<br>
        6. Ve a <strong>Settings â†’ Pages</strong><br>
        7. Source: <strong>Deploy from branch â†’ main â†’ / (root)</strong><br>
        8. En unos minutos tu app estarÃ¡ en:<br>
        &nbsp;&nbsp;&nbsp;<code>https://TU_USUARIO.github.io/cda-gestion</code><br><br>
        <strong>Cuando actualices la app:</strong> solo sube el nuevo HTML y GitHub Pages lo publica automÃ¡ticamente.
      </div>
      <button class="btn-save" onclick="showSetupStep(3)">Siguiente â†’</button>
    </div>
    <div id="sp3" style="display:none">
      <div id="setupStatus" class="info-box">Verificando configuraciÃ³nâ€¦</div>
      <button class="btn-save" onclick="testSetup()">ğŸ”Œ Probar conexiÃ³n</button>
      <button class="btn-secondary" onclick="resetConfig()">Reiniciar configuraciÃ³n</button>
    </div>
  </div>
</div>

<!-- MODAL PLANTILLAS -->
<div class="modal-bg" id="tplBg" onclick="if(event.target===this)closeTemplatesModal()">
  <div class="modal" style="max-width:520px">
    <button class="mcl" onclick="closeTemplatesModal()">âœ•</button>
    <h3>âœï¸ Plantillas de mensaje</h3>
    <div class="tpl-vars">
      <span class="tpl-var">{nombre}</span><span class="tpl-var">{placa}</span>
      <span class="tpl-var">{marca}</span><span class="tpl-var">{linea}</span>
      <span class="tpl-var">{vencimiento}</span><span class="tpl-var">{clase}</span>
    </div>
    <div class="fr"><label>ğŸ’¬ WhatsApp</label><textarea id="tpl_wa" style="min-height:76px"></textarea></div>
    <div class="fr"><label>ğŸ“± SMS corto</label><textarea id="tpl_sms" style="min-height:48px"></textarea></div>
    <div class="fr"><label>ğŸ“… Recordatorio de cita</label><textarea id="tpl_rec" style="min-height:48px"></textarea></div>
    <div style="display:flex;gap:7px">
      <button class="btn-save" style="flex:1" onclick="saveTemplates()">ğŸ’¾ Guardar</button>
      <button class="btn-ghost" onclick="resetTemplates()">â†º Restaurar</button>
    </div>
  </div>
</div>

<footer><em>CDA Colombia</em> Â· Datos privados en Google Drive Â· v8</footer>
<div class="notif" id="notif"></div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” REEMPLAZA CON TU CLIENT ID DESPUÃ‰S DE SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP_CONFIG = {
  // Este valor se sobrescribe con el que guardes en el setup
  clientId: localStorage.getItem('cda_clientId') || 'REEMPLAZAR_CON_TU_CLIENT_ID',
  scopes: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets',
  folderName: 'CDA GestiÃ³n Comercial',
  gestionFileName: 'GestiÃ³n_Comercial.json',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MO=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const C6=['#003893','#1a6b3c','#CE1126','#c05e00','#5b21b6','#0891b2'];
const CB=['#FCD116','#003893','#CE1126','#1a6b3c','#c05e00','#5b21b6'];
const DIAS_LLAMAR = 8;
const ESTADOS=[
  {v:'pendiente',  l:'Pendiente',  cls:'gb-pte', i:'â³'},
  {v:'en-gestion', l:'En gestiÃ³n', cls:'gb-gest',i:'ğŸ“'},
  {v:'contactado', l:'Contactado', cls:'gb-cont',i:'âœ…'},
  {v:'agendado',   l:'Agendado',   cls:'gb-agend',i:'ğŸ“…'},
  {v:'no-interesa',l:'No interesa',cls:'gb-noint',i:'ğŸš«'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  accessToken: null,
  user: null,
  folderId: null,
  gestionFileId: null,
  // loaded periods: { "2025_Enero": { label, rows[], deduped[] }, ... }
  periods: {},
  // selected period keys for analysis
  selectedPeriods: new Set(),
  analysis: null,
  modalPlaca: null,
  activeTab: null,
  years: [],   // local upload slots
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTIÃ“N (local + Drive)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let GESTION = {};
try { GESTION = JSON.parse(localStorage.getItem('cda_gestion')||'{}'); } catch{}

async function persistGestion() {
  localStorage.setItem('cda_gestion', JSON.stringify(GESTION));
  await saveToDrive();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tokenClient = null;

function initGoogleAuth() {
  if(!window.google) { setTimeout(initGoogleAuth, 500); return; }
  const clientId = APP_CONFIG.clientId;
  if(clientId === 'REEMPLAZAR_CON_TU_CLIENT_ID') {
    showLoginScreen();
    setAuthStatus('âš ï¸ Configura tu Client ID primero','warn');
    document.getElementById('btnSetup').style.display='flex';
    document.getElementById('btnSignIn').style.display='none';
    // Show setup prompt instead of sign-in
    document.querySelector('.login-note').innerHTML = `
      <strong>âš™ï¸ Primer uso:</strong> necesitas configurar tu Client ID de Google OAuth.<br><br>
      Haz clic en <button onclick="openSetup()" style="background:var(--az);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer">âš™ï¸ Configurar</button> en la barra superior.`;
    return;
  }

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope: APP_CONFIG.scopes,
    callback: handleTokenResponse,
  });
  document.getElementById('btnSignIn').style.display='flex';
  // Always show login â€” user clicks to authenticate
  showLoginScreen();
}

function signIn() {
  if(!tokenClient) { toast('âš ï¸ Configura el Client ID primero','err'); openSetup(); return; }
  tokenClient.requestAccessToken({ prompt: '' });
}

function handleTokenResponse(resp) {
  if(resp.error) { toast('Error de autenticaciÃ³n: '+resp.error,'err'); return; }
  S.accessToken = resp.access_token;
  // Save token with expiry (1 hour)
  localStorage.setItem('cda_token', JSON.stringify({
    token: resp.access_token,
    expiry: Date.now() + (resp.expires_in||3600)*1000 - 60000,
  }));
  fetchUserInfo();
}

async function fetchUserInfo() {
  try {
    const res = await gFetch('https://www.googleapis.com/oauth2/v2/userinfo');
    S.user = res;
    showAppScreen();
    updateAuthBar();
    await initDrive();
  } catch(e) {
    // Login failed â€” clear any stale token and stay on login screen
    localStorage.removeItem('cda_token');
    S.accessToken = null;
    showLoginScreen();
    // Only show error if it's not an auth error (those are handled by showing login)
    if(!e.message?.includes('expirada') && !e.message?.includes('401')) {
      toast('Error al conectar: '+e.message,'err');
    }
  }
}

async function restoreUser() {
  try {
    const res = await gFetch('https://www.googleapis.com/oauth2/v2/userinfo');
    S.user = res;
    showAppScreen();
    updateAuthBar();
    await initDrive();
  } catch {
    // Token expired â€” silently clear and show login, no error toast
    localStorage.removeItem('cda_token');
    S.accessToken = null;
    showLoginScreen();
  }
}

function signOut() {
  S.accessToken = null; S.user = null; S.folderId = null;
  localStorage.removeItem('cda_token');
  if(window.google?.accounts?.oauth2) google.accounts.oauth2.revoke(S.accessToken||'');
  showLoginScreen();
  updateAuthBar();
  toast('SesiÃ³n cerrada');
}

function showLoginScreen() {
  document.getElementById('loginScreen').style.display='block';
  document.getElementById('appScreen').style.display='none';
}
function showAppScreen() {
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('appScreen').style.display='block';
}
function updateAuthBar() {
  const u = S.user;
  document.getElementById('btnSignIn').style.display = u ? 'none' : 'flex';
  document.getElementById('btnSignOut').style.display = u ? 'flex' : 'none';
  document.getElementById('authAvatar').style.display = u ? 'block' : 'none';
  document.getElementById('authInfo').style.display = u ? 'block' : 'none';
  document.getElementById('btnSetup').style.display = u ? 'flex' : 'none';
  if(u) {
    document.getElementById('authAvatar').src = u.picture||'';
    document.getElementById('authName').textContent = u.name||'';
    document.getElementById('authEmail').textContent = u.email||'';
  }
}
function setAuthStatus(msg, type) {
  const el = document.getElementById('authStatus');
  el.textContent = msg; el.className = 'auth-status '+(type||'');
  el.style.display = msg ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE API HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function gFetch(url, opts={}) {
  const res = await fetch(url, {
    ...opts,
    headers: {
      'Authorization': 'Bearer '+S.accessToken,
      'Content-Type': 'application/json',
      ...(opts.headers||{}),
    },
  });
  if(res.status === 401) {
    localStorage.removeItem('cda_token');
    S.accessToken = null;
    showLoginScreen();
    throw new Error('401');
  }
  if(!res.ok) {
    const err = await res.json().catch(()=>({}));
    throw new Error(err.error?.message || `HTTP ${res.status}`);
  }
  return res.json();
}

async function gFetchRaw(url, opts={}) {
  const res = await fetch(url, {
    ...opts,
    headers: { 'Authorization': 'Bearer '+S.accessToken, ...(opts.headers||{}) },
  });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRIVE FOLDER + FILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initDrive() {
  setSyncState('syncing','Conectando a Driveâ€¦');
  try {
    // Find or create folder
    const q = encodeURIComponent(`name='${APP_CONFIG.folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`);
    const res = await gFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)`);
    if(res.files?.length) {
      S.folderId = res.files[0].id;
    } else {
      // Create folder
      const f = await gFetch('https://www.googleapis.com/drive/v3/files', {
        method:'POST',
        body: JSON.stringify({ name: APP_CONFIG.folderName, mimeType: 'application/vnd.google-apps.folder' }),
      });
      S.folderId = f.id;
    }
    document.getElementById('driveInfo').style.display='flex';
    document.getElementById('driveFolderName').textContent = APP_CONFIG.folderName;

    // Load gestiÃ³n file
    await loadGestionFromDrive();
    setSyncState('synced','Sincronizado');
    setAuthStatus('âœ… Conectado a Drive','ok');

    // Load period list
    await refreshMonthsList();
    initSlots();
    checkBtn();
  } catch(e) {
    setSyncState('error','Error Drive');
    setAuthStatus('âš ï¸ '+e.message,'err');
    toast('Error de Drive: '+e.message,'err');
    initSlots(); // still allow local use
  }
}

// â”€â”€ Load gestiÃ³n JSON from Drive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGestionFromDrive() {
  if(!S.folderId) return;
  const q = encodeURIComponent(`name='${APP_CONFIG.gestionFileName}' and '${S.folderId}' in parents and trashed=false`);
  const res = await gFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime)`);
  if(!res.files?.length) return;
  S.gestionFileId = res.files[0].id;
  const fileRes = await gFetchRaw(`https://www.googleapis.com/drive/v3/files/${S.gestionFileId}?alt=media`);
  const text = await fileRes.text();
  const remote = JSON.parse(text);
  // Merge: remote wins over local for shared keys
  GESTION = { ...GESTION, ...remote };
  localStorage.setItem('cda_gestion', JSON.stringify(GESTION));
  showSyncMsg(`â˜ï¸ ${Object.keys(GESTION).length} gestiones cargadas desde Drive`,'ok');
}

// â”€â”€ Save gestiÃ³n to Drive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveToDrive() {
  if(!S.folderId) return;
  setSyncState('syncing','Guardandoâ€¦');
  try {
    const body = JSON.stringify(GESTION);
    if(S.gestionFileId) {
      // Update existing file
      await gFetchRaw(`https://www.googleapis.com/upload/drive/v3/files/${S.gestionFileId}?uploadType=media`, {
        method:'PATCH', headers:{'Content-Type':'application/json'}, body,
      });
    } else {
      // Create new file
      const meta = { name: APP_CONFIG.gestionFileName, parents: [S.folderId] };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(meta)],{type:'application/json'}));
      form.append('file', new Blob([body],{type:'application/json'}));
      const res = await gFetchRaw('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method:'POST', headers:{}, body: form,
      });
      const data = await res.json();
      S.gestionFileId = data.id;
    }
    setSyncState('synced','Guardado en Drive');
  } catch(e) {
    setSyncState('error','Error al guardar');
    showSyncMsg('âš ï¸ Error guardando: '+e.message,'warn');
  }
}

// â”€â”€ Save period Excel to Drive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function savePeriodToDrive(periodKey, rows) {
  if(!S.folderId) return;
  const fileName = `${periodKey}.json`;
  setSyncState('syncing',`Guardando ${periodKey}â€¦`);
  try {
    // Check if exists
    const q = encodeURIComponent(`name='${fileName}' and '${S.folderId}' in parents and trashed=false`);
    const res = await gFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`);
    const body = JSON.stringify({ key: periodKey, rows });

    if(res.files?.length) {
      await gFetchRaw(`https://www.googleapis.com/upload/drive/v3/files/${res.files[0].id}?uploadType=media`, {
        method:'PATCH', headers:{'Content-Type':'application/json'}, body,
      });
    } else {
      const meta = { name: fileName, parents: [S.folderId] };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(meta)],{type:'application/json'}));
      form.append('file', new Blob([body],{type:'application/json'}));
      await gFetchRaw('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method:'POST', headers:{}, body: form,
      });
    }
    setSyncState('synced','Guardado en Drive');
    toast(`âœ… ${periodKey} guardado en Drive`,'ok');
  } catch(e) {
    setSyncState('error','Error');
    toast('Error guardando perÃ­odo: '+e.message,'err');
  }
}

// â”€â”€ List periods in Drive folder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshMonthsList() {
  if(!S.folderId) return;
  const btn = document.getElementById('btnRefreshMonths');
  if(btn) btn.disabled = true;
  try {
    const q = encodeURIComponent(`'${S.folderId}' in parents and trashed=false and name contains '.json' and not name='${APP_CONFIG.gestionFileName}'`);
    const res = await gFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime)&orderBy=name`);
    renderMonthsGrid(res.files||[]);
  } catch(e) {
    document.getElementById('monthsGrid').innerHTML = `<div class="no-months" style="color:var(--ro)">Error cargando perÃ­odos: ${h(e.message)}</div>`;
  }
  if(btn) btn.disabled = false;
}

function renderMonthsGrid(files) {
  const grid = document.getElementById('monthsGrid');
  if(!files.length) {
    grid.innerHTML = '<div class="no-months">No hay perÃ­odos guardados aÃºn.<br>Carga tu primer Excel abajo â†“</div>';
    return;
  }
  // files are like "2025_Enero.json"
  grid.innerHTML = files.map(f => {
    const key = f.name.replace('.json','');
    const parts = key.split('_');
    const year = parts[0]||'';
    const month = parts.slice(1).join(' ')||'';
    const isLoaded = !!S.periods[key];
    const isSelected = S.selectedPeriods.has(key);
    const mod = f.modifiedTime ? new Date(f.modifiedTime).toLocaleDateString('es-CO',{day:'2-digit',month:'short'}) : '';
    return `<div class="month-chip ${isLoaded?'loaded':''} ${isSelected?'selected':''}" 
               onclick="togglePeriod('${key}','${f.id}')" id="mc_${key}">
      <div class="mc-badge"></div>
      <div class="mc-sel-badge">âœ“</div>
      <div class="mc-year">${h(year)}</div>
      <div class="mc-month">${h(month)}</div>
      <div class="mc-count">${isLoaded ? S.periods[key].deduped.length.toLocaleString()+' placas' : mod ? 'Actualizado '+mod : 'Sin cargar'}</div>
    </div>`;
  }).join('');
}

async function togglePeriod(key, fileId) {
  if(S.periods[key]) {
    // Already loaded â€” just toggle selection
    if(S.selectedPeriods.has(key)) {
      S.selectedPeriods.delete(key);
    } else {
      S.selectedPeriods.add(key);
    }
    updateMonthChip(key);
    checkBtn();
    return;
  }
  // Load from Drive
  const chip = document.getElementById(`mc_${key}`);
  if(chip) chip.querySelector('.mc-count').textContent = 'Cargandoâ€¦';
  setSyncState('syncing',`Cargando ${key}â€¦`);
  try {
    const res = await gFetchRaw(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`);
    const data = await res.json();
    const rows = data.rows||[];
    const aprobados = rows.filter(r=>r.Aprobado);
    const byP = {};
    aprobados.forEach(r=>{ if(!byP[r.Placa]||r.FechaFinal>byP[r.Placa].FechaFinal) byP[r.Placa]=r; });
    // Restore Date objects
    Object.values(byP).forEach(r=>{
      if(r.VencDate) r.VencDate = new Date(r.VencDate);
      if(r.FechaDate) r.FechaDate = new Date(r.FechaDate);
    });
    S.periods[key] = { label: key.replace('_',' '), rows, deduped: Object.values(byP) };
    S.selectedPeriods.add(key);
    updateMonthChip(key);
    setSyncState('synced','Sincronizado');
    checkBtn();
    toast(`âœ… ${key} cargado Â· ${Object.values(byP).length.toLocaleString()} placas`,'ok');
  } catch(e) {
    setSyncState('error','Error');
    toast('Error cargando perÃ­odo: '+e.message,'err');
    if(chip) chip.querySelector('.mc-count').textContent = 'Error';
  }
}

function updateMonthChip(key) {
  const chip = document.getElementById(`mc_${key}`);
  if(!chip) return;
  const isLoaded = !!S.periods[key];
  const isSelected = S.selectedPeriods.has(key);
  chip.className = `month-chip ${isLoaded?'loaded':''} ${isSelected?'selected':''}`;
  if(isLoaded) chip.querySelector('.mc-count').textContent = S.periods[key].deduped.length.toLocaleString()+' placas';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL UPLOAD SLOTS (to create new periods)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSlots() {
  const g = document.getElementById('yg');
  if(g.children.length === 0) {
    addSlot(2024); addSlot(2025);
  }
}

function addSlot(yr) {
  const idx = S.years.length;
  if(idx >= 4){ toast('MÃ¡ximo 4 aÃ±os','err'); return; }
  S.years.push({label:String(yr),allRows:null,avM:[],selM:new Set(['__ALL__']),filtered:[],deduped:[],fileName:''});
  const g = document.getElementById('yg');
  document.getElementById('addSlotBtn')?.remove();
  const c = document.createElement('div');
  c.className='yc'; c.id=`yc_${idx}`;
  c.innerHTML=`
    <div class="yc-head">
      <span class="yb" id="yb_${idx}">${yr}</span>
      <input class="yi" type="number" value="${yr}" min="2000" max="2099"
        oninput="S.years[${idx}].label=this.value;document.getElementById('yb_${idx}').textContent=this.value">
      ${idx>=2?`<button class="yr-btn" onclick="removeSlot(${idx})">âœ•</button>`:''}
    </div>
    <label class="fd" id="fd_${idx}">
      <input type="file" accept=".xlsx,.xls" onchange="loadFile(event,${idx})">
      <div style="font-size:18px;margin-bottom:2px">ğŸ“„</div>
      <div style="font-weight:600;font-size:11px">Clic para subir Excel</div>
    </label>
    <div class="fst" id="fst_${idx}"></div>
    <div class="mp" id="mp_${idx}">
      <div class="mlbl">Meses:</div>
      <div class="mcs" id="mcs_${idx}"></div>
      <div class="macts">
        <button class="mact" onclick="selAllM(${idx})">Todos</button>
        <button class="mact" onclick="clrM(${idx})">Ninguno</button>
      </div>
    </div>`;
  g.appendChild(c);
  if(S.years.length < 4) {
    const a = document.createElement('div');
    a.className='add-slot'; a.id='addSlotBtn';
    a.onclick=()=>addSlot(parseInt(S.years[S.years.length-1].label)+1);
    a.innerHTML='+ Agregar aÃ±o';
    g.appendChild(a);
  }
}

function removeSlot(idx) {
  const saved = S.years.filter((_,i)=>i!==idx);
  S.years=[]; document.getElementById('yg').innerHTML='';
  saved.forEach((y,i)=>{ addSlot(parseInt(y.label)); if(y.allRows){S.years[i]=y;renderSlotLoaded(i);} });
  checkBtn();
}

function renderSlotLoaded(idx) {
  const y = S.years[idx];
  const c = document.getElementById(`yc_${idx}`); if(!c) return;
  c.classList.add('loaded');
  const fs = document.getElementById(`fst_${idx}`);
  fs.style.display='block';
  fs.textContent=`âœ… ${y.fileName} Â· ${y.allRows.filter(r=>r.Aprobado).length.toLocaleString()} aprobados`;
  renderChips(idx);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// READ EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadFile(evt, idx) {
  const file = evt.target.files[0]; if(!file) return;
  toast(`â³ Leyendo ${file.name}â€¦`);
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(e.target.result,{type:'array',cellDates:true});
      const all = [];
      wb.SheetNames.forEach(sn => {
        const ws = wb.Sheets[sn];
        const raw = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
        if(!raw||raw.length<3) return;
        let hdr=-1;
        for(let i=0;i<Math.min(raw.length,10);i++){
          if(raw[i].map(v=>String(v).trim().toLowerCase()).includes('placa')){hdr=i;break;}
        }
        if(hdr===-1) return;
        const hs = raw[hdr].map(v=>String(v).trim());
        const cm={}; hs.forEach((hh,j)=>{cm[hh.toLowerCase()]=j;});
        const get=(row,...keys)=>{for(const k of keys){const j=cm[k.toLowerCase()];if(j!==undefined&&row[j]!==''&&row[j]!==undefined&&row[j]!==null)return String(row[j]).trim();}return '';};
        for(let i=hdr+1;i<raw.length;i++){
          const row=raw[i];
          const placa=get(row,'placa'); if(!placa||placa.toLowerCase()==='placa') continue;
          const aprobada=get(row,'aprobada','resultado');
          const aprobado=aprobada.toUpperCase()==='APROBADO'||aprobada.toUpperCase()==='SI';
          const fechaStr=get(row,'fecha final','fecha inicio','fecha');
          let mes='',mesNum=0,fechaDate=null;
          if(fechaStr){const d=new Date(fechaStr);if(!isNaN(d)){mesNum=d.getMonth();mes=MO[mesNum];fechaDate=d;}}
          let vencDate=null;
          if(aprobado&&fechaDate){vencDate=new Date(fechaDate);vencDate.setFullYear(vencDate.getFullYear()+1);}
          all.push({
            Placa:placa.toUpperCase().replace(/\s/g,''),
            Propietario:get(row,'propietario'),Identificacion:get(row,'identificacion'),
            Telefono:get(row,'telefono'),Correo:get(row,'correo'),
            Clase:get(row,'clase'),Servicio:get(row,'servicio'),
            Marca:get(row,'marca'),Linea:get(row,'linea'),
            Modelo:get(row,'modelo'),Color:get(row,'color'),
            Ciudad:get(row,'ciudad'),
            Aprobado:aprobado,Resultado:aprobada,
            FechaFinal:fechaStr,
            FechaDate:fechaDate?fechaDate.toISOString():null,
            VencDate:vencDate?vencDate.toISOString():null,
            Mes:mes,MesNum:mesNum,_hoja:sn,
          });
        }
      });
      if(!all.length){toast('Sin datos vÃ¡lidos','err');return;}
      S.years[idx].allRows=all;
      S.years[idx].avM=MO.filter(m=>all.some(r=>r.Mes===m));
      S.years[idx].selM=new Set(['__ALL__']);
      S.years[idx].fileName=file.name;
      applyFilter(idx);
      renderSlotLoaded(idx);
      const aprobados=all.filter(r=>r.Aprobado).length;
      toast(`âœ… ${file.name} Â· ${aprobados.toLocaleString()} aprobados`,'ok');
      checkBtn();

      // Auto-save to Drive: detect period from filename or data
      if(S.folderId) autoSavePeriod(idx, all);
    } catch(err){toast('Error: '+err.message,'err');console.error(err);}
  };
  reader.readAsArrayBuffer(file);
}

async function autoSavePeriod(idx, rows) {
  // Detect period key from data (e.g. 2025_Enero)
  const year = S.years[idx].label;
  const months = [...new Set(rows.filter(r=>r.Mes).map(r=>r.Mes))];
  if(!months.length) return;
  for(const mes of months) {
    const key = `${year}_${mes}`;
    await savePeriodToDrive(key, rows.filter(r=>r.Mes===mes));
  }
  await refreshMonthsList();
}

function renderChips(idx){
  const y=S.years[idx];
  const c=document.getElementById(`mcs_${idx}`);if(!c)return;c.innerHTML='';
  const isAll=y.selM.has('__ALL__');
  const all=document.createElement('span');
  all.className='chip chip-all'+(isAll?' on':'');all.textContent='Todos';all.onclick=()=>selAllM(idx);
  c.appendChild(all);
  y.avM.forEach(mes=>{
    const ch=document.createElement('span');
    ch.className='chip'+(!isAll&&y.selM.has(mes)?' on':'');
    ch.textContent=mes;ch.onclick=()=>toggleM(idx,mes);c.appendChild(ch);
  });
}
function toggleM(idx,mes){const y=S.years[idx];y.selM.delete('__ALL__');y.selM.has(mes)?y.selM.delete(mes):y.selM.add(mes);if(y.selM.size===0)y.selM.add('__ALL__');renderChips(idx);applyFilter(idx);}
function selAllM(idx){S.years[idx].selM=new Set(['__ALL__']);renderChips(idx);applyFilter(idx);}
function clrM(idx){S.years[idx].selM.clear();renderChips(idx);applyFilter(idx);}

function applyFilter(idx){
  const y=S.years[idx];if(!y.allRows)return;
  const rows=(y.selM.has('__ALL__')||y.selM.size===0)?y.allRows:y.allRows.filter(r=>y.selM.has(r.Mes));
  const aprobados=rows.filter(r=>r.Aprobado);
  const byP={};aprobados.forEach(r=>{if(!byP[r.Placa]||r.FechaFinal>byP[r.Placa].FechaFinal)byP[r.Placa]=r;});
  y.filtered=aprobados;y.deduped=Object.values(byP);
}

function checkBtn(){
  const hasLocal = S.years.filter(y=>y.allRows).length >= 1;
  const hasPeriods = S.selectedPeriods.size >= 1;
  document.getElementById('btnRun').disabled = !(hasLocal || hasPeriods);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runAnalysis(){
  S.years.forEach((_,i)=>{if(S.years[i].allRows)applyFilter(i);});
  document.getElementById('loadingRow').style.display='flex';
  document.getElementById('btnRun').disabled=true;
  setTimeout(()=>{
    try{
      // Build year-like structures from selected Drive periods + local slots
      const lys = buildAnalysisLayers();
      if(lys.length < 1){ toast('Selecciona al menos un perÃ­odo','err'); return; }
      S.analysis=compute(lys);
      renderResults();
      document.getElementById('results').style.display='block';
      document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
      showTodayBanner();
      toast(`âœ… AnÃ¡lisis completo Â· ${S.analysis.noVolvieron.length.toLocaleString()} para recontactar`,'ok');
    }catch(e){toast('Error: '+e.message,'err');console.error(e);}
    document.getElementById('loadingRow').style.display='none';
    document.getElementById('btnRun').disabled=false;
  },300);
}

function buildAnalysisLayers() {
  const layers = [];
  // From Drive periods (sorted by key)
  const sortedKeys = [...S.selectedPeriods].sort();
  sortedKeys.forEach(key => {
    const p = S.periods[key];
    if(!p) return;
    layers.push({ label: p.label, allRows: p.rows, filtered: p.rows.filter(r=>r.Aprobado), deduped: p.deduped });
  });
  // From local upload slots
  S.years.forEach(y => {
    if(!y.allRows) return;
    layers.push({ label: y.label, allRows: y.allRows, filtered: y.filtered, deduped: y.deduped });
  });
  // Deduplicate layers with same label
  const seen = new Set();
  return layers.filter(l => { if(seen.has(l.label)) return false; seen.add(l.label); return true; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPUTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function compute(lys){
  const ymaps=lys.map(y=>{const m={};(y.deduped||[]).forEach(r=>{m[r.Placa]=r;});return{label:y.label,map:m};});
  const all=new Set();ymaps.forEach(ym=>Object.keys(ym.map).forEach(p=>all.add(p)));
  const recurrentes=[],parciales=[],noVolvieron=[],nuevos=[],matrix=[];
  all.forEach(placa=>{
    const pres=ymaps.map(ym=>!!ym.map[placa]);
    const enTodos=pres.every(Boolean);
    const enUltimo=pres[pres.length-1];
    const cuenta=pres.filter(Boolean).length;
    let info=null;for(let i=ymaps.length-1;i>=0;i--){if(ymaps[i].map[placa]){info=ymaps[i].map[placa];break;}}
    const row={...info,Placa:placa,_cnt:cuenta,_yrs:ymaps.filter((_,i)=>pres[i]).map(ym=>ym.label).join(', ')};
    ymaps.forEach((ym,i)=>{
      row[`_p${i}`]=pres[i]?'SI':'';
      row[`_r${i}`]=ym.map[placa]?.Resultado||'';
      row[`_m${i}`]=ym.map[placa]?.Mes||'';
      const vd=ym.map[placa]?.VencDate;
      row[`_v${i}`]=vd?(vd instanceof Date?vd:new Date(vd)):null;
    });
    let _vLast=null;for(let i=ymaps.length-1;i>=0;i--){if(row[`_v${i}`]){_vLast=row[`_v${i}`];break;}}
    row._vLast=_vLast;
    matrix.push(row);
    if(enTodos) recurrentes.push(row);
    else if(pres[0]&&!enUltimo) noVolvieron.push(row);
    else if(!pres[0]&&enUltimo) nuevos.push(row);
    else if(cuenta>=2) parciales.push(row);
  });
  noVolvieron.sort((a,b)=>{
    const va=getVenc(a.Placa,a).date||new Date('2099');
    const vb=getVenc(b.Placa,b).date||new Date('2099');
    return va-vb;
  });
  const statsByYear=ymaps.map((ym,i)=>{
    const rows=lys[i].filtered||[];
    return{label:ym.label,total:Object.keys(ym.map).length,totalRevs:rows.length,
      byClase:cntBy(Object.values(ym.map),'Clase'),byMarca:cntBy(Object.values(ym.map),'Marca'),
      byMes:cntByMes(rows),byServ:cntBy(Object.values(ym.map),'Servicio')};
  });
  return{ymaps,recurrentes,parciales,noVolvieron,nuevos,matrix,statsByYear,total:all.size};
}
function cntBy(arr,k){const m={};arr.forEach(r=>{const v=(r[k]||'Sin dato').trim()||'Sin dato';m[v]=(m[v]||0)+1;});return Object.entries(m).sort((a,b)=>b[1]-a[1]);}
function cntByMes(arr){const m={};arr.forEach(r=>{if(r.Mes)m[r.Mes]=(m[r.Mes]||0)+1;});return MO.filter(mes=>m[mes]).map(mes=>[mes,m[mes]]);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VENCIMIENTO + OVERRIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getVenc(placa, row){
  const override=GESTION[placa]?.vencOverride;
  if(override) return{date:new Date(override),isManual:true};
  if(row?._vLast) return{date:row._vLast instanceof Date?row._vLast:new Date(row._vLast),isManual:false};
  return{date:null,isManual:false};
}
function saveVencOverride(placa,dateStr){
  if(!GESTION[placa])GESTION[placa]={estado:'pendiente',contactos:[]};
  GESTION[placa].vencOverride=dateStr;persistGestion();
}
function clearVencOverride(placa){if(GESTION[placa])delete GESTION[placa].vencOverride;persistGestion();}
function showVencEditor(placa){const el=document.getElementById(`ve_${placa}`);if(el)el.style.display=el.style.display==='none'?'flex':'none';}
function applyVencOverride(placa){
  const inp=document.getElementById(`vi_${placa}`);
  if(!inp?.value){toast('Selecciona una fecha','err');return;}
  saveVencOverride(placa,inp.value);
  const row=S.analysis?.matrix?.find(r=>r.Placa===placa);
  if(row){renderMVenc(placa,row);refreshVencCells();}
  toast('âœ… Fecha actualizada','ok');showTodayBanner();
}
function vencCell(_, placa, row){
  const v=getVenc(placa,row);
  if(!v.date){
    if(placa)return`<div class="venc-edit-wrap"><span class="dash">Sin fecha</span><button class="btn-edit-venc" onclick="openModal('${placa}')">âœï¸ Agregar</button></div>`;
    return'<span class="dash">â€”</span>';
  }
  const now=new Date(),d=v.date,diff=Math.ceil((d-now)/(1000*60*60*24));
  const fecha=d.toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'numeric'});
  const llamarD=new Date(d);llamarD.setDate(llamarD.getDate()-DIAS_LLAMAR);
  const llamarFmt=llamarD.toLocaleDateString('es-CO',{day:'2-digit',month:'short'});
  let cls,lbl;
  if(diff<0){cls='v-vencido';lbl=`â›” Vencido (${Math.abs(diff)}d)`;}
  else if(diff<=DIAS_LLAMAR){cls='v-urgente';lbl=`ğŸ”´ Â¡Llamar ya! (${diff}d)`;}
  else if(diff<=30){cls='v-pronto';lbl=`ğŸŸ¡ Llamar antes del ${llamarFmt}`;}
  else{cls='v-ok';lbl=`ğŸŸ¢ Llamar el ${llamarFmt}`;}
  const manTag=v.isManual?'<span class="venc-manual-badge">âœï¸</span>':'';
  return`<div class="venc-edit-wrap"><div class="venc"><span class="venc-fecha">${fecha}</span><span class="venc-dias ${cls}">${lbl}</span></div>${manTag}</div>`;
}
function vencText(vDate){if(!vDate)return'â€”';return new Date(vDate).toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'});}
function llamarFechaLabel(vDate){if(!vDate)return'';const d=new Date(vDate);d.setDate(d.getDate()-DIAS_LLAMAR);return d.toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'numeric'});}
function renderMVenc(placa,row){
  const v=getVenc(placa,row);const el=document.getElementById('mVenc');if(!el)return;
  const ds=v.date?v.date.toISOString().slice(0,10):'';
  el.innerHTML=`<div class="venc-info"><span>â±</span><div style="flex:1">
    <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
      <strong>Vencimiento RTM: ${v.date?vencText(v.date):'<span style="color:var(--txt3)">Sin fecha</span>'}</strong>
      ${v.isManual?'<span class="venc-manual-badge">âœï¸ Manual</span>':''}
      ${v.isManual?`<button class="btn-edit-venc" onclick="clearVencOverride('${placa}');const r=S.analysis.matrix.find(x=>x.Placa==='${placa}');renderMVenc('${placa}',r);refreshVencCells()">â†º Usar calculada</button>`:''}
    </div>
    ${v.date?`<div style="font-size:10px;color:var(--na);margin-top:2px">ğŸ“ Llamar el ${llamarFechaLabel(v.date)}</div>`:''}
    <button class="btn-edit-venc" style="margin-top:4px" onclick="showVencEditor('${placa}')">âœï¸ ${v.isManual?'Cambiar':'Corregir'} fecha</button>
    <div class="venc-override-row" id="ve_${placa}" style="display:none">
      <input type="date" id="vi_${placa}" value="${ds}">
      <button class="btn-save-venc" onclick="applyVencOverride('${placa}')">Guardar</button>
      <button onclick="showVencEditor('${placa}')" style="background:var(--bg);color:var(--txt2);border:1.5px solid var(--bd);border-radius:6px;padding:4px 9px;font-family:var(--font);font-size:11px;cursor:pointer">Cancelar</button>
    </div>
  </div></div>`;
}
function refreshVencCells(){
  document.querySelectorAll('tbody tr').forEach(tr=>{
    const placa=tr.querySelector('.td-placa')?.textContent;
    if(!placa)return;
    const row=S.analysis?.matrix?.find(r=>r.Placa===placa);
    if(!row)return;
    tr.querySelectorAll('td').forEach(td=>{
      if(td.querySelector('.venc')||td.querySelector('.venc-edit-wrap'))
        td.innerHTML=vencCell(null,placa,row);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(){
  const a=S.analysis;
  const first=a.statsByYear[0];
  const ret=first.total>0?(a.recurrentes.length/first.total*100).toFixed(1):'0.0';
  const cp=a.ymaps.map(ym=>`<strong>${ym.label}</strong>`).join(' â†’ ');
  document.getElementById('ctxBar').innerHTML=`ğŸ” PerÃ­odos: ${cp} <span style="opacity:.6">(solo aprobados)</span>`;
  const kpis=[
    {l:'Placas Ãºnicas',v:a.total.toLocaleString(),s:'en todos los perÃ­odos'},
    {l:'Recurrentes',v:a.recurrentes.length.toLocaleString(),s:'en todos los perÃ­odos'},
    {l:'Recontactar',v:a.noVolvieron.length.toLocaleString(),s:'no volvieron'},
    {l:'RetenciÃ³n',v:ret+'%',s:'del primer al Ãºltimo perÃ­odo'},
    {l:'Nuevos',v:a.nuevos.length.toLocaleString(),s:'solo en el Ãºltimo perÃ­odo'},
  ];
  const kr=document.getElementById('kpiRow');kr.innerHTML='';
  kpis.forEach((k,i)=>{
    const d=document.createElement('div');d.className='kpi';d.style.animationDelay=`${i*.06}s`;
    d.innerHTML=`<div class="kpi-lbl">${k.l}</div><div class="kpi-val">${k.v}</div><div class="kpi-sub">${k.s}</div>`;
    kr.appendChild(d);
  });
  const numYears=a.ymaps.length;
  const tabs=[
    {id:'nov',ico:'ğŸ“',lbl:'Recontactar',n:a.noVolvieron.length,urgent:true},
    {id:'rec',ico:'âœ…',lbl:'Recurrentes',n:a.recurrentes.length},
    {id:'new',ico:'ğŸ†•',lbl:'Nuevos',n:a.nuevos.length},
    ...(numYears>=3?[{id:'par',ico:'âš ï¸',lbl:'Parciales',n:a.parciales.length}]:[]),
    {id:'mat',ico:'ğŸ“‹',lbl:'Matriz',n:a.total},
    {id:'hoy',ico:'ğŸ“…',lbl:'Hoy',n:null},
    {id:'stat',ico:'ğŸ“Š',lbl:'Resumen',n:null},
  ];
  const tr=document.getElementById('tabsRow');tr.innerHTML='';
  tabs.forEach(t=>{
    const b=document.createElement('button');
    b.className='tab'+(t.urgent?' urgent':'');b.id=`tab_${t.id}`;b.onclick=()=>showTab(t.id);
    b.innerHTML=`${t.ico} ${t.lbl}${t.n!==null?`<span class="tab-n">${t.n.toLocaleString()}</span>`:''}`;
    tr.appendChild(b);
  });
  showTab('nov');
}

function showTab(id){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  document.getElementById(`tab_${id}`)?.classList.add('on');
  S.activeTab=id;
  const a=S.analysis,p=document.getElementById('mainPanel');
  if(id==='nov') p.innerHTML=buildTable(a.noVolvieron,'nov',a.ymaps,true);
  else if(id==='rec') p.innerHTML=buildTable(a.recurrentes,'rec',a.ymaps,false);
  else if(id==='new') p.innerHTML=buildTable(a.nuevos,'new',a.ymaps,false);
  else if(id==='par') p.innerHTML=buildTable(a.parciales,'par',a.ymaps,false);
  else if(id==='mat') renderMatrix(a,p);
  else if(id==='hoy') renderHoy(a,p);
  else if(id==='stat') renderStat(a,p);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTIÃ“N BADGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gestBadge(placa){
  const g=GESTION[placa];const estado=g?.estado||'pendiente';
  const e=ESTADOS.find(x=>x.v===estado)||ESTADOS[0];
  return`<span class="gb ${e.cls}" onclick="openModal('${placa}')">${e.i} ${e.l}</span>`;
}
function refreshBadges(){
  document.querySelectorAll('.gb').forEach(el=>{
    const placa=el.closest('tr')?.querySelector('.td-placa')?.textContent;
    if(placa)el.outerHTML=gestBadge(placa);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTable(data,tid,ymaps,showVenc){
  if(!data.length)return`<div class="empty"><div class="empty-ico">ğŸ“­</div><h3>Sin registros</h3></div>`;
  const yHdrs=ymaps.map(ym=>`<th>${ym.label}</th>`).join('');
  const rows=data.map(r=>{
    const tel=r.Telefono||'';
    const telNum=tel.replace(/\D/g,'');
    const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
    const msgWA=encodeURIComponent(fillTpl(TPLS.whatsapp,r));
    const telCell=tel
      ?`<div class="td-tel">${tel}</div><div class="call-row" style="margin-top:3px">
          <a class="btn-call btn-tel" href="tel:${tel}">ğŸ“ Llamar</a>
          <a class="btn-call btn-wa" href="https://wa.me/${waNum}?text=${msgWA}" target="_blank">ğŸ’¬ WA</a>
        </div>`
      :`<span class="dash">Sin telÃ©fono</span>`;
    const yCells=ymaps.map((_,i)=>`<td style="text-align:center">${r[`_p${i}`]==='SI'?'<span class="chk">âœ”</span>':'<span class="dash">â€”</span>'}</td>`).join('');
    const vRow=showVenc?`<td>${vencCell(null,r.Placa,r)}</td>`:'';
    return`<tr data-s="${h((r.Placa+r.Propietario+r.Marca+(r.Telefono||'')+(r.Correo||'')).toLowerCase())}">
      <td class="td-placa">${h(r.Placa)}</td>
      <td><div class="td-nombre">${h(r.Propietario||'â€”')}</div><div style="font-size:10px;color:var(--txt2)">${h(r.Clase||'')} ${h(r.Marca||'')} ${h(r.Linea||'')}</div></td>
      <td>${telCell}</td>
      ${vRow}
      <td>${gestBadge(r.Placa)}</td>
      ${yCells}
    </tr>`;
  }).join('');
  const gestOpts=ESTADOS.map(e=>`<option value="${e.v}">${e.i} ${e.l}</option>`).join('');
  return`
    <div class="fbar">
      <span class="fbar-lbl">Buscar:</span>
      <input type="text" placeholder="Placa, nombreâ€¦" oninput="filtTbl('${tid}',this)">
      <select onchange="filtTbl('${tid}',null)"><option value="">Estado gestiÃ³n</option>${gestOpts}</select>
      <span class="fbar-cnt" id="cnt_${tid}">${data.length.toLocaleString()} registros</span>
      <button class="btn-csv" onclick="exportCSV('${tid}')">â¬‡ CSV</button>
    </div>
    <div class="tbl-wrap">
      <table><thead><tr>
        <th>Placa</th><th>Propietario Â· VehÃ­culo</th><th>TelÃ©fono</th>
        ${showVenc?'<th>Vencimiento Â· Llamar</th>':''}
        <th>GestiÃ³n</th>${yHdrs}
      </tr></thead><tbody id="tb_${tid}">${rows}</tbody></table>
    </div>`;
}
function filtTbl(tid,input){
  const fbar=document.querySelector(`#tb_${tid}`)?.closest('.panel')?.querySelector('.fbar');
  if(!fbar)return;
  const search=(fbar.querySelector('input')?.value||'').toLowerCase();
  const gest=(fbar.querySelectorAll('select')[0]?.value||'');
  let cnt=0;
  document.querySelectorAll(`#tb_${tid} tr`).forEach(tr=>{
    const placa=tr.querySelector('.td-placa')?.textContent||'';
    const gestE=GESTION[placa]?.estado||'pendiente';
    const ok=(!search||(tr.dataset.s||'').includes(search))&&(!gest||gestE===gest);
    tr.style.display=ok?'':'none';if(ok)cnt++;
  });
  const c=document.getElementById(`cnt_${tid}`);if(c)c.textContent=cnt.toLocaleString()+' registros';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTodayBanner(){
  const today=new Date().toISOString().slice(0,10);
  const banner=document.getElementById('todayBanner');
  if(!S.analysis||!banner){if(banner)banner.style.display='none';return;}
  const list=S.analysis.matrix.filter(r=>GESTION[r.Placa]?.contactos?.some(c=>c.proxFecha===today));
  if(!list.length){banner.style.display='none';return;}
  banner.style.display='flex';
  document.getElementById('tbTitle').textContent=`Tienes ${list.length} cliente${list.length>1?'s':''} para llamar hoy`;
  document.getElementById('tbSub').textContent=list.slice(0,3).map(r=>r.Placa+' â€“ '+(r.Propietario||'').split(' ')[0]).join(' Â· ')+(list.length>3?' Â· y '+(list.length-3)+' mÃ¡s':'');
}
function renderHoy(a,p){
  const today=new Date().toISOString().slice(0,10);
  const todayFmt=new Date().toLocaleDateString('es-CO',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const now=new Date();
  const seguimientos=a.matrix.filter(r=>GESTION[r.Placa]?.contactos?.some(c=>c.proxFecha===today));
  const urgentes=a.matrix.filter(r=>{
    if(GESTION[r.Placa]?.estado==='no-interesa')return false;
    const v=getVenc(r.Placa,r).date;if(!v)return false;
    return Math.ceil((v-now)/(1000*60*60*24))>=0&&Math.ceil((v-now)/(1000*60*60*24))<=DIAS_LLAMAR;
  });
  const proximos=a.matrix.filter(r=>{
    if(GESTION[r.Placa]?.estado==='no-interesa')return false;
    const v=getVenc(r.Placa,r).date;if(!v)return false;
    const d=Math.ceil((v-now)/(1000*60*60*24));return d>DIAS_LLAMAR&&d<=38;
  });
  const mkRows=(list,sNota)=>list.map(r=>{
    const tel=r.Telefono||'';const telNum=tel.replace(/\D/g,'');
    const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
    const msgWA=encodeURIComponent(fillTpl(TPLS.whatsapp,r));
    const nota=sNota?(GESTION[r.Placa]?.contactos?.find(c=>c.proxFecha===today)?.nota||''):'';
    return`<tr>
      <td class="td-placa" style="font-size:12px">${h(r.Placa)}</td>
      <td><div style="font-weight:600;font-size:12px">${h(r.Propietario||'â€”')}</div><div style="font-size:10px;color:var(--txt2)">${h(r.Clase||'')} ${h(r.Marca||'')}</div></td>
      <td class="td-tel">${tel||'â€”'}</td>
      <td>${tel?`<div class="call-row"><a class="btn-call btn-tel" href="tel:${tel}">ğŸ“</a><a class="btn-call btn-wa" href="https://wa.me/${waNum}?text=${msgWA}" target="_blank">ğŸ’¬</a></div>`:'â€”'}</td>
      <td>${vencCell(null,r.Placa,r)}</td>
      <td>${gestBadge(r.Placa)}</td>
      ${sNota?`<td style="font-size:11px;color:var(--txt2);max-width:140px;white-space:normal">${h(nota)}</td>`:''}
    </tr>`;
  }).join('');
  const th=(sN)=>`<thead><tr><th>Placa</th><th>Cliente</th><th>TelÃ©fono</th><th>Contactar</th><th>Vencimiento</th><th>Estado</th>${sN?'<th>Nota</th>':''}</tr></thead>`;
  p.innerHTML=`<div class="hoy-section">
    <div class="hoy-head" style="text-transform:capitalize">ğŸ“… ${todayFmt}</div>
    ${seguimientos.length
      ?`<div class="hoy-block seguimientos"><div class="hoy-block-title">â° Seguimientos hoy (${seguimientos.length})</div>
         <div class="tbl-wrap" style="max-height:240px"><table>${th(true)}<tbody>${mkRows(seguimientos,true)}</tbody></table></div></div>`
      :`<div class="hoy-block empty-block">âœ… Sin seguimientos programados para hoy</div>`}
    ${urgentes.length?`<div class="hoy-block vencen"><div class="hoy-block-title">ğŸ”´ Â¡Llamar urgente! â€” vencen en ${DIAS_LLAMAR} dÃ­as (${urgentes.length})</div>
       <div class="tbl-wrap" style="max-height:240px"><table>${th(false)}<tbody>${mkRows(urgentes,false)}</tbody></table></div></div>`:''}
    ${proximos.length?`<div class="hoy-block" style="background:var(--az-l);border-color:rgba(0,56,147,.2)"><div class="hoy-block-title" style="color:var(--az)">ğŸ“‹ PrÃ³ximos 30 dÃ­as (${proximos.length})</div>
       <div class="tbl-wrap" style="max-height:240px"><table>${th(false)}<tbody>${mkRows(proximos,false)}</tbody></table></div></div>`:''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATRIX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMatrix(a,p){
  const yH=a.ymaps.map(ym=>`<th>âœ” ${ym.label}</th><th>Vence</th>`).join('');
  const rows=a.matrix.map(r=>{
    const yC=a.ymaps.map((_,i)=>`<td style="text-align:center">${r[`_p${i}`]==='SI'?'<span class="chk">âœ”</span>':'<span class="dash">â€”</span>'}</td><td>${r[`_p${i}`]==='SI'?vencCell(null,r.Placa,r):'<span class="dash">â€”</span>'}</td>`).join('');
    return`<tr data-s="${h((r.Placa+r.Propietario).toLowerCase())}">
      <td class="td-placa">${h(r.Placa)}</td>
      <td><div class="td-nombre">${h(r.Propietario||'')}</div><div style="font-size:10px;color:var(--txt2)">${h(r.Clase||'')} ${h(r.Marca||'')}</div></td>
      <td><span class="pill p-am">${r._cnt} / ${a.ymaps.length} perÃ­odos</span></td>
      <td>${gestBadge(r.Placa)}</td>${yC}
    </tr>`;
  }).join('');
  p.innerHTML=`<div class="fbar">
    <input type="text" placeholder="Placa o propietarioâ€¦" oninput="filtMat(this.value)">
    <span class="fbar-cnt" id="cnt_mat">${a.matrix.length.toLocaleString()} registros</span>
    <button class="btn-csv" onclick="exportCSV('mat')">â¬‡ CSV</button>
  </div>
  <div class="tbl-wrap">
    <table><thead><tr><th>Placa</th><th>Propietario</th><th>Historial</th><th>GestiÃ³n</th>${yH}</tr></thead>
    <tbody id="tb_mat">${rows}</tbody></table>
  </div>`;
}
function filtMat(v){v=v.toLowerCase();let c=0;document.querySelectorAll('#tb_mat tr').forEach(tr=>{const ok=!v||(tr.dataset.s||'').includes(v);tr.style.display=ok?'':'none';if(ok)c++;});const e=document.getElementById('cnt_mat');if(e)e.textContent=c.toLocaleString()+' registros';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStat(a,p){
  const now=new Date();
  const vencidos=a.matrix.filter(r=>{const v=getVenc(r.Placa,r).date;return v&&v<now;});
  const prox8=a.matrix.filter(r=>{const v=getVenc(r.Placa,r).date;if(!v)return false;const d=Math.ceil((v-now)/(1000*60*60*24));return d>=0&&d<=DIAS_LLAMAR;});
  const C6l=['#003893','#1a6b3c','#CE1126','#c05e00','#5b21b6','#0891b2'];
  const mkBar=(items,colors,mx8=7)=>{const mx=items[0]?.[1]||1;return items.slice(0,mx8).map(([k,v],i)=>`
    <div class="bar-row"><div class="bar-lbl" title="${h(k)}">${h(k)}</div>
    <div class="bar-trk"><div class="bar-fill" style="width:${Math.round(v/mx*100)}%;background:${colors[i%colors.length]}"></div></div>
    <div class="bar-cnt">${v}</div></div>`).join('');};
  const yrCards=a.statsByYear.map((sy,yi)=>`
    <div class="yr-stat" style="border-top-color:${C6l[yi%C6l.length]}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div><div style="font-family:var(--serif);font-size:16px;font-weight:900;color:${C6l[yi%C6l.length]}">${sy.label}</div>
          <div style="font-size:10px;color:var(--txt3)">${sy.totalRevs.toLocaleString()} revisiones totales</div></div>
        <div style="font-family:var(--serif);font-size:30px;font-weight:900;color:${C6l[yi%C6l.length]}">${sy.total.toLocaleString()}</div>
      </div>
      <div class="chart-grid">
        <div class="cc"><h3>Por tipo</h3>${mkBar(sy.byClase,CB)}</div>
        <div class="cc"><h3>Top marcas</h3>${mkBar(sy.byMarca,C6l)}</div>
      </div>
      ${sy.byMes.length?`<div class="cc" style="margin-top:10px"><h3>Por mes</h3>${mkBar(sy.byMes,CB,12)}</div>`:''}
    </div>`).join('');
  p.innerHTML=`<div class="charts">
    <div class="stat-alerts">
      <div class="alert-card vencidos"><div class="ac-num">${vencidos.length}</div><div class="ac-lbl">â›” Ya vencidos</div></div>
      <div class="alert-card proximos"><div class="ac-num">${prox8.length}</div><div class="ac-lbl">ğŸ”´ Vencen en ${DIAS_LLAMAR}d</div></div>
    </div>
    ${yrCards}
  </div>`;
  setTimeout(()=>{p.querySelectorAll('.bar-fill').forEach((el,i)=>{const w=el.style.width;el.style.width='0';setTimeout(()=>el.style.width=w,i*12);});},60);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL GESTIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(placa){
  S.modalPlaca=placa;
  const row=S.analysis?.matrix?.find(r=>r.Placa===placa);if(!row)return;
  const g=GESTION[placa]||{estado:'pendiente',contactos:[]};
  const tel=row.Telefono||'';
  const telNum=tel.replace(/\D/g,'');
  const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
  const msgWA=encodeURIComponent(fillTpl(TPLS.whatsapp,row));
  document.getElementById('mTitle').innerHTML=`${h(row.Placa)} <span style="font-size:13px;font-weight:400;color:var(--txt2)">â€” ${h(row.Propietario||'')}</span>`;
  document.getElementById('mContact').innerHTML=`
    <div style="font-size:11px;color:var(--txt2);margin-bottom:10px">
      <strong>${h(row.Clase||'')} ${h(row.Marca||'')} ${h(row.Linea||'')}</strong> Â· ${h(row.Color||'')} Â· Modelo ${h(row.Modelo||'')} Â· ğŸ“ ${h(row.Ciudad||'')}
    </div>
    <div class="contact-cards">
      <div class="contact-card cc-tel">
        <div class="cc-lbl">ğŸ“ TelÃ©fono</div>
        <div class="cc-num">${tel||'Sin nÃºmero'}</div>
        ${tel?`<a class="btn-call btn-tel" href="tel:${tel}" style="display:inline-flex;padding:5px 12px">ğŸ“ Llamar ahora</a>`:''}
      </div>
      <div class="contact-card cc-wa">
        <div class="cc-lbl">ğŸ’¬ WhatsApp</div>
        <div class="cc-num">${tel||'Sin nÃºmero'}</div>
        ${tel?`<a class="btn-call btn-wa" href="https://wa.me/${waNum}?text=${msgWA}" target="_blank" style="display:inline-flex;padding:5px 12px;margin-bottom:4px">ğŸ’¬ Abrir chat</a><br>
               <button onclick="copyMsg('${placa}')" style="background:none;border:none;font-size:10px;color:#128c7e;cursor:pointer;text-decoration:underline">ğŸ“‹ Copiar mensaje</button>`:''}
      </div>
    </div>`;
  renderMVenc(placa,row);
  const estOpts=ESTADOS.map(e=>`<option value="${e.v}"${g.estado===e.v?' selected':''}>${e.i} ${e.l}</option>`).join('');
  document.getElementById('mForm').innerHTML=`
    <div class="fr"><label>Estado</label><select id="mEstado" onchange="quickEstado()">${estOpts}</select></div>
    <div class="f2col">
      <div class="fr"><label>Tipo</label>
        <select id="mTipo"><option value="llamada">ğŸ“ Llamada</option><option value="whatsapp">ğŸ’¬ WhatsApp</option>
          <option value="sms">ğŸ“± SMS</option><option value="email">ğŸ“§ Email</option><option value="visita">ğŸš¶ Visita</option></select>
      </div>
      <div class="fr"><label>Resultado</label>
        <select id="mRes"><option value="no-contestÃ³">No contestÃ³</option><option value="interesado">Interesado âœ…</option>
          <option value="agendÃ³-cita">AgendÃ³ cita ğŸ“…</option><option value="no-interesa">No le interesa âŒ</option>
          <option value="ocupado">Ocupado / rellamar</option><option value="buzÃ³n">BuzÃ³n de voz</option>
          <option value="numero-errado">NÃºmero errado</option></select>
      </div>
    </div>
    <div class="fr"><label>Nota</label><textarea id="mNota" placeholder="Observaciones, acuerdos, prÃ³ximos pasosâ€¦"></textarea></div>
    <div class="fr"><label>ğŸ“… PrÃ³ximo seguimiento</label><input type="date" id="mProx" value="${new Date().toISOString().slice(0,10)}"></div>
    <button class="btn-save" onclick="saveContacto()">ğŸ’¾ Registrar contacto</button>`;
  renderHistorial(placa);
  document.getElementById('modalBg').classList.add('show');
}
function copyMsg(placa){const row=S.analysis?.matrix?.find(r=>r.Placa===placa);if(!row)return;navigator.clipboard.writeText(fillTpl(TPLS.whatsapp,row)).then(()=>toast('âœ… Mensaje copiado','ok'));}
function quickEstado(){const p=S.modalPlaca;if(!GESTION[p])GESTION[p]={estado:'pendiente',contactos:[]};GESTION[p].estado=document.getElementById('mEstado').value;persistGestion();refreshBadges();}
async function saveContacto(){
  const p=S.modalPlaca;if(!GESTION[p])GESTION[p]={estado:'pendiente',contactos:[]};
  const g=GESTION[p];g.estado=document.getElementById('mEstado').value;
  g.contactos.unshift({tipo:document.getElementById('mTipo').value,resultado:document.getElementById('mRes').value,
    nota:document.getElementById('mNota').value.trim(),proxFecha:document.getElementById('mProx').value,
    fecha:new Date().toLocaleString('es-CO',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})});
  await persistGestion();renderHistorial(p);document.getElementById('mNota').value='';
  refreshBadges();showTodayBanner();toast('âœ… Contacto guardado','ok');
}
function deleteContacto(p,i){GESTION[p]?.contactos?.splice(i,1);persistGestion();renderHistorial(p);toast('Eliminado');}
function renderHistorial(placa){
  const g=GESTION[placa];const el=document.getElementById('mHist');if(!el)return;
  if(!g?.contactos?.length){el.innerHTML='<div class="hist-wrap"><h4>Historial</h4><p style="font-size:11px;color:var(--txt2)">Sin contactos aÃºn.</p></div>';return;}
  const rc=(r)=>{if(r?.includes('nteresado')||r?.includes('gendÃ³'))return'ok';if(r?.includes('no-interesa')||r?.includes('errado'))return'bad';return'neutral';};
  const ti=(t)=>({llamada:'ğŸ“',whatsapp:'ğŸ’¬',sms:'ğŸ“±',email:'ğŸ“§',visita:'ğŸš¶'}[t]||'ğŸ“');
  el.innerHTML=`<div class="hist-wrap"><h4>Historial (${g.contactos.length})</h4>${g.contactos.map((c,i)=>`
    <div class="hi ${c.tipo}">
      <div class="hi-head"><span class="hi-tipo">${ti(c.tipo)} ${c.tipo}</span>
        <span class="hi-res ${rc(c.resultado)}">${c.resultado}</span>
        ${c.proxFecha?`<span class="hi-prox">ğŸ“… ${c.proxFecha}</span>`:''}
        <span class="hi-fecha">${c.fecha}</span>
        <button class="hi-del" onclick="deleteContacto('${placa}',${i})">âœ•</button>
      </div>${c.nota?`<div class="hi-nota">${h(c.nota)}</div>`:''}
    </div>`).join('')}</div>`;
}
function closeModal(){document.getElementById('modalBg').classList.remove('show');S.modalPlaca=null;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLANTILLAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TPL_DEF={
  whatsapp:'Hola {nombre}, le saludamos del CDA Colombia ğŸš—. La revisiÃ³n tÃ©cnico-mecÃ¡nica de su {marca} {linea} placa *{placa}* vence el *{vencimiento}*. Lo esperamos para renovar su certificado. Â¿Desea agendar?',
  sms:'CDA Colombia: RevisiÃ³n placa {placa} ({marca}) vence {vencimiento}. ComunÃ­quese para agendar.',
  recordatorio:'Hola {nombre}, le recordamos su cita en CDA Colombia. VehÃ­culo placa {placa}. Cualquier inquietud con gusto le atendemos ğŸ“‹'
};
let TPLS={};
try{TPLS=JSON.parse(localStorage.getItem('cda_tpls')||JSON.stringify(TPL_DEF));}catch{TPLS={...TPL_DEF};}
function fillTpl(tpl,row){
  const v=getVenc(row.Placa,row);
  const vd=v.date?v.date.toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'}):'prÃ³ximamente';
  return tpl.replace(/{nombre}/g,(row.Propietario||'Cliente').split(' ')[0])
    .replace(/{placa}/g,row.Placa||'').replace(/{marca}/g,row.Marca||'')
    .replace(/{linea}/g,row.Linea||'').replace(/{vencimiento}/g,vd).replace(/{clase}/g,row.Clase||'');
}
function openTemplatesModal(){document.getElementById('tpl_wa').value=TPLS.whatsapp;document.getElementById('tpl_sms').value=TPLS.sms;document.getElementById('tpl_rec').value=TPLS.recordatorio;document.getElementById('tplBg').classList.add('show');}
function closeTemplatesModal(){document.getElementById('tplBg').classList.remove('show');}
function saveTemplates(){TPLS.whatsapp=document.getElementById('tpl_wa').value;TPLS.sms=document.getElementById('tpl_sms').value;TPLS.recordatorio=document.getElementById('tpl_rec').value;localStorage.setItem('cda_tpls',JSON.stringify(TPLS));closeTemplatesModal();toast('âœ… Plantillas guardadas','ok');}
function resetTemplates(){document.getElementById('tpl_wa').value=TPL_DEF.whatsapp;document.getElementById('tpl_sms').value=TPL_DEF.sms;document.getElementById('tpl_rec').value=TPL_DEF.recordatorio;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSetup(){showSetupStep(1);document.getElementById('setupBg').classList.add('show');}
function closeSetup(){document.getElementById('setupBg').classList.remove('show');}
function showSetupStep(n){
  [1,2,3].forEach(i=>{document.getElementById(`sp${i}`).style.display=i===n?'block':'none';document.getElementById(`ss${i}`).classList.toggle('on',i===n);});
  if(n===1&&localStorage.getItem('cda_clientId')) document.getElementById('cfg_clientId').value=localStorage.getItem('cda_clientId');
  if(n===3) checkSetupStatus();
}
function saveClientId(){
  const v=document.getElementById('cfg_clientId').value.trim();
  if(!v){toast('Pega tu Client ID','err');return;}
  localStorage.setItem('cda_clientId',v);
  APP_CONFIG.clientId=v;
  toast('âœ… Client ID guardado â€” recarga la pÃ¡gina para aplicar','ok');
  showSetupStep(2);
}
function checkSetupStatus(){
  const el=document.getElementById('setupStatus');
  const cid=localStorage.getItem('cda_clientId');
  if(!cid){el.innerHTML='âš ï¸ AÃºn no has guardado tu <strong>Client ID</strong>. Ve al paso 1.';return;}
  if(!S.folderId){el.innerHTML='âš ï¸ Client ID guardado, pero no estÃ¡s conectado a Drive. Recarga la pÃ¡gina e inicia sesiÃ³n.';return;}
  el.innerHTML=`âœ… <strong>Todo configurado.</strong><br>Client ID: <code style="font-size:10px">${cid.slice(0,30)}â€¦</code><br>Carpeta Drive: <strong>${APP_CONFIG.folderName}</strong><br>GestiÃ³n: ${Object.keys(GESTION).length} placas guardadas.`;
}
async function testSetup(){
  const el=document.getElementById('setupStatus');
  el.innerHTML='â³ Probando conexiÃ³n con Driveâ€¦';
  try{await loadGestionFromDrive();el.innerHTML='âœ… ConexiÃ³n correcta con Google Drive.';}
  catch(e){el.innerHTML='âŒ Error: '+h(e.message);}
}
function resetConfig(){if(!confirm('Â¿Borrar toda la configuraciÃ³n local?'))return;localStorage.clear();location.reload();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(tid){
  const a=S.analysis;if(!a)return;
  const map={nov:a.noVolvieron,rec:a.recurrentes,new:a.nuevos,par:a.parciales,mat:a.matrix};
  const data=map[tid];if(!data?.length){toast('Sin datos','err');return;}
  const base=['Placa','Propietario','Identificacion','Telefono','Correo','Clase','Marca','Linea','Modelo','Color','Ciudad'];
  const yH=[];a.ymaps.forEach(ym=>yH.push(`RevisÃ³_${ym.label}`,`Mes_${ym.label}`,`Venc_${ym.label}`,`Llamar_antes_${ym.label}`));
  yH.push('Estado_Gestion','Ultimo_Contacto','Ultima_Nota','Prox_Seguimiento','Venc_Override');
  const rows=data.map(r=>{
    const b=base.map(k=>`"${(r[k]||'').toString().replace(/"/g,'""')}"`);
    const y=[];a.ymaps.forEach((_,i)=>{
      const vd=r[`_v${i}`]?new Date(r[`_v${i}`]).toLocaleDateString('es-CO'):'';
      const ll=r[`_v${i}`]?llamarFechaLabel(r[`_v${i}`]):'';
      y.push(`"${r[`_p${i}`]||''}"`,`"${r[`_m${i}`]||''}"`,`"${vd}"`,`"${ll}"`);
    });
    const vEff=getVenc(r.Placa,r);const g=GESTION[r.Placa]||{};const ult=g.contactos?.[0];
    y.push(`"${g.estado||'pendiente'}"`,`"${ult?.fecha||''}"`,`"${(ult?.nota||'').replace(/"/g,'""')}"`,`"${ult?.proxFecha||''}"`,`"${g.vencOverride||''}"`);
    return[...b,...y].join(',');
  });
  const csv='\uFEFF'+[[...base,...yH].join(','),...rows].join('\n');
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  const a2=document.createElement('a');a2.href=url;a2.download=`CDA_${tid}_${new Date().toISOString().slice(0,10)}.csv`;a2.click();URL.revokeObjectURL(url);
  toast(`âœ… Exportado`,'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSyncState(state, label){
  const d=document.getElementById('syncDot');const l=document.getElementById('syncLabel');
  if(d){d.className='sync-dot '+state;}
  if(l)l.textContent=label||'';
}
function showSyncMsg(msg,type){
  const el=document.getElementById('syncMsg');if(!el)return;
  el.textContent=msg;el.className='sync-msg '+type;el.style.display='block';
  clearTimeout(el._t);el._t=setTimeout(()=>el.style.display='none',4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function h(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg,type=''){const e=document.getElementById('notif');e.textContent=msg;e.className='notif show'+(type?' '+type:'');clearTimeout(e._t);e._t=setTimeout(()=>e.classList.remove('show'),3600);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  // Always clear any stale token on load â€” user must click sign in
  localStorage.removeItem('cda_token');
  initGoogleAuth();
});
</script>
</body>
</html>
