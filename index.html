<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDA Colombia – Gestión Comercial v13</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,700;1,400&family=DM+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --am:#FCD116;--az:#003893;--ro:#CE1126;
  --am-l:#fffbe8;--az-l:#eef3ff;--ro-l:#fff5f5;
  --vd:#1a6b3c;--vd-l:#e8f7ee;
  --na:#c05e00;--na-l:#fff4e5;
  --mo:#5b21b6;--mo-l:#f3eeff;
  --teal:#0891b2;--teal-l:#ecfeff;
  --bg:#f0f2f8;--card:#ffffff;
  --txt:#0f172a;--txt2:#64748b;--txt3:#94a3b8;
  --bd:#e2e8f0;--bd2:#cbd5e1;
  --sh:0 1px 3px rgba(0,0,0,.04),0 4px 20px rgba(0,56,147,.06);
  --sh2:0 8px 40px rgba(0,0,0,.15);
  --r:14px;--r2:9px;
  --font:'DM Sans',sans-serif;--serif:'Libre Baskerville',serif;--mono:'IBM Plex Mono',monospace;
  --grad:linear-gradient(135deg,#003893 0%,#0055d4 100%);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--txt);min-height:100vh;line-height:1.5;-webkit-font-smoothing:antialiased}

/* FLAG */
.flag-stripe{height:8px;background:linear-gradient(to right,var(--am) 0 40%,var(--az) 40% 70%,var(--ro) 70% 100%)}

/* HEADER */
.header{background:var(--grad);color:#fff;padding:14px 28px;display:flex;align-items:center;gap:14px;position:relative;overflow:hidden;box-shadow:0 4px 20px rgba(0,56,147,.35)}
.header::before{content:'';position:absolute;right:-60px;top:-60px;width:240px;height:240px;background:rgba(255,255,255,.05);border-radius:50%}
.header::after{content:'';position:absolute;left:30%;bottom:-80px;width:180px;height:180px;background:rgba(255,255,255,.03);border-radius:50%}
.h-seal{width:46px;height:46px;background:var(--am);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:1;position:relative}
.h-copy{z-index:1}
.h-copy h1{font-family:var(--serif);font-size:clamp(15px,2vw,21px);font-weight:900;line-height:1}
.h-copy h1 span{color:var(--am)}
.h-copy p{font-size:10px;opacity:.65;margin-top:3px;font-weight:300;letter-spacing:.3px}
.flag-mini{margin-left:auto;width:38px;height:24px;border-radius:4px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 2px 8px rgba(0,0,0,.3);flex-shrink:0;z-index:1;position:relative}
.flag-mini div:nth-child(1){flex:2;background:var(--am)}
.flag-mini div:nth-child(2){flex:1;background:var(--az)}
.flag-mini div:nth-child(3){flex:1;background:var(--ro)}

/* AUTH BAR */
.auth-bar{background:var(--card);border-bottom:1px solid var(--bd);padding:8px 28px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;box-shadow:0 1px 0 var(--bd)}
.auth-avatar{width:32px;height:32px;border-radius:50%;border:2px solid var(--vd)}
.auth-name{font-size:12px;font-weight:600;color:var(--txt)}
.auth-email{font-size:10px;color:var(--txt2)}
.btn-auth{display:flex;align-items:center;gap:7px;padding:8px 16px;border-radius:var(--r);font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;border:none;transition:all .2s}
.btn-signin{background:#fff;color:var(--txt);border:1.5px solid var(--bd);box-shadow:0 1px 4px rgba(0,0,0,.08)}
.btn-signin:hover{border-color:var(--az);box-shadow:0 2px 8px rgba(0,56,147,.15)}
.btn-signout{background:var(--ro-l);color:var(--ro);border:1.5px solid #fca5a5;font-size:11px;padding:5px 12px}
.auth-status{font-size:11px;padding:4px 10px;border-radius:20px;font-weight:600}
.auth-status.ok{background:var(--vd-l);color:var(--vd)}
.auth-status.warn{background:var(--na-l);color:var(--na)}
.auth-status.err{background:var(--ro-l);color:var(--ro)}
.drive-info{font-size:10px;color:var(--txt2);display:flex;align-items:center;gap:4px}

/* MAIN */
.main{max-width:1300px;margin:0 auto;padding:24px 20px 72px}

/* LOGIN SCREEN */
.login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center;gap:20px}
.login-card{background:var(--card);border-radius:16px;padding:40px 36px;max-width:420px;width:100%;box-shadow:var(--sh2)}
.login-flag{display:flex;gap:0;border-radius:8px;overflow:hidden;width:80px;height:50px;margin:0 auto 20px;box-shadow:var(--sh)}
.login-flag div:nth-child(1){flex:2;background:var(--am)}
.login-flag div:nth-child(2){flex:1;background:var(--az)}
.login-flag div:nth-child(3){flex:1;background:var(--ro)}
.login-title{font-family:var(--serif);font-size:26px;font-weight:900;color:var(--az);margin-bottom:4px}
.login-sub{font-size:12px;color:var(--txt2);margin-bottom:28px;line-height:1.6}
.btn-google{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:13px;border-radius:var(--r);border:1.5px solid var(--bd);background:#fff;font-family:var(--font);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--txt);box-shadow:0 1px 4px rgba(0,0,0,.08)}
.btn-google:hover{border-color:var(--az);box-shadow:0 4px 16px rgba(0,56,147,.15);transform:translateY(-1px)}
.btn-google svg{flex-shrink:0}
.login-note{font-size:10px;color:var(--txt3);margin-top:14px;line-height:1.6}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;gap:6px;margin-bottom:16px;flex-wrap:wrap;background:var(--card);border-radius:var(--r);padding:10px 14px;box-shadow:var(--sh)}
.tbtn{display:flex;align-items:center;gap:5px;padding:7px 13px;border-radius:var(--r2);font-family:var(--font);font-size:11px;font-weight:600;cursor:pointer;border:1.5px solid var(--bd);background:var(--card);color:var(--txt2);transition:all .18s}
.tbtn:hover{border-color:var(--az);color:var(--az);background:var(--az-l)}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--bd2);display:inline-block;flex-shrink:0}
.sync-dot.syncing{background:var(--am);animation:pulse .8s infinite}
.sync-dot.synced{background:var(--vd)}
.sync-dot.error{background:var(--ro)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* TODAY BANNER */
.today-banner{display:none;align-items:center;gap:14px;background:var(--az);color:#fff;border-radius:var(--r);padding:14px 20px;margin-bottom:16px;animation:slideDown .3s ease}
@keyframes slideDown{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.tb-btn{margin-left:auto;background:var(--am);color:var(--az);border:none;border-radius:var(--r2);padding:7px 14px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0}
.tb-btn:hover{background:#ffe066}

/* UPLOAD / MONTH PANEL */
.upload{background:var(--card);border-radius:var(--r);border:2px dashed var(--bd);padding:24px;margin-bottom:18px;box-shadow:var(--sh)}
.upload-h{font-family:var(--serif);font-size:17px;color:var(--az);margin-bottom:3px}
.upload-s{font-size:11px;color:var(--txt2);margin-bottom:18px}
.sync-msg{font-size:11px;font-weight:600;padding:5px 12px;border-radius:6px;margin-bottom:12px;display:none}
.sync-msg.ok{background:var(--vd-l);color:var(--vd)}
.sync-msg.warn{background:var(--na-l);color:var(--na)}

/* MONTHS GRID */
.months-section{background:var(--card);border-radius:var(--r);padding:20px;margin-bottom:18px;box-shadow:var(--sh)}
.ms-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px}
.ms-title{font-family:var(--serif);font-size:15px;color:var(--az);font-weight:700}
.months-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px}
.month-chip{border:1.5px solid var(--bd);border-radius:var(--r2);padding:10px 12px;cursor:pointer;transition:all .18s;background:var(--bg);position:relative}
.month-chip:hover{border-color:var(--az);background:var(--az-l)}
.month-chip.selected{border-color:var(--az);background:var(--az-l)}
.month-chip.loaded{border-color:var(--vd);background:var(--vd-l)}
.month-chip.loaded.selected{border-color:var(--az);background:var(--az-l)}
.mc-year{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.4px}
.mc-month{font-size:13px;font-weight:700;color:var(--txt)}
.mc-count{font-size:10px;color:var(--txt2);margin-top:2px}
.mc-badge{position:absolute;top:6px;right:6px;width:8px;height:8px;border-radius:50%;background:var(--vd)}
.month-chip:not(.loaded) .mc-badge{display:none}
.mc-sel-badge{position:absolute;top:6px;right:6px;width:16px;height:16px;border-radius:50%;background:var(--az);display:none;align-items:center;justify-content:center;font-size:9px;color:#fff;font-weight:700}
.month-chip.selected .mc-sel-badge{display:flex}
.month-chip.selected .mc-badge{display:none}
.no-months{text-align:center;padding:24px;color:var(--txt2);font-size:12px;grid-column:1/-1}

/* YEAR SLOTS (upload) */
.yg{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px;margin-bottom:16px}
.yc{border:2px solid var(--bd);border-radius:var(--r);padding:13px;background:var(--bg);transition:all .2s}
.yc.loaded{border-color:var(--vd);background:var(--vd-l)}
.yc-head{display:flex;align-items:center;gap:6px;margin-bottom:9px}
.yb{background:var(--az);color:#fff;border-radius:20px;padding:2px 10px;font-size:11px;font-weight:700}
.yc.loaded .yb{background:var(--vd)}
.yi{font-size:11px;border:1.5px solid var(--bd);border-radius:6px;padding:2px 6px;font-family:var(--font);width:64px;outline:none}
.yr-btn{margin-left:auto;cursor:pointer;color:var(--ro);font-size:12px;opacity:.5;border:none;background:none}
.yr-btn:hover{opacity:1}
.fd{border:1.5px dashed var(--bd);border-radius:var(--r2);padding:10px;text-align:center;font-size:11px;color:var(--txt2);cursor:pointer;background:#fff;transition:all .18s;display:block}
.fd:hover{border-color:var(--az);color:var(--az);background:var(--az-l)}
.fd input{display:none}
.fst{margin-top:6px;font-size:10px;font-weight:600;color:var(--vd);display:none}
.yc.loaded .fst{display:block}
.mp{margin-top:8px;display:none}
.yc.loaded .mp{display:block}
.mlbl{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.mcs{display:flex;flex-wrap:wrap;gap:3px}
.chip{padding:2px 8px;border-radius:20px;font-size:10px;font-weight:600;cursor:pointer;border:1.5px solid var(--bd);background:#fff;color:var(--txt2);transition:all .14s;user-select:none}
.chip:hover{border-color:var(--az);color:var(--az)}
.chip.on{background:var(--az);color:#fff;border-color:var(--az)}
.macts{display:flex;gap:5px;margin-top:4px}
.mact{font-size:9px;font-weight:600;cursor:pointer;background:none;border:none;color:var(--txt2);text-decoration:underline;padding:0}
.mact:hover{color:var(--az)}
.add-slot{border:2px dashed var(--am);border-radius:var(--r);padding:13px;background:var(--am-l);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;font-size:12px;font-weight:700;color:#7a5200;transition:all .18s}
.add-slot:hover{background:var(--am)}

/* ANALYZE BTN */
.btn-analyze{background:var(--az);color:#fff;border:none;border-radius:var(--r);padding:11px 26px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all .2s;box-shadow:0 3px 12px rgba(0,56,147,.22)}
.btn-analyze:hover:not(:disabled){background:#0044b3;transform:translateY(-1px)}
.btn-analyze:disabled{background:var(--bd2);color:var(--txt3);box-shadow:none;cursor:not-allowed}
.loading-row{display:none;align-items:center;gap:10px}
.prog{flex:1;height:4px;background:var(--bd);border-radius:2px;overflow:hidden;min-width:80px}
.prog-fill{height:100%;background:var(--am);border-radius:2px;animation:prog 1.3s ease infinite;width:35%}
@keyframes prog{0%{margin-left:0;width:30%}50%{margin-left:30%;width:40%}100%{margin-left:65%;width:30%}}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:10px;margin-bottom:16px}
.kpi{background:var(--card);border-radius:var(--r);padding:16px 14px;box-shadow:var(--sh);position:relative;overflow:hidden;animation:fadeUp .4s ease both;transition:transform .18s,box-shadow .18s;cursor:default}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--az)}
.kpi:nth-child(2)::before{background:var(--vd)}
.kpi:nth-child(3)::before{background:var(--ro)}
.kpi:nth-child(4)::before{background:var(--am)}
.kpi:nth-child(5)::before{background:var(--na)}
.kpi-lbl{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.kpi-val{font-family:var(--serif);font-size:26px;font-weight:900;line-height:1;color:var(--az)}
.kpi:nth-child(2) .kpi-val{color:var(--vd)}
.kpi:nth-child(3) .kpi-val{color:var(--ro)}
.kpi:nth-child(4) .kpi-val{color:#7a5200}
.kpi:nth-child(5) .kpi-val{color:var(--na)}
.kpi-sub{font-size:10px;color:var(--txt3);margin-top:2px}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* CTX BAR */
.ctx-bar{background:var(--az-l);border:1px solid rgba(0,56,147,.15);border-radius:var(--r2);padding:7px 13px;margin-bottom:12px;font-size:11px;color:var(--az);display:flex;align-items:center;gap:7px;flex-wrap:wrap}

/* TABS */
.tabs{display:flex;gap:2px;background:var(--card);border-radius:var(--r) var(--r) 0 0;padding:7px 7px 0;border-bottom:2px solid var(--az);flex-wrap:wrap}
.tab{padding:7px 14px;border:none;border-radius:6px 6px 0 0;background:transparent;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:500;color:var(--txt2);transition:all .14s;display:flex;align-items:center;gap:4px;white-space:nowrap}
.tab:hover{background:var(--az-l);color:var(--az)}
.tab.on{background:var(--az);color:#fff;font-weight:700}
.tab.urgent.on{background:var(--ro);color:#fff}
.tab.urgent{color:var(--ro)}
.tab-n{background:rgba(255,255,255,.22);border-radius:20px;padding:1px 6px;font-size:10px;font-weight:700}
.tab:not(.on) .tab-n{background:var(--bd);color:var(--txt2)}
.panel{background:var(--card);border-radius:0 0 var(--r) var(--r);box-shadow:var(--sh);overflow:hidden;min-height:180px}

/* FILTER BAR */
.fbar{display:flex;align-items:center;gap:7px;padding:11px 16px;background:var(--bg);border-bottom:1px solid var(--bd);flex-wrap:wrap}
.fbar-lbl{font-size:10px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.3px}
.fbar input,.fbar select{border:1.5px solid var(--bd);border-radius:var(--r2);padding:5px 9px;font-family:var(--font);font-size:11px;background:#fff;color:var(--txt);outline:none;transition:border-color .18s}
.fbar input{width:160px}
.fbar input:focus,.fbar select:focus{border-color:var(--az)}
.fbar-cnt{font-size:11px;font-weight:600;color:var(--txt2);white-space:nowrap}
.btn-csv{background:var(--vd);color:#fff;border:none;border-radius:var(--r2);padding:5px 11px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;margin-left:auto;transition:all .18s}
.btn-csv:hover{background:#145c34}

/* TABLE */
.tbl-wrap{overflow:auto;max-height:520px}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:var(--az);color:#fff;padding:9px 13px;text-align:left;font-weight:600;font-size:11px;white-space:nowrap;position:sticky;top:0;z-index:2;letter-spacing:.2px}
tbody tr{border-bottom:1px solid var(--bd);transition:background .1s}
tbody tr:hover{background:var(--az-l)}
tbody td{padding:10px 13px;white-space:nowrap;max-width:190px;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
.td-placa{font-weight:700;color:var(--az);font-size:13px;letter-spacing:.5px}
.td-nombre{font-weight:500}
.td-tel{font-family:monospace;font-size:13px;font-weight:700;color:var(--vd)}

/* PILLS */
.pill{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
.p-az{background:var(--az-l);color:var(--az)}
.p-vd{background:var(--vd-l);color:var(--vd)}
.p-ro{background:var(--ro-l);color:var(--ro)}
.p-am{background:var(--am-l);color:#7a5200}
.p-na{background:var(--na-l);color:var(--na)}
.p-mo{background:var(--mo-l);color:var(--mo)}

/* VENCIMIENTO */
.venc{display:inline-flex;flex-direction:column;gap:1px}
.venc-fecha{font-size:11px;font-weight:600}
.venc-dias{font-size:10px;font-weight:700;border-radius:20px;padding:1px 7px;display:inline-block;margin-top:2px}
.v-vencido{background:var(--ro-l);color:var(--ro)}
.v-urgente{background:var(--ro-l);color:var(--ro)}
.v-pronto{background:var(--na-l);color:var(--na)}
.v-ok{background:var(--vd-l);color:var(--vd)}
.venc-edit-wrap{display:flex;flex-direction:column;gap:2px}
.venc-estimada-badge{display:inline-block;background:#fff7ed;color:#c2410c;border:1px solid #fdba74;border-radius:4px;padding:1px 6px;font-size:9px;font-weight:700}
.venc-manual-badge{background:var(--mo-l);color:var(--mo);border:1.5px dashed var(--mo);border-radius:6px;padding:1px 6px;font-size:9px;font-weight:700;display:inline-block}
.btn-edit-venc{background:none;border:none;font-size:10px;color:var(--txt3);cursor:pointer;text-decoration:underline;padding:0;font-family:var(--font)}
.btn-edit-venc:hover{color:var(--mo)}
.venc-override-row{display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap}
.venc-override-row input{border:1.5px solid var(--mo);border-radius:6px;padding:4px 8px;font-family:var(--font);font-size:11px;outline:none;background:var(--mo-l)}
.venc-override-row button{padding:4px 10px;border-radius:6px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;border:none}
.btn-save-venc{background:var(--mo);color:#fff}

/* CALL BTNS */
.call-row{display:flex;align-items:center;gap:5px}
.btn-call{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;text-decoration:none;border:none;cursor:pointer;font-family:var(--font);transition:all .14s;white-space:nowrap}
.btn-tel{background:var(--vd-l);color:var(--vd);border:1px solid #86efac}
.btn-tel:hover{background:var(--vd);color:#fff}
.btn-wa{background:#e7fce8;color:#128c7e;border:1px solid #86efac}
.btn-wa:hover{background:#25d366;color:#fff}

/* GESTIÓN BADGE */
.gb{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;cursor:pointer;transition:all .16s;border:1.5px solid transparent}
.gb-pte{background:#f4f4f5;color:var(--txt2);border-color:var(--bd)}
.gb-pte:hover{border-color:var(--az);color:var(--az)}
.gb-gest{background:var(--am-l);color:#7a5200;border-color:var(--am)}
.gb-cont{background:var(--vd-l);color:var(--vd);border-color:#86efac}
.gb-agend{background:var(--az-l);color:var(--az);border-color:#93c5fd}
.gb-noint{background:var(--ro-l);color:var(--ro);border-color:#fca5a5}

/* CHECKS */
.chk{color:var(--vd);font-size:14px;font-weight:900}
.dash{color:var(--bd2);font-size:12px}

/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:var(--txt2)}
.empty-ico{font-size:44px;margin-bottom:8px}
.empty h3{font-family:var(--serif);color:var(--az);font-size:17px;margin-bottom:4px}
.empty p{font-size:12px}

/* CHARTS */
.charts{padding:20px;display:flex;flex-direction:column;gap:16px}
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:640px){.chart-grid{grid-template-columns:1fr}}
.cc{background:var(--bg);border-radius:var(--r);padding:14px}
.cc h3{font-family:var(--serif);font-size:13px;color:var(--az);margin-bottom:10px;font-weight:700}
.bar-row{display:flex;align-items:center;gap:7px;margin-bottom:6px;font-size:11px}
.bar-lbl{width:100px;flex-shrink:0;color:var(--txt2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-trk{flex:1;background:var(--bd);border-radius:20px;height:9px;overflow:hidden}
.bar-fill{height:100%;border-radius:20px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.bar-cnt{width:28px;text-align:right;font-weight:700;color:var(--txt)}
.stat-alerts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.alert-card{border-radius:var(--r);padding:14px;text-align:center}
.alert-card.vencidos{background:var(--ro-l);border:1.5px solid #fca5a5}
.alert-card.proximos{background:var(--na-l);border:1.5px solid #fbbf24}
.alert-card .ac-num{font-family:var(--serif);font-size:34px;font-weight:900}
.alert-card.vencidos .ac-num{color:var(--ro)}
.alert-card.proximos .ac-num{color:var(--na)}
.alert-card .ac-lbl{font-size:11px;font-weight:600}
.alert-card.vencidos .ac-lbl{color:var(--ro)}
.alert-card.proximos .ac-lbl{color:var(--na)}
.yr-stat{background:var(--card);border-radius:var(--r);padding:16px;box-shadow:var(--sh);border-top:3px solid var(--az)}

/* HOY */
.hoy-section{padding:18px}
.hoy-head{font-family:var(--serif);font-size:14px;color:var(--az);margin-bottom:12px;font-weight:700}
.hoy-block{border-radius:var(--r);padding:13px;margin-bottom:14px;border:1.5px solid}
.hoy-block.seguimientos{background:var(--vd-l);border-color:#86efac}
.hoy-block.vencen{background:var(--na-l);border-color:#fbbf24}
.hoy-block.empty-block{background:var(--bg);border-color:var(--bd);text-align:center;color:var(--txt2);font-size:12px;padding:16px}
.hoy-block-title{font-size:12px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:5px}
.hoy-block.seguimientos .hoy-block-title{color:var(--vd)}
.hoy-block.vencen .hoy-block-title{color:var(--na)}

/* MODAL */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.42);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.modal-bg.show{display:flex}
.modal{background:var(--card);border-radius:16px;padding:22px;max-width:520px;width:94vw;max-height:90vh;overflow-y:auto;position:relative;box-shadow:var(--sh2);animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(6px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal h3{font-family:var(--serif);font-size:17px;color:var(--az);margin-bottom:10px;font-weight:900;padding-right:22px}
.mcl{position:absolute;top:14px;right:14px;background:none;border:none;font-size:17px;cursor:pointer;color:var(--txt2);transition:color .14s}
.mcl:hover{color:var(--ro)}
.contact-cards{display:flex;gap:9px;margin-bottom:12px;flex-wrap:wrap}
.contact-card{flex:1;min-width:145px;border-radius:var(--r);padding:12px;text-align:center}
.cc-tel{background:var(--vd-l);border:1.5px solid #86efac}
.cc-wa{background:#e7fce8;border:1.5px solid #a7f3d0}
.cc-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px}
.cc-tel .cc-lbl{color:var(--vd)}
.cc-wa .cc-lbl{color:#128c7e}
.cc-num{font-family:monospace;font-size:18px;font-weight:700;letter-spacing:.5px;margin-bottom:7px}
.cc-tel .cc-num{color:var(--vd)}
.cc-wa .cc-num{color:#128c7e}
.venc-info{background:var(--am-l);border:1.5px solid var(--am);border-radius:var(--r2);padding:8px 12px;font-size:11px;margin-bottom:12px;display:flex;align-items:flex-start;gap:7px}
.fr{display:flex;flex-direction:column;gap:3px;margin-bottom:9px}
.fr label{font-size:10px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.3px}
.fr input,.fr select,.fr textarea{border:1.5px solid var(--bd);border-radius:var(--r2);padding:7px 9px;font-family:var(--font);font-size:12px;color:var(--txt);outline:none;transition:border-color .18s;background:#fff}
.fr input:focus,.fr select:focus,.fr textarea:focus{border-color:var(--az)}
.fr textarea{resize:vertical;min-height:60px}
.f2col{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.btn-save{background:var(--az);color:#fff;border:none;border-radius:var(--r);padding:10px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;width:100%;margin-top:4px;transition:all .18s}
.btn-save:hover{background:#0044b3}
.hist-wrap{border-top:1px solid var(--bd);margin-top:12px;padding-top:10px}
.hist-wrap h4{font-size:11px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.4px;margin-bottom:7px}
.hi{background:var(--bg);border-radius:var(--r2);padding:8px 11px;margin-bottom:5px;border-left:3px solid var(--az)}
.hi.llamada{border-left-color:var(--vd)}
.hi.whatsapp{border-left-color:#25d366}
.hi.sms{border-left-color:var(--na)}
.hi.visita{border-left-color:var(--mo)}
.hi-head{display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-bottom:2px}
.hi-tipo{font-size:10px;font-weight:700;text-transform:uppercase}
.hi-res{font-size:9px;font-weight:700;padding:1px 6px;border-radius:20px}
.hi-res.ok{background:var(--vd-l);color:var(--vd)}
.hi-res.bad{background:var(--ro-l);color:var(--ro)}
.hi-res.neutral{background:var(--bg);color:var(--txt2);border:1px solid var(--bd)}
.hi-fecha{font-size:9px;color:var(--txt3);margin-left:auto}
.hi-prox{font-size:9px;color:var(--na);font-weight:600}
.hi-nota{font-size:11px;color:var(--txt);margin-top:2px;line-height:1.4}
.hi-del{background:none;border:none;cursor:pointer;color:var(--txt3);font-size:11px;padding:0 2px;transition:color .14s}
.hi-del:hover{color:var(--ro)}

/* SETUP MODAL */
.setup-modal{max-width:580px}
.setup-steps{display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap}
.setup-step{padding:5px 11px;border:1.5px solid var(--bd);border-radius:20px;font-family:var(--font);font-size:11px;font-weight:600;cursor:pointer;background:#fff;color:var(--txt2);transition:all .16s}
.setup-step:hover{border-color:var(--az);color:var(--az)}
.setup-step.on{background:var(--az);color:#fff;border-color:var(--az)}
.info-box{background:var(--az-l);border-radius:var(--r2);padding:11px 13px;margin-bottom:12px;font-size:11px;color:var(--az);line-height:1.7}
.info-box a{color:var(--az);font-weight:700}
.info-box code{background:rgba(0,56,147,.12);padding:1px 5px;border-radius:4px;font-size:10px}
.code-block{background:#1e1e2e;border-radius:8px;padding:12px;margin-bottom:10px;position:relative}
.code-block pre{color:#cdd6f4;font-family:monospace;font-size:10px;white-space:pre-wrap;margin:0;line-height:1.6}
.btn-copy-code{position:absolute;top:7px;right:7px;background:var(--az);color:#fff;border:none;border-radius:5px;padding:3px 9px;font-size:10px;font-weight:700;cursor:pointer}
.btn-secondary{width:100%;margin-top:7px;background:var(--ro-l);color:var(--ro);border:1.5px solid #fca5a5;border-radius:var(--r);padding:8px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer}
.btn-secondary:hover{background:var(--ro);color:#fff}
.btn-ghost{background:var(--bg);color:var(--txt2);border:1.5px solid var(--bd);border-radius:var(--r);padding:8px;font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:all .16s}
.btn-ghost:hover{border-color:var(--az);color:var(--az)}
.tpl-vars{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:12px}
.tpl-var{background:var(--bg);border:1px solid var(--bd);border-radius:4px;padding:2px 6px;font-size:10px;font-family:monospace;color:var(--txt2)}

/* NOTIF */
.notif{position:fixed;bottom:16px;right:16px;background:var(--az);color:#fff;padding:9px 15px;border-radius:var(--r);font-size:12px;font-weight:500;box-shadow:var(--sh2);transform:translateY(80px);transition:transform .3s cubic-bezier(.4,0,.2,1);z-index:200;max-width:280px;line-height:1.4}
.notif.show{transform:translateY(0)}
.notif.ok{background:var(--vd)}
.notif.err{background:var(--ro)}

footer{text-align:center;padding:12px;font-size:10px;color:var(--txt3)}
footer em{color:var(--az);font-style:normal;font-weight:600}
@media(max-width:540px){
  .header{padding:10px 14px}
  .main{padding:12px 10px 40px}
  .stat-alerts{grid-template-columns:1fr}
}

/* ── PANEL HEADERS (descripción por pestaña) ── */
.panel-hdr{background:linear-gradient(135deg,var(--az-l) 0%,#f0f4ff 100%);border-bottom:1px solid rgba(0,56,147,.12);padding:11px 16px;display:flex;align-items:flex-start;gap:10px}
.panel-hdr-ico{font-size:24px;flex-shrink:0;margin-top:1px}
.panel-hdr-copy h4{font-size:12px;font-weight:700;color:var(--az);margin-bottom:2px}
.panel-hdr-copy p{font-size:11px;color:var(--txt2);line-height:1.5}
/* ── FIDELIZACION ── */
.fidel-section{padding:16px;display:flex;flex-direction:column;gap:12px}
.fidel-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:6px}
.fidel-kpi{border-radius:var(--r2);padding:12px;text-align:center;border-top:3px solid}
.fidel-kpi.g2{background:#fef9ee;border-color:#F59E0B}
.fidel-kpi.g3{background:#fef3c7;border-color:#D97706}
.fidel-kpi.g4{background:#dbeafe;border-color:#2563EB}
.fidel-kpi.g5{background:#dcfce7;border-color:var(--vd)}
.fidel-kpi-val{font-family:var(--serif);font-size:28px;font-weight:900;color:var(--txt)}
.fidel-kpi-lbl{font-size:10px;color:var(--txt2);margin-top:2px;font-weight:600}
.fidel-badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
.fidel-badge.g2{background:#fef9ee;color:#92400e;border:1px solid #F59E0B}
.fidel-badge.g3{background:#fef3c7;color:#92400e;border:1px solid #D97706}
.fidel-badge.g4{background:#dbeafe;color:#1e40af;border:1px solid #2563EB}
.fidel-badge.g5{background:#dcfce7;color:#14532d;border:1px solid var(--vd)}
/* ── AGENDA ── */
.agenda-section{padding:16px}
.agenda-day{border-radius:var(--r2);border:1.5px solid var(--bd);overflow:hidden;margin-bottom:10px}
.agenda-day-hdr{background:var(--az);color:#fff;padding:8px 14px;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
.agenda-day-hdr.today{background:linear-gradient(90deg,var(--az) 0%,var(--vd) 100%)}
.agenda-cita{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border-bottom:1px solid var(--bd);transition:background .12s;cursor:pointer}
.agenda-cita:hover{background:var(--az-l)}
.agenda-cita:last-child{border-bottom:none}
.agenda-cita-ico{font-size:22px;flex-shrink:0}
.agenda-cita-info{flex:1;min-width:0}
.agenda-cita-placa{font-weight:700;color:var(--az);font-size:12px;letter-spacing:.3px}
.agenda-cita-nombre{font-size:11px;font-weight:500}
.agenda-cita-tel{font-size:10px;color:var(--vd);font-family:monospace;margin-top:1px}
.agenda-cita-nota{font-size:10px;color:var(--txt2);margin-top:2px;white-space:normal;line-height:1.4}
.agenda-cita-actions{display:flex;flex-direction:column;gap:4px;flex-shrink:0;align-items:flex-end}
.agenda-empty{text-align:center;padding:32px;color:var(--txt3);font-size:13px}
/* ── STRATEGY ── */
.strategy-panel{border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)}
.strategy-header{background:linear-gradient(135deg,var(--az) 0%,#0055cc 100%);color:#fff;padding:18px 22px}
.strategy-header h3{font-family:var(--serif);font-size:18px;font-weight:900;margin-bottom:2px}
.strategy-header p{font-size:11px;opacity:.75}
.strategy-body{background:var(--card);padding:18px;display:flex;flex-direction:column;gap:14px}
.strategy-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:10px}
.strategy-card{border-radius:var(--r2);padding:13px;border-left:4px solid}
.strategy-card.s1{background:var(--az-l);border-color:var(--az)}
.strategy-card.s2{background:var(--vd-l);border-color:var(--vd)}
.strategy-card.s3{background:var(--am-l);border-color:#D97706}
.strategy-card.s4{background:var(--mo-l);border-color:var(--mo)}
.strategy-card h4{font-size:11px;font-weight:700;margin-bottom:5px;color:var(--txt)}
.strategy-card p{font-size:10px;color:var(--txt2);line-height:1.5}
.strategy-card ul{font-size:10px;color:var(--txt2);line-height:1.7;padding-left:14px;margin-top:4px}
.script-box{background:var(--bg);border-radius:var(--r2);padding:14px;border-left:4px solid var(--az)}
.script-box h4{font-size:11px;font-weight:700;color:var(--az);margin-bottom:10px}
.script-step{display:flex;gap:9px;margin-bottom:9px;font-size:11px;align-items:flex-start}
.script-n{width:22px;height:22px;border-radius:50%;background:var(--az);color:#fff;font-weight:700;font-size:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;margin-top:1px}
.script-text{color:var(--txt2);line-height:1.55;flex:1}
.script-text strong{color:var(--txt)}
.objection-box{background:var(--ro-l);border-radius:var(--r2);padding:13px;border-left:4px solid var(--ro)}
.objection-box h4{font-size:11px;font-weight:700;color:var(--ro);margin-bottom:8px}
.objection-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:10px;margin-bottom:5px;padding-bottom:5px;border-bottom:1px solid rgba(206,17,38,.12)}
.objection-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.obj-q{color:var(--ro);font-weight:600} .obj-a{color:var(--txt2)}
/* ── WA ANTI-SPAM ── */
.wa-variants-box{background:var(--vd-l);border:1.5px solid var(--vd);border-radius:var(--r2);padding:10px 12px;margin-bottom:10px;font-size:11px}
.wa-variants-box h5{font-weight:700;color:var(--vd);margin-bottom:6px}
.wa-variant-pill{display:inline-block;background:#fff;border:1px solid #86efac;border-radius:20px;padding:2px 9px;font-size:10px;margin:2px;color:var(--vd);font-weight:600}
/* ── CHARTS ── */
.chart-section{display:flex;flex-direction:column;gap:14px}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:620px){.chart-row{grid-template-columns:1fr}.objection-row{grid-template-columns:1fr}}
.cc{background:var(--bg);border-radius:var(--r);padding:14px}
.cc-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.cc h3{font-family:var(--serif);font-size:12px;color:var(--az);font-weight:700}
.cc-sub{font-size:10px;color:var(--txt3)}
.bar-row{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:10px}
.bar-lbl{width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--txt2);flex-shrink:0}
.bar-trk{flex:1;height:11px;background:var(--bd);border-radius:6px;overflow:hidden}
.bar-fill{height:100%;border-radius:6px;transition:width .6s cubic-bezier(.4,0,.2,1)}
.bar-cnt{font-weight:700;color:var(--txt);font-size:10px;min-width:28px;text-align:right}
/* stat alerts grid */
.stat-alerts{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px}
.alert-card{border-radius:var(--r);padding:13px 16px;text-align:center}
.alert-card.vencidos{background:var(--ro-l);border:2px solid var(--ro)}
.alert-card.proximos{background:var(--na-l);border:2px solid var(--na)}
.alert-card.ret-ok{background:var(--vd-l);border:2px solid var(--vd)}
.alert-card.nuevos{background:var(--mo-l);border:2px solid var(--mo)}
.ac-num{font-family:var(--serif);font-size:30px;font-weight:900}
.ac-lbl{font-size:10px;font-weight:600;color:var(--txt2);margin-top:2px}
.yr-stat{background:var(--card);border-radius:var(--r);padding:15px;border-top:4px solid var(--az);box-shadow:var(--sh)}

/* ── CALENDAR ── */
.cal-wrap{padding:16px}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.cal-nav-btn{background:var(--az-l);color:var(--az);border:none;border-radius:var(--r2);padding:6px 14px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;transition:all .16s}
.cal-nav-btn:hover{background:var(--az);color:#fff}
.cal-title{font-family:var(--serif);font-size:17px;font-weight:900;color:var(--az)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-dow{text-align:center;font-size:10px;font-weight:700;color:var(--txt3);padding:4px 0;text-transform:uppercase}
.cal-cell{min-height:52px;border-radius:var(--r2);border:1.5px solid var(--bd);padding:5px 6px;cursor:pointer;transition:all .16s;background:var(--card);position:relative}
.cal-cell:hover{border-color:var(--az);background:var(--az-l)}
.cal-cell.today{border-color:var(--az);background:var(--az-l);font-weight:700}
.cal-cell.today .cal-day{color:var(--az);font-weight:900}
.cal-cell.other-month{background:var(--bg);opacity:.5}
.cal-cell.has-events{border-color:var(--vd);background:var(--vd-l)}
.cal-cell.has-urgent{border-color:var(--ro);background:var(--ro-l)}
.cal-cell.has-agendado{border-color:var(--az);background:#e8f0ff}
.cal-day{font-size:12px;font-weight:600;color:var(--txt)}
.cal-dots{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px}
.cal-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.cal-dot.urgente{background:var(--ro)}
.cal-dot.agendado{background:var(--az)}
.cal-dot.seguimiento{background:var(--vd)}
.cal-count{font-size:9px;font-weight:700;color:var(--txt2);margin-top:2px}
.cal-cell.selected-day{border-color:var(--mo)!important;background:var(--mo-l)!important;box-shadow:0 0 0 2px var(--mo)}
.cal-detail{background:var(--card);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-top:12px;border-top:3px solid var(--az)}
.cal-detail-title{font-family:var(--serif);font-size:14px;font-weight:900;color:var(--az);margin-bottom:12px;display:flex;align-items:center;gap:7px}

/* ── YA REALIZO REVISION (2026 badge) ── */
.badge-realizo{display:inline-flex;align-items:center;gap:4px;background:#dcfce7;color:#15803d;border:1.5px solid #86efac;border-radius:20px;padding:2px 9px;font-size:10px;font-weight:700}
.badge-encuesta{display:inline-flex;align-items:center;gap:4px;background:#dbeafe;color:#1d4ed8;border:1.5px solid #93c5fd;border-radius:20px;padding:2px 9px;font-size:10px;font-weight:700;cursor:pointer;transition:all .14s}
.badge-encuesta:hover{background:#1d4ed8;color:#fff}
.btn-google-review{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#4285F4,#34A853);color:#fff;border:none;border-radius:var(--r2);padding:6px 14px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;text-decoration:none;transition:all .18s;box-shadow:0 2px 8px rgba(66,133,244,.3)}
.btn-google-review:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(66,133,244,.4)}
.row-realizo{background:linear-gradient(90deg,rgba(220,252,231,.6) 0%,transparent 100%)}
.row-realizo td{opacity:.75}

/* ── NUEVO CLIENTE MANUAL ── */
.btn-nuevo-cliente{background:var(--vd);color:#fff;border:none;border-radius:var(--r2);padding:7px 14px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .18s}
.btn-nuevo-cliente:hover{background:#145c34}

/* ── REDESIGN general ── */
.kpi:hover{transform:translateY(-2px);box-shadow:var(--sh2)}
.upload{background:var(--card);border-radius:var(--r);border:2px dashed var(--bd2);padding:22px;margin-bottom:16px;box-shadow:var(--sh);transition:border-color .18s}
.upload:focus-within{border-color:var(--az)}
.months-section{background:var(--card);border-radius:var(--r);padding:18px;margin-bottom:16px;box-shadow:var(--sh)}
.panel{border-radius:0 0 var(--r) var(--r);box-shadow:var(--sh);overflow:hidden;min-height:200px}
.tabs{background:var(--card);border-radius:var(--r) var(--r) 0 0;padding:8px 8px 0;border-bottom:2px solid var(--az);flex-wrap:wrap;overflow-x:auto}
.tab{font-size:11px;border-radius:6px 6px 0 0;padding:7px 12px}

/* ── WA COPY BUTTON — unicode-safe ── */
.btn-wa-copy{display:inline-flex;align-items:center;gap:5px;background:var(--vd-l);color:var(--vd);border:1.5px solid #86efac;border-radius:var(--r2);padding:5px 11px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;transition:all .16s}
.btn-wa-copy:hover{background:var(--vd);color:#fff}
.wa-msg-preview{background:#e7fce8;border-radius:var(--r2);padding:10px 12px;font-size:11px;line-height:1.6;color:var(--txt);border-left:3px solid #25d366;margin-bottom:8px;white-space:pre-wrap;word-break:break-word}

/* ══ V12 LAYOUT ══════════════════════════════════════════ */
body{background:#f0f2f8}

/* FLAG */
.flag-stripe{height:5px;background:linear-gradient(to right,var(--am) 0 40%,var(--az) 40% 70%,var(--ro) 70% 100%)}

/* HEADER v12 */
.header{background:#fff;color:var(--txt);padding:0;display:grid;grid-template-columns:auto 1fr auto;align-items:stretch;border-bottom:2px solid var(--az);box-shadow:0 2px 12px rgba(0,56,147,.08)}
.header::before,.header::after{display:none}
.h-logo-zone{background:var(--az);padding:12px 28px;display:flex;align-items:center;gap:12px;clip-path:polygon(0 0,100% 0,92% 100%,0 100%);padding-right:52px}
.h-logo-emblem{width:54px;height:54px;border-radius:50%;overflow:hidden;border:3px solid rgba(255,255,255,.25);flex-shrink:0;background:conic-gradient(var(--am) 0 180deg,var(--az) 180deg 270deg,var(--ro) 270deg 360deg);display:flex;align-items:center;justify-content:center}
.h-logo-emblem span{font-family:var(--serif);font-size:13px;font-weight:700;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.5);letter-spacing:.5px}
.h-brand{color:#fff}
.h-brand h1{font-family:var(--serif);font-size:17px;font-weight:700;line-height:1;letter-spacing:.3px}
.h-brand p{font-size:9px;opacity:.65;margin-top:3px;letter-spacing:1px;text-transform:uppercase}
.h-center{padding:10px 24px;display:flex;flex-direction:column;justify-content:center;gap:5px}
.h-addr{font-size:11px;color:var(--txt2);display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.h-addr strong{color:var(--az);font-size:12px;font-weight:700}
.h-addr a{color:var(--vd);text-decoration:none;font-weight:600}
.h-addr a:hover{text-decoration:underline}
.h-user-zone{padding:10px 20px;display:flex;align-items:center;gap:10px;border-left:1px solid var(--bd)}
.h-avatar{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--az),#0055d4);display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:700;flex-shrink:0}
.h-user-info .h-user-name{font-size:12px;font-weight:700;color:var(--txt)}
.h-user-info .h-user-role{font-size:10px;color:var(--txt2)}
.h-auth-btns{display:flex;gap:6px;align-items:center;flex-wrap:wrap}

/* STATS BAR */
.statsbar{background:var(--az);padding:8px 20px;display:flex;gap:0;overflow-x:auto;scrollbar-width:none}
.statsbar::-webkit-scrollbar{display:none}
.sb-stat{flex:1;min-width:110px;text-align:center;padding:6px 12px;border-right:1px solid rgba(255,255,255,.1);cursor:pointer;transition:background .15s}
.sb-stat:hover{background:rgba(255,255,255,.07)}
.sb-stat:last-child{border-right:none}
.sb-num{font-family:var(--mono);font-size:20px;font-weight:600;color:var(--am);line-height:1}
.sb-lbl{font-size:9px;color:rgba(255,255,255,.55);margin-top:2px;text-transform:uppercase;letter-spacing:.7px}
.sb-stat.s-urgente .sb-num{color:#ff7b7b}
.sb-stat.s-ok .sb-num{color:#6ee7b7}
.sb-stat.s-warn .sb-num{color:#fdba74}

/* APP BODY: sidebar + main */
.app-body{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 130px);align-items:start}

/* SIDEBAR */
.sidebar{background:#fff;border-right:1px solid var(--bd);display:flex;flex-direction:column;position:sticky;top:0;max-height:100vh;overflow-y:auto}
.sidebar-section{border-bottom:1px solid var(--bd);padding:14px 10px}
.sidebar-section:last-child{border-bottom:none;flex:1}
.ss-title{font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:1.2px;padding:0 6px;margin-bottom:8px}
.s-nav-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;transition:all .15s;font-size:12px;color:var(--txt2);font-weight:500;margin-bottom:1px;user-select:none}
.s-nav-item:hover{background:var(--az-l);color:var(--az)}
.s-nav-item.active{background:var(--az);color:#fff;box-shadow:0 2px 8px rgba(0,56,147,.2)}
.s-nav-item.active .s-badge{background:rgba(255,255,255,.2);color:#fff}
.s-nav-item.s-urgent{color:var(--ro)}
.s-nav-item.s-urgent .s-badge{background:var(--ro-l);color:var(--ro)}
.s-badge{margin-left:auto;background:var(--bg);color:var(--txt2);font-size:10px;font-weight:700;padding:1px 7px;border-radius:12px;font-family:var(--mono);flex-shrink:0}
.s-nav-item.s-realizo{color:var(--vd)}
.s-nav-item.s-realizo .s-badge{background:var(--vd-l);color:var(--vd)}

/* Sidebar: periods panel */
.s-periods{padding:10px}
.s-period-chip{border:1.5px solid var(--bd);border-radius:7px;padding:7px 10px;cursor:pointer;transition:all .16s;background:var(--bg);margin-bottom:5px;display:flex;align-items:center;justify-content:space-between}
.s-period-chip:hover{border-color:var(--az);background:var(--az-l)}
.s-period-chip.loaded{border-color:var(--vd);background:var(--vd-l)}
.s-period-chip.selected{border-color:var(--az);background:var(--az-l)}
.s-period-chip.loaded.selected{border-color:var(--az)}
.spc-year{font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase}
.spc-month{font-size:12px;font-weight:600;color:var(--txt)}
.spc-count{font-size:10px;color:var(--txt2);font-family:var(--mono)}
.spc-check{width:18px;height:18px;border-radius:50%;background:var(--az);color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;opacity:0;transition:opacity .15s}
.selected .spc-check{opacity:1}

/* Sidebar: upload slot */
.s-upload-slot{border:1.5px dashed var(--bd);border-radius:7px;padding:8px 10px;margin-bottom:6px;transition:all .16s}
.s-upload-slot:focus-within{border-color:var(--az);background:var(--az-l)}
.sus-header{display:flex;align-items:center;gap:6px;margin-bottom:5px}
.sus-year{font-size:10px;font-weight:700;color:var(--az);font-family:var(--mono)}
.sus-sel{font-size:10px;font-weight:600}
.sus-file{display:none}
.sus-label{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:var(--az-l);color:var(--az);border:1px solid rgba(0,56,147,.2);font-size:10px;font-weight:700;cursor:pointer;transition:all .15s}
.sus-label:hover{background:var(--az);color:#fff}
.sus-month{border:1px solid var(--bd);border-radius:6px;padding:4px 7px;font-family:var(--font);font-size:11px;color:var(--txt);background:#fff;flex:1}

/* Mini calendar in sidebar */
.s-mini-cal{padding:10px}
.smc-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.smc-title{font-size:11px;font-weight:700;color:var(--az);font-family:var(--serif)}
.smc-btn{background:none;border:none;color:var(--az);cursor:pointer;font-size:13px;padding:2px 5px;border-radius:4px;transition:background .12s}
.smc-btn:hover{background:var(--az-l)}
.smc-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.smc-dow{font-size:8px;color:var(--txt3);text-align:center;font-weight:700;padding-bottom:3px;text-transform:uppercase}
.smc-d{font-size:10px;text-align:center;padding:4px 1px;border-radius:4px;cursor:pointer;color:var(--txt2);transition:all .12s;line-height:1}
.smc-d:hover{background:var(--az-l);color:var(--az)}
.smc-d.smc-today{background:var(--az);color:#fff;font-weight:700}
.smc-d.smc-urgente{background:var(--ro-l);color:var(--ro);font-weight:700}
.smc-d.smc-agendado{background:#e0ecff;color:var(--az);font-weight:700}
.smc-d.smc-other{color:var(--txt3);opacity:.4}
.smc-legend{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.smc-leg{display:flex;align-items:center;gap:3px;font-size:9px;color:var(--txt2)}
.smc-leg-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* MAIN CONTENT */
.main-content{background:var(--bg);display:flex;flex-direction:column;min-height:0}
.main-panel-hdr{background:#fff;padding:14px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;border-left:4px solid var(--az)}
.mph-left{}
.mph-title{font-family:var(--serif);font-size:15px;color:var(--az);font-weight:700}
.mph-desc{font-size:11px;color:var(--txt2);margin-top:3px;line-height:1.5;max-width:520px}
.mph-tools{display:flex;gap:6px;flex-wrap:wrap;flex-shrink:0}
.mc-btn{padding:6px 13px;border-radius:7px;font-size:11px;font-weight:600;cursor:pointer;border:1.5px solid var(--bd);background:#fff;color:var(--txt2);font-family:var(--font);display:flex;align-items:center;gap:4px;transition:all .15s;white-space:nowrap}
.mc-btn:hover{border-color:var(--az);color:var(--az);background:var(--az-l)}
.mc-btn.primary{background:var(--az);color:#fff;border-color:var(--az)}
.mc-btn.primary:hover{background:#0044b8}
.mc-btn.danger{background:var(--ro-l);color:var(--ro);border-color:#fca5a5}

/* TABLE v12 */
.t12-wrap{padding:16px}
.t12{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:var(--sh)}
.t12 thead tr{background:#f8fafc;border-bottom:2px solid var(--bd)}
.t12 th{padding:9px 14px;font-size:9px;font-weight:700;color:var(--txt3);text-align:left;text-transform:uppercase;letter-spacing:.9px;white-space:nowrap}
.t12 td{padding:10px 14px;font-size:12px;color:var(--txt);border-bottom:1px solid #f8fafc}
.t12 tr:last-child td{border-bottom:none}
.t12 tr:hover td{background:#fafbff}
.t12-placa{font-family:var(--mono);font-weight:600;color:var(--az);font-size:13px;letter-spacing:.5px}
.t12-nombre{font-weight:600;font-size:12px;line-height:1.3}
.t12-cc{font-family:var(--mono);font-size:10px;color:var(--txt2);margin-top:2px}
.t12-veh{font-size:10px;color:var(--txt3);margin-top:1px}
.t12-tel{font-family:var(--mono);font-size:11px;color:var(--txt2)}
.t12-venc-ok{background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0;padding:3px 9px;border-radius:6px;font-size:10px;font-weight:700;white-space:nowrap;display:inline-block}
.t12-venc-urg{background:var(--ro-l);color:var(--ro);border:1px solid #fca5a5;padding:3px 9px;border-radius:6px;font-size:10px;font-weight:700;white-space:nowrap;display:inline-block}
.t12-venc-est{background:var(--na-l);color:var(--na);border:1px solid #fdba74;padding:3px 9px;border-radius:6px;font-size:10px;font-weight:700;white-space:nowrap;display:inline-block}
.t12-venc-pronto{background:var(--am-l);color:#7a5200;border:1px solid var(--am);padding:3px 9px;border-radius:6px;font-size:10px;font-weight:700;white-space:nowrap;display:inline-block}
.t12-acts{display:flex;gap:4px;align-items:center}
.t12-act{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;border:1.5px solid transparent;transition:all .15s}
.t12-act.tel{background:var(--vd-l);border-color:#bbf7d0}
.t12-act.tel:hover{background:var(--vd);color:#fff}
.t12-act.wa{background:#e7fce8;border-color:#a7f3d0}
.t12-act.wa:hover{background:#25d366;color:#fff}
.t12-act.edit{background:var(--az-l);border-color:#c7d7fc}
.t12-act.edit:hover{background:var(--az);color:#fff}
.t12-act.star{background:var(--am-l);border-color:var(--am)}
.t12-act.star:hover{background:var(--am)}
.row-realizo td{background:linear-gradient(90deg,rgba(220,252,231,.4) 0%,transparent 60%)!important}

/* KPIs v12 */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;padding:14px 16px;background:#fff;border-bottom:1px solid var(--bd)}
.kpi{background:var(--bg);border-radius:9px;padding:12px;position:relative;overflow:hidden;animation:fadeUp .4s ease both;border:1.5px solid var(--bd);transition:border-color .15s}
.kpi:hover{border-color:var(--az)}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--az);border-radius:9px 9px 0 0}
.kpi-lbl{font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
.kpi-val{font-family:var(--mono);font-size:24px;font-weight:600;color:var(--az);line-height:1}
.kpi-sub{font-size:10px;color:var(--txt3);margin-top:2px}

/* SEARCH BAR */
.search-bar{display:flex;align-items:center;gap:8px;padding:10px 16px;background:#fff;border-bottom:1px solid var(--bd)}
.search-input{flex:1;background:var(--bg);border:1.5px solid var(--bd);border-radius:7px;padding:7px 12px;font-family:var(--font);font-size:12px;color:var(--txt);outline:none;transition:border-color .15s}
.search-input:focus{border-color:var(--az);background:#fff}
.search-count{font-size:11px;color:var(--txt2);font-family:var(--mono);white-space:nowrap}

/* RUN BUTTON */
.btn-analyze{background:var(--az);color:#fff;border:none;border-radius:var(--r2);padding:9px 20px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:7px}
.btn-analyze:hover:not(:disabled){background:#0044b8;transform:translateY(-1px)}
.btn-analyze:disabled{background:var(--bd2);cursor:not-allowed;color:var(--txt3)}

/* HIDE old elements */
.toolbar{display:none!important}
.today-banner,.ctx-bar{display:none!important}
.panel-hdr{display:none!important}
.tabs,.tab{display:none!important}
.panel{border-radius:0!important;box-shadow:none!important}
.upload{border-radius:0!important;box-shadow:none!important;margin:0!important;border:none!important;padding:10px!important}
.months-section{border-radius:0!important;box-shadow:none!important;margin:0!important;border:none!important;padding:10px!important}
.kpi-row-old{display:none}
footer{text-align:center;padding:8px;font-size:10px;color:var(--txt3)}
.auth-bar{background:var(--bg);border-bottom:1px solid var(--bd);padding:6px 20px}
.main{max-width:100%!important;padding:0!important}

@media(max-width:700px){
  .app-body{grid-template-columns:1fr}
  .sidebar{position:static;max-height:none}
  .h-logo-zone{clip-path:none;padding-right:16px}
  .h-center{display:none}
  .statsbar .sb-stat:nth-child(n+5){display:none}
}

/* ── MULTI DROP ZONE ── */
.multi-drop-zone{border:2px dashed var(--bd2);border-radius:10px;padding:16px;text-align:center;cursor:pointer;transition:all .15s;background:var(--bg)}
.multi-drop-zone.dz-over{border-color:var(--az);background:var(--az-l)}
.dz-icon{font-size:24px;margin-bottom:6px}
.dz-text{font-size:11px;color:var(--txt2);line-height:1.5;margin-bottom:10px}
.dz-text span{font-size:10px;color:var(--txt3)}
.dz-btn{display:inline-flex;align-items:center;padding:6px 14px;background:var(--az);color:#fff;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;transition:background .15s}
.dz-btn:hover{background:#0044b8}
/* FILE QUEUE */
.fq-item{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:8px 10px;margin-bottom:5px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.fqi-info{flex:1;min-width:0}
.fqi-name{font-size:11px;font-weight:600;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fqi-detected{font-size:10px;margin-top:2px;font-family:var(--mono)}
.fqi-detected.ok{color:var(--vd)}
.fqi-detected.warn{color:var(--na)}
.fqi-edit{display:flex;align-items:center;gap:4px;flex-shrink:0}
.fqi-sel{border:1px solid var(--bd);border-radius:5px;padding:2px 5px;font-size:10px;font-family:var(--font);color:var(--txt);background:#fff;cursor:pointer}
.fqi-del{background:none;border:none;color:var(--txt3);cursor:pointer;font-size:14px;padding:0 3px;line-height:1}
.fqi-del:hover{color:var(--ro)}
</style>
</head>
<body>
<div class="flag-stripe"></div>
<header class="header">
  <div class="h-logo-zone">
    <div class="h-logo-emblem"><span>CDA</span></div>
    <div class="h-brand">
      <h1>CDA Colombia</h1>
      <p>Sede Matatigres · RTM</p>
    </div>
  </div>
  <div class="h-center">
    <div class="h-addr">
      <strong>Revisión Técnico-Mecánica</strong>
      <span>·</span>
      <span>Carrera 27 #27-43 Sur, Bogotá</span>
    </div>
    <div class="h-addr">
      <span>📞 <strong>601 613 2278</strong></span>
      <span>·</span>
      <span>💬 <a href="https://wa.me/573229450743" target="_blank">322 945 0743</a></span>
    </div>
  </div>
  <div class="h-user-zone">
    <div class="h-avatar">NC</div>
    <div class="h-user-info">
      <div class="h-user-name">Natalia Cruz</div>
      <div class="h-user-role">Gestión Comercial</div>
    </div>
    <div class="h-auth-btns" id="hAuthBtns">
      <span class="auth-status" id="authStatus"></span>
    </div>
  </div>
</header>

<!-- AUTH BAR -->
<div class="auth-bar" id="authBar" style="display:flex;align-items:center;gap:8px">
  <button class="btn-auth btn-signin" id="btnSignIn" onclick="signIn()" style="display:none">
    <svg width="14" height="14" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.293C4.672 5.166 6.656 3.58 9 3.58z"/></svg>
    Iniciar sesión con Google
  </button>
  <img class="auth-avatar" id="authAvatar" style="display:none;width:24px;height:24px;border-radius:50%" src="" alt="">
  <div id="authInfo" style="display:none;font-size:11px">
    <span class="auth-name" id="authName" style="font-weight:600"></span>
    <span style="color:var(--txt3);margin-left:4px" id="authEmail"></span>
  </div>
  <div class="drive-info" id="driveInfo" style="display:none">
    <span>📁</span><span id="driveFolderName" style="font-size:11px">CDA Gestión Comercial</span>
  </div>
  <span class="sync-dot" id="syncDot" style="margin-left:4px"></span>
  <span style="font-size:10px;color:var(--txt2)" id="syncLabel">Listo</span>
  <button class="btn-auth btn-signout" id="btnSignOut" onclick="signOut()" style="display:none;margin-left:auto">Salir</button>
  <button class="mc-btn" id="btnSetup" onclick="openSetup()" style="margin-left:auto;display:none;font-size:10px;padding:4px 10px">⚙️ Configurar</button>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="main" style="display:none">
  <div class="login-screen">
    <div class="login-card">
      <div class="login-flag"><div></div><div></div><div></div></div>
      <div class="login-title">CDA Colombia</div>
      <div class="login-sub">Gestión Comercial de Revisiones<br>Técnico-Mecánicas · RTM</div>
      <button class="btn-google" onclick="signIn()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.293C4.672 5.166 6.656 3.58 9 3.58z"/></svg>
        Continuar con Google
      </button>
      <div class="login-note">
        La app solicita acceso a Google Drive para guardar<br>
        los datos de gestión de forma segura y privada.<br><br>
        <strong>Primera vez:</strong> Si aparece "app no verificada",<br>
        haz clic en <em>Avanzado → Ir a la app</em>.
      </div>
    </div>
  </div>
</div>

<!-- APP (visible after login) -->
<div id="appScreen" style="display:none">

  <!-- TODAY BANNER (hidden, kept for JS compat) -->
  <div class="today-banner" id="todayBanner" style="display:none!important">
    <div style="flex:1"><strong id="tbTitle"></strong><div id="tbSub"></div></div>
    <button class="tb-btn" onclick="showTab('hoy')">Ver →</button>
  </div>
  <!-- Legacy toolbar hidden -->
  <div class="toolbar" style="display:none"><span id="syncDot2"></span><span id="syncLabel2"></span></div>

  <!-- STATS BAR -->
  <div class="statsbar" id="statsBar">
    <div class="sb-stat s-urgente" id="sb_urgente" onclick="if(S.analysis)showTab('nov')" title="Recontactar urgente">
      <div class="sb-num" id="sb_urgente_n">—</div>
      <div class="sb-lbl">🔴 Urgentes hoy</div>
    </div>
    <div class="sb-stat" id="sb_agenda" onclick="if(S.analysis)showTab('cal')">
      <div class="sb-num" id="sb_agenda_n">—</div>
      <div class="sb-lbl">📅 Citas agendadas</div>
    </div>
    <div class="sb-stat s-urgente" id="sb_runt" onclick="if(S.analysis)showTab('nov')">
      <div class="sb-num" id="sb_runt_n">—</div>
      <div class="sb-lbl">⚠️ Verificar RUNT</div>
    </div>
    <div class="sb-stat" id="sb_recontactar" onclick="if(S.analysis)showTab('nov')">
      <div class="sb-num" id="sb_recontactar_n">—</div>
      <div class="sb-lbl">📞 Recontactar</div>
    </div>
    <div class="sb-stat s-ok" id="sb_recurrentes" onclick="if(S.analysis)showTab('rec')">
      <div class="sb-num" id="sb_recurrentes_n">—</div>
      <div class="sb-lbl">✅ Recurrentes</div>
    </div>
    <div class="sb-stat s-ok" id="sb_ret" onclick="if(S.analysis)showTab('stat')">
      <div class="sb-num" id="sb_ret_n">—</div>
      <div class="sb-lbl">📈 Retención</div>
    </div>
  </div>

  <!-- BODY: sidebar + main -->
  <div class="app-body">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">

      <!-- NAV: visible after analysis -->
      <div class="sidebar-section" id="sideNav" style="display:none">
        <div class="ss-title">Gestión</div>
        <div class="s-nav-item s-urgent" id="sn_nov" onclick="S.analysis?showTab('nov'):toast('Primero analiza un período','err')">
          📞 Recontactar <span class="s-badge" id="snb_nov">—</span>
        </div>
        <div class="s-nav-item" id="sn_hoy" onclick="S.analysis?showTab('hoy'):toast('Primero analiza un período','err')">
          📅 Agenda del día
        </div>
        <div class="s-nav-item" id="sn_cal" onclick="S.analysis?showTab('cal'):toast('Primero analiza un período','err')">
          📆 Calendario <span class="s-badge" id="snb_cal">—</span>
        </div>
        <div class="s-nav-item" id="sn_rec" onclick="S.analysis?showTab('rec'):toast('Primero analiza un período','err')">
          ✅ Recurrentes <span class="s-badge" id="snb_rec">—</span>
        </div>
        <div class="s-nav-item" id="sn_new" onclick="S.analysis?showTab('new'):toast('Primero analiza un período','err')">
          🆕 Nuevos <span class="s-badge" id="snb_new">—</span>
        </div>
        <div class="s-nav-item" id="sn_par" onclick="S.analysis?showTab('par'):toast('Primero analiza un período','err')" style="display:none">
          ⚠️ Parciales <span class="s-badge" id="snb_par">—</span>
        </div>
        <div class="s-nav-item" id="sn_fid" onclick="S.analysis?showTab('fid'):toast('Primero analiza un período','err')">
          🏆 Clientes fieles <span class="s-badge" id="snb_fid">—</span>
        </div>
        <div class="s-nav-item" id="sn_mat" onclick="S.analysis?showTab('mat'):toast('Primero analiza un período','err')">
          📋 Matriz completa
        </div>
        <div class="s-nav-item" id="sn_stat" onclick="S.analysis?showTab('stat'):toast('Primero analiza un período','err')">
          📊 Estadísticas
        </div>
        <div class="s-nav-item" id="sn_mes" onclick="S.analysis?showTab('mes'):toast('Primero analiza un período','err')">
          📆 Análisis por mes
        </div>
        <div class="s-nav-item" onclick="openTemplatesModal()">
          ✏️ Plantillas WA
        </div>
      </div>

      <!-- MINI CALENDAR -->
      <div class="sidebar-section" id="sideCalSection" style="display:none">
        <div class="s-mini-cal" id="sideCalWrap"></div>
      </div>

      <!-- PERIODS from Drive -->
      <div class="sidebar-section">
        <div class="ss-title" style="display:flex;align-items:center;justify-content:space-between">
          <span>Períodos en Drive</span>
          <button onclick="refreshMonthsList()" id="btnRefreshMonths" style="background:none;border:none;font-size:12px;cursor:pointer;color:var(--az)" title="Actualizar">🔄</button>
        </div>
        <div class="months-section" id="monthsSection" style="display:none"></div>
        <div id="sidePeriodsWrap">
          <div style="font-size:11px;color:var(--txt3);padding:4px 6px">Cargando desde Drive…</div>
        </div>
      </div>

      <!-- UPLOAD v13 -->
      <div class="sidebar-section">
        <div class="ss-title">Cargar bases de datos</div>
        <div id="syncMsg" class="sync-msg"></div>
        <div id="yg"></div>
        <div style="padding:4px 0;margin-top:6px">
          <button class="btn-analyze" id="btnRun" onclick="runAnalysis()" disabled style="width:100%;justify-content:center;font-size:11px;padding:8px">
            🔍 Analizar
          </button>
          <div class="loading-row" id="loadingRow" style="margin-top:6px">
            <span style="font-size:10px;color:var(--txt2)">Procesando archivos…</span>
            <div class="prog"><div class="prog-fill"></div></div>
          </div>
        </div>
      </div>

    </aside><!-- /sidebar -->

    <!-- MAIN CONTENT -->
    <main class="main-content" id="mainContent">

      <!-- Login placeholder when not logged in -->
      <div id="loginInMain" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;gap:16px;padding:40px">
        <div style="font-family:var(--serif);font-size:22px;color:var(--az);font-weight:700">Bienvenida, Natalia</div>
        <div style="font-size:13px;color:var(--txt2);text-align:center;max-width:340px;line-height:1.7">Inicia sesión con tu cuenta Google para acceder a los datos de gestión comercial del CDA.</div>
        <button class="btn-analyze" onclick="signIn()" style="margin-top:8px">
          <svg width="16" height="16" viewBox="0 0 18 18"><path fill="#fff" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/></svg>
          Continuar con Google
        </button>
      </div>

      <!-- Results area -->
      <div id="results" style="display:none">
        <!-- Month filter bar -->
        <div class="month-filter-bar" id="monthFilterBar">
          <span class="mfb-label">📅 Comparar mes:</span>
          <div class="mfb-chips" id="mfbChips"></div>
          <div class="mfb-sep"></div>
          <span class="mfb-label">Vence en:</span>
          <select class="mfb-sel" id="filterVencMes" onchange="setVencFilter(this.value)">
            <option value="">Todos</option>
          </select>
          <button class="mfb-rerun" onclick="reRunAnalysis()" title="Volver a analizar con filtros">🔄 Actualizar</button>
        </div>
        <!-- KPI row -->
        <div class="kpi-row" id="kpiRow"></div>
        <!-- hidden compat elements -->
        <div id="ctxBar" style="display:none"></div>
        <div id="tabsRow" style="display:none"></div>
        <!-- RUNT pendientes banner -->
        <div id="runtBanner" style="display:none"></div>
        <!-- main panel header injected by showTab() -->
        <div id="mainPanelHdr"></div>
        <!-- main panel content -->
        <div id="mainPanel">
          <div class="empty"><div class="empty-ico">📊</div><h3>Selecciona una vista</h3></div>
        </div>
      </div>

    </main>

  </div><!-- /app-body -->

</div><!-- /appScreen -->

<!-- MODAL GESTIÓN -->
<div class="modal-bg" id="modalBg" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="mcl" onclick="closeModal()">✕</button>
    <h3 id="mTitle"></h3>
    <div id="mContact"></div>
    <div id="mVenc"></div>
    <div id="mForm"></div>
    <div id="mHist"></div>
  </div>
</div>

<!-- MODAL SETUP -->
<div class="modal-bg" id="setupBg" onclick="if(event.target===this)closeSetup()">
  <div class="modal setup-modal">
    <button class="mcl" onclick="closeSetup()">✕</button>
    <h3>⚙️ Configuración</h3>
    <div class="setup-steps">
      <button class="setup-step on" id="ss1" onclick="showSetupStep(1)">1 · Client ID</button>
      <button class="setup-step" id="ss2" onclick="showSetupStep(2)">2 · Publicar app</button>
      <button class="setup-step" id="ss3" onclick="showSetupStep(3)">3 · Estado</button>
    </div>
    <div id="sp1">
      <div class="info-box">
        <strong>Obtener Google OAuth Client ID:</strong><br><br>
        1. Ve a <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a><br>
        2. Crea un proyecto nuevo → nombre: <code>CDA Colombia</code><br>
        3. Ve a <strong>APIs y servicios → Biblioteca</strong><br>
        4. Activa: <strong>Google Drive API</strong> y <strong>Google Sheets API</strong><br>
        5. Ve a <strong>APIs y servicios → Credenciales</strong><br>
        6. Clic en <strong>Crear credencial → ID de cliente OAuth</strong><br>
        7. Tipo de aplicación: <strong>Aplicación web</strong><br>
        8. Orígenes autorizados: agrega la URL de tu GitHub Pages<br>
        &nbsp;&nbsp;&nbsp;<code>https://TU_USUARIO.github.io</code><br>
        9. Copia el <strong>ID de cliente</strong> (termina en <code>.apps.googleusercontent.com</code>)
      </div>
      <div class="fr">
        <label>Client ID de OAuth</label>
        <input id="cfg_clientId" type="text" placeholder="12345-abc.apps.googleusercontent.com">
      </div>
      <button class="btn-save" onclick="saveClientId()">Guardar Client ID</button>
    </div>
    <div id="sp2" style="display:none">
      <div class="info-box">
        <strong>Publicar en GitHub Pages:</strong><br><br>
        1. Ve a <a href="https://github.com" target="_blank">github.com</a> → crea cuenta si no tienes<br>
        2. Clic en <strong>New repository</strong><br>
        3. Nombre: <code>cda-gestion</code> · Visibilidad: <strong>Public</strong><br>
        4. Clic en <strong>Add file → Upload files</strong><br>
        5. Sube este archivo HTML (renómbralo a <code>index.html</code>)<br>
        6. Ve a <strong>Settings → Pages</strong><br>
        7. Source: <strong>Deploy from branch → main → / (root)</strong><br>
        8. En unos minutos tu app estará en:<br>
        &nbsp;&nbsp;&nbsp;<code>https://TU_USUARIO.github.io/cda-gestion</code><br><br>
        <strong>Cuando actualices la app:</strong> solo sube el nuevo HTML y GitHub Pages lo publica automáticamente.
      </div>
      <button class="btn-save" onclick="showSetupStep(3)">Siguiente →</button>
    </div>
    <div id="sp3" style="display:none">
      <div id="setupStatus" class="info-box">Verificando configuración…</div>
      <button class="btn-save" onclick="testSetup()">🔌 Probar conexión</button>
      <button class="btn-secondary" onclick="resetConfig()">Reiniciar configuración</button>
    </div>
  </div>
</div>

<!-- MODAL PLANTILLAS -->
<div class="modal-bg" id="tplBg" onclick="if(event.target===this)closeTemplatesModal()">
  <div class="modal" style="max-width:520px">
    <button class="mcl" onclick="closeTemplatesModal()">✕</button>
    <h3>✏️ Plantillas de mensaje</h3>
    <div class="tpl-vars">
      <span class="tpl-var">{nombre}</span><span class="tpl-var">{placa}</span>
      <span class="tpl-var">{marca}</span><span class="tpl-var">{linea}</span>
      <span class="tpl-var">{vencimiento}</span><span class="tpl-var">{clase}</span>
    </div>
    <div class="fr"><label>💬 WhatsApp</label><textarea id="tpl_wa" style="min-height:76px"></textarea></div>
    <div class="fr"><label>📱 SMS corto</label><textarea id="tpl_sms" style="min-height:48px"></textarea></div>
    <div class="fr"><label>📅 Recordatorio de cita</label><textarea id="tpl_rec" style="min-height:48px"></textarea></div>
    <div style="display:flex;gap:7px">
      <button class="btn-save" style="flex:1" onclick="saveTemplates()">💾 Guardar</button>
      <button class="btn-ghost" onclick="resetTemplates()">↺ Restaurar</button>
    </div>
  </div>
</div>

<footer><em>CDA Colombia</em> · Sede Matatigres · Drive · v12</footer>
<div class="notif" id="notif"></div>

<script>
'use strict';
// ════════════════════════════════════════════════════════════
// CONFIG
// ════════════════════════════════════════════════════════════
// 🔧 CONFIGURA TU URL DE RESEÑA: ve a Google Maps, busca tu CDA, clic en "Escribir reseña" y copia la URL
const GOOGLE_REVIEW_URL = 'https://g.page/r/TU_CDA_SHORTLINK/review'; // ← reemplaza esto


// ════════════════════════════════════════════════════════════
// FILENAME PARSER — detects "Enero 2024.xlsx" → {mes, year}
// ════════════════════════════════════════════════════════════
const MES_MAP = {
  'enero':0,'febrero':1,'marzo':2,'abril':3,'mayo':4,'junio':5,
  'julio':6,'agosto':7,'septiembre':8,'octubre':9,'noviembre':10,'diciembre':11,
  'jan':0,'feb':1,'mar':2,'apr':3,'may':4,'jun':5,
  'jul':6,'aug':7,'sep':8,'oct':9,'nov':10,'dec':11
};
function parseFilename(name) {
  // "Enero 2024.xlsx", "2024_Enero.xlsx", "Enero-2024.xlsx"
  const clean = name.replace(/\.(xlsx|xls|csv)$/i,'').toLowerCase().replace(/[-_]/g,' ');
  const parts = clean.split(/\s+/);
  let mes=null, mesNum=-1, year=null;
  parts.forEach(p => {
    if(MES_MAP[p] !== undefined){ mes = MO[MES_MAP[p]]; mesNum = MES_MAP[p]; }
    if(/^20\d{2}$/.test(p)) year = p;
  });
  const key = (mes && year) ? `${mes} ${year}` : null;
  return { mes, mesNum, year: year ? parseInt(year) : null, key };
}

const APP_CONFIG = {
  clientId: localStorage.getItem('cda_clientId') || 'REEMPLAZAR_CON_TU_CLIENT_ID',
  scopes: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
  folderName: 'CDA Gestión Comercial',
  gestionFileName: 'Gestión_Comercial.json',
  get redirectUri() { return window.location.origin + window.location.pathname; },
};

// ════════════════════════════════════════════════════════════
// CONSTANTES
// ════════════════════════════════════════════════════════════
const MO=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const C6=['#003893','#1a6b3c','#CE1126','#c05e00','#5b21b6','#0891b2'];
const CB=['#FCD116','#003893','#CE1126','#1a6b3c','#c05e00','#5b21b6'];
const DIAS_LLAMAR = 8;
// Anti-spam WhatsApp: greeting/intro/closing variants
const WA_SALUDOS=['Hola','Buenos días','Buenas tardes','Buenas','Cordial saludo'];
const WA_INTROS=['Le contactamos del','Le escribimos desde','Lo saludamos del','Le comunicamos del','El equipo del'];
const WA_CIERRES=['¿Le gustaría agendar su cita?','¿Desea programar la revisión?','Estamos disponibles para agendar.','¿Le ayudamos a programar su visita?','Con gusto le agendamos de inmediato.'];
const WA_EMOJIS=['🚗','🔧','✅','📋','🏁'];
const ESTADOS=[
  {v:'pendiente',  l:'Pendiente',  cls:'gb-pte', i:'⏳'},
  {v:'en-gestion', l:'En gestión', cls:'gb-gest',i:'📞'},
  {v:'contactado', l:'Contactado', cls:'gb-cont',i:'✅'},
  {v:'agendado',   l:'Agendado',   cls:'gb-agend',i:'📅'},
  {v:'no-interesa',l:'No interesa',cls:'gb-noint',i:'🚫'},
];

// ════════════════════════════════════════════════════════════
// STATE
// ════════════════════════════════════════════════════════════
const S = {
  accessToken: null,
  user: null,
  folderId: null,
  gestionFileId: null,
  // loaded periods: { "Enero 2024": { label, year, month, monthNum, rows[], deduped[] }, ... }
  periods: {},
  // selected period keys for analysis
  selectedPeriods: new Set(),
  analysis: null,
  modalPlaca: null,
  activeTab: null,
  years: [],   // local upload slots
  // v13: month filter
  filterMes: null,       // null = todos los meses, or e.g. "Febrero"
  filterVencMes: null,   // filter by vencimiento month
  runtPendientes: {},    // { placa: { mesDestino, nota } }
};

// ════════════════════════════════════════════════════════════
// GESTIÓN (local + Drive)
// ════════════════════════════════════════════════════════════
let GESTION = {};
try { GESTION = JSON.parse(localStorage.getItem('cda_gestion')||'{}'); } catch{}

async function persistGestion() {
  localStorage.setItem('cda_gestion', JSON.stringify(GESTION));
  await saveToDrive();
}

// ════════════════════════════════════════════════════════════
// GOOGLE AUTH — Redirect flow (no popup)
// ════════════════════════════════════════════════════════════
function initGoogleAuth() {
  const clientId = APP_CONFIG.clientId;

  // Check if returning from OAuth redirect
  const hash = window.location.hash;
  if(hash.includes('access_token')) {
    const params = new URLSearchParams(hash.slice(1));
    const token = params.get('access_token');
    const expiresIn = parseInt(params.get('expires_in')||'3600');
    if(token) {
      // Clean URL
      history.replaceState(null, '', window.location.pathname);
      S.accessToken = token;
      localStorage.setItem('cda_token', JSON.stringify({
        token, expiry: Date.now() + expiresIn*1000 - 60000
      }));
      fetchUserInfo();
      return;
    }
  }

  // Check saved token
  const saved = localStorage.getItem('cda_token');
  if(saved) {
    try {
      const t = JSON.parse(saved);
      if(t.expiry > Date.now()) {
        S.accessToken = t.token;
        fetchUserInfo();
        return;
      }
    } catch{}
    localStorage.removeItem('cda_token');
  }

  // Show login screen
  if(clientId === 'REEMPLAZAR_CON_TU_CLIENT_ID') {
    showLoginScreen();
    setAuthStatus('⚠️ Configura tu Client ID primero','warn');
    document.getElementById('btnSetup').style.display='flex';
    document.querySelector('.login-note').innerHTML = `
      <strong>⚙️ Primer uso:</strong> configura tu Client ID.<br><br>
      Haz clic en <button onclick="openSetup()" style="background:var(--az);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer">⚙️ Configurar</button> arriba.`;
    return;
  }
  showLoginScreen();
}

function signIn() {
  const clientId = APP_CONFIG.clientId;
  if(clientId === 'REEMPLAZAR_CON_TU_CLIENT_ID') { openSetup(); return; }
  const params = new URLSearchParams({
    client_id: clientId,
    redirect_uri: APP_CONFIG.redirectUri,
    response_type: 'token',
    scope: APP_CONFIG.scopes,
    include_granted_scopes: 'true',
  });
  window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params.toString();
}

async function fetchUserInfo() {
  try {
    const res = await gFetch('https://www.googleapis.com/oauth2/v2/userinfo');
    S.user = res;
    showAppScreen();
    updateAuthBar();
    await initDrive();
  } catch(e) {
    localStorage.removeItem('cda_token');
    S.accessToken = null;
    showLoginScreen();
    if(e.message !== '401') toast('Error al conectar: '+e.message,'err');
  }
}

function signOut() {
  S.accessToken = null; S.user = null; S.folderId = null;
  localStorage.removeItem('cda_token');
  showLoginScreen();
  updateAuthBar();
  toast('Sesión cerrada');
}

function showLoginScreen() {
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('appScreen').style.display='block';
  document.getElementById('loginInMain').style.display='flex';
  document.getElementById('results').style.display='none';
  document.getElementById('sideNav').style.display='none';
  document.getElementById('sideCalSection').style.display='none';
}
function showAppScreen() {
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('appScreen').style.display='block';
  document.getElementById('loginInMain').style.display='none';
}
function showLoginScreen2(){
  document.getElementById('loginInMain').style.display='flex';
}
function updateAuthBar() {
  const u = S.user;
  document.getElementById('btnSignIn').style.display = u ? 'none' : 'flex';
  document.getElementById('btnSignOut').style.display = u ? 'flex' : 'none';
  document.getElementById('authAvatar').style.display = u ? 'block' : 'none';
  document.getElementById('authInfo').style.display = u ? 'block' : 'none';
  document.getElementById('btnSetup').style.display = u ? 'flex' : 'none';
  if(u) {
    document.getElementById('authAvatar').src = u.picture||'';
    document.getElementById('authName').textContent = u.name||'';
    document.getElementById('authEmail').textContent = u.email||'';
  }
}
function setAuthStatus(msg, type) {
  const el = document.getElementById('authStatus');
  el.textContent = msg; el.className = 'auth-status '+(type||'');
  el.style.display = msg ? 'block' : 'none';
}

// ════════════════════════════════════════════════════════════
// GOOGLE API HELPER
// ════════════════════════════════════════════════════════════
async function gFetch(url, opts={}) {
  const res = await fetch(url, {
    ...opts,
    headers: {
      'Authorization': 'Bearer '+S.accessToken,
      'Content-Type': 'application/json',
      ...(opts.headers||{}),
    },
  });
  if(res.status === 401) {
    localStorage.removeItem('cda_token');
    S.accessToken = null;
    showLoginScreen();
    throw new Error('401');
  }
  if(!res.ok) {
    const err = await res.json().catch(()=>({}));
    throw new Error(err.error?.message || `HTTP ${res.status}`);
  }
  return res.json();
}

async function gFetchRaw(url, opts={}) {
  const res = await fetch(url, {
    ...opts,
    headers: { 'Authorization': 'Bearer '+S.accessToken, ...(opts.headers||{}) },
  });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res;
}

// ════════════════════════════════════════════════════════════
// DRIVE FOLDER + FILES
// ════════════════════════════════════════════════════════════
async function initDrive() {
  setSyncState('syncing','Conectando a Drive…');
  try {
    // Find or create folder
    const q = encodeURIComponent(`name='${APP_CONFIG.folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`);
    const res = await gFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)`);
    if(res.files?.length) {
      S.folderId = res.files[0].id;
    } else {
      // Create folder
      const f = await gFetch('https://www.googleapis.com/drive/v3/files', {
        method:'POST',
        body: JSON.stringify({ name: APP_CONFIG.folderName, mimeType: 'application/vnd.google-apps.folder' }),
      });
      S.folderId = f.id;
    }
    document.getElementById('driveInfo').style.display='flex';
    document.getElementById('driveFolderName').textContent = APP_CONFIG.folderName;

    // Load gestión file
    await loadGestionFromDrive();
    setSyncState('synced','Sincronizado');
    setAuthStatus('✅ Conectado a Drive','ok');

    // Load period list
    await refreshMonthsList();
    initSlots();
    checkBtn();
  } catch(e) {
    setSyncState('error','Error Drive');
    setAuthStatus('⚠️ '+e.message,'err');
    toast('Error de Drive: '+e.message,'err');
    initSlots(); // still allow local use
  }
}

// ── Load gestión JSON from Drive ──────────────────────────
async function loadGestionFromDrive() {
  if(!S.folderId) return;
  const q = encodeURIComponent(`name='${APP_CONFIG.gestionFileName}' and '${S.folderId}' in parents and trashed=false`);
  const res = await gFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime)`);
  if(!res.files?.length) return;
  S.gestionFileId = res.files[0].id;
  const fileRes = await gFetchRaw(`https://www.googleapis.com/drive/v3/files/${S.gestionFileId}?alt=media`);
  const text = await fileRes.text();
  const remote = JSON.parse(text);
  // Merge: remote wins over local for shared keys
  GESTION = { ...GESTION, ...remote };
  localStorage.setItem('cda_gestion', JSON.stringify(GESTION));
  showSyncMsg(`☁️ ${Object.keys(GESTION).length} gestiones cargadas desde Drive`,'ok');
}

// ── Save gestión to Drive ────────────────────────────────
async function saveToDrive() {
  if(!S.folderId) return;
  setSyncState('syncing','Guardando…');
  try {
    const body = JSON.stringify(GESTION);
    if(S.gestionFileId) {
      // Update existing file
      await gFetchRaw(`https://www.googleapis.com/upload/drive/v3/files/${S.gestionFileId}?uploadType=media`, {
        method:'PATCH', headers:{'Content-Type':'application/json'}, body,
      });
    } else {
      // Create new file
      const meta = { name: APP_CONFIG.gestionFileName, parents: [S.folderId] };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(meta)],{type:'application/json'}));
      form.append('file', new Blob([body],{type:'application/json'}));
      const res = await gFetchRaw('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method:'POST', headers:{}, body: form,
      });
      const data = await res.json();
      S.gestionFileId = data.id;
    }
    setSyncState('synced','Guardado en Drive');
  } catch(e) {
    setSyncState('error','Error al guardar');
    showSyncMsg('⚠️ Error guardando: '+e.message,'warn');
  }
}

// ── Save period Excel to Drive ───────────────────────────
async function savePeriodToDrive(periodKey, rows) {
  if(!S.folderId) return;
  const fileName = `${periodKey}.json`;
  setSyncState('syncing',`Guardando ${periodKey}…`);
  try {
    // Check if exists
    const q = encodeURIComponent(`name='${fileName}' and '${S.folderId}' in parents and trashed=false`);
    const res = await gFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`);
    const body = JSON.stringify({ key: periodKey, rows });

    if(res.files?.length) {
      await gFetchRaw(`https://www.googleapis.com/upload/drive/v3/files/${res.files[0].id}?uploadType=media`, {
        method:'PATCH', headers:{'Content-Type':'application/json'}, body,
      });
    } else {
      const meta = { name: fileName, parents: [S.folderId] };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(meta)],{type:'application/json'}));
      form.append('file', new Blob([body],{type:'application/json'}));
      await gFetchRaw('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method:'POST', headers:{}, body: form,
      });
    }
    setSyncState('synced','Guardado en Drive');
    toast(`✅ ${periodKey} guardado en Drive`,'ok');
  } catch(e) {
    setSyncState('error','Error');
    toast('Error guardando período: '+e.message,'err');
  }
}

// ── List periods in Drive folder ─────────────────────────
async function refreshMonthsList() {
  if(!S.folderId) return;
  const btn = document.getElementById('btnRefreshMonths');
  if(btn) btn.disabled = true;
  try {
    const q = encodeURIComponent(`'${S.folderId}' in parents and trashed=false and name contains '.json' and not name='${APP_CONFIG.gestionFileName}'`);
    const res = await gFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime)&orderBy=name`);
    renderMonthsGrid(res.files||[]);
  } catch(e) {
    document.getElementById('monthsGrid').innerHTML = `<div class="no-months" style="color:var(--ro)">Error cargando períodos: ${h(e.message)}</div>`;
  }
  if(btn) btn.disabled = false;
}

function renderMonthsGrid(files) {
  // Render in sidebar period chips
  const wrap = document.getElementById('sidePeriodsWrap');
  if(!wrap) return;
  if(!files.length) {
    wrap.innerHTML = '<div style="font-size:11px;color:var(--txt3);padding:4px 6px">Sin períodos. Carga un Excel abajo.</div>';
    return;
  }
  // Store file map for onclick use
  S._driveFiles = S._driveFiles || {};
  files.forEach(f=>{ const k=f.name.replace('.json',''); S._driveFiles[k]=f.id; });
  
  wrap.innerHTML = files.map(f => {
    const key = f.name.replace('.json','');
    const parts = key.split('_');
    const year = parts[0]||'';
    const month = parts.slice(1).join(' ')||'';
    const isLoaded = !!S.periods[key];
    const isSelected = S.selectedPeriods.has(key);
    const cnt = isLoaded ? S.periods[key].deduped.length.toLocaleString()+' placas' : '—';
    return `<div class="s-period-chip ${isLoaded?'loaded':''} ${isSelected?'selected':''}"
               data-key="${key}" data-fid="${f.id}" id="mc_${key}">
      <div>
        <div class="spc-year">${h(year)}</div>
        <div class="spc-month">${h(month)}</div>
        <div class="spc-count">${cnt}</div>
      </div>
      <div class="spc-check">✓</div>
    </div>`;
  }).join('');
  
  // Attach click events after render (avoids onclick quoting issues)
  wrap.querySelectorAll('.s-period-chip').forEach(chip => {
    chip.addEventListener('click', function() {
      togglePeriod(this.dataset.key, this.dataset.fid);
    });
  });
}

async function togglePeriod(key, fileId) {
  if(S.periods[key]) {
    // Already loaded — just toggle selection
    if(S.selectedPeriods.has(key)) {
      S.selectedPeriods.delete(key);
    } else {
      S.selectedPeriods.add(key);
    }
    updateMonthChip(key);
    checkBtn();
    return;
  }
  // Load from Drive
  const chip = document.getElementById(`mc_${key}`);
  if(chip) { const sc=chip.querySelector('.spc-count'); if(sc) sc.textContent='Cargando…'; }
  setSyncState('syncing',`Cargando ${key}…`);
  try {
    const res = await gFetchRaw(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`);
    const data = await res.json();
    const rows = data.rows||[];
    const aprobados = rows.filter(r=>r.Aprobado);
    const byP = {};
    aprobados.forEach(r=>{ if(!byP[r.Placa]||r.FechaFinal>byP[r.Placa].FechaFinal) byP[r.Placa]=r; });
    // Restore Date objects
    Object.values(byP).forEach(r=>{
      if(r.VencDate) r.VencDate = new Date(r.VencDate);
      if(r.FechaDate) r.FechaDate = new Date(r.FechaDate);
    });
    S.periods[key] = { label: key.replace('_',' '), rows, deduped: Object.values(byP) };
    S.selectedPeriods.add(key);
    updateMonthChip(key);
    setSyncState('synced','Sincronizado');
    checkBtn();
    toast(`✅ ${key} cargado · ${Object.values(byP).length.toLocaleString()} placas`,'ok');
  } catch(e) {
    setSyncState('error','Error');
    toast('Error cargando período: '+e.message,'err');
    if(chip) { const sc=chip.querySelector('.spc-count'); if(sc) sc.textContent='Error'; }
  }
}

function updateMonthChip(key) {
  const chip = document.getElementById(`mc_${key}`);
  if(!chip) return;
  const isLoaded = !!S.periods[key];
  const isSelected = S.selectedPeriods.has(key);
  chip.className = `s-period-chip ${isLoaded?'loaded':''} ${isSelected?'selected':''}`;
  const cc=chip.querySelector('.spc-count');
  if(cc) cc.textContent = isLoaded ? S.periods[key].deduped.length.toLocaleString()+' placas' : '—';
}

// ════════════════════════════════════════════════════════════
// LOCAL UPLOAD SLOTS (to create new periods)
// ════════════════════════════════════════════════════════════
function initSlots() {
  const g = document.getElementById('yg'); if(!g) return;
  g.innerHTML = `
    <div class="multi-drop-zone" id="dropZone">
      <div class="dz-icon">📂</div>
      <div class="dz-text">Arrastra tus Excel aquí<br><span>Enero 2024.xlsx, Febrero 2025.xlsx…</span></div>
      <label class="dz-btn">
        Seleccionar archivos
        <input type="file" id="multiFileInput" multiple accept=".xlsx,.xls,.csv" style="display:none">
      </label>
    </div>
    <div id="fileQueue" style="margin-top:8px"></div>`;

  const dz = document.getElementById('dropZone');
  const fi = document.getElementById('multiFileInput');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dz-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('dz-over'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('dz-over');
    handleFiles([...e.dataTransfer.files]);
  });
  fi.addEventListener('change', () => { handleFiles([...fi.files]); fi.value=''; });
}

function addSlot(yr) {
  // Legacy stub — v13 uses handleFiles() instead
  return;
  const idx = S.years.length;
  if(idx >= 4){ toast('Máximo 4 años','err'); return; }
  S.years.push({label:String(yr),allRows:null,avM:[],selM:new Set(['__ALL__']),filtered:[],deduped:[],fileName:''});
  const g = document.getElementById('yg');
  document.getElementById('addSlotBtn')?.remove();
  const c = document.createElement('div');
  c.className='yc'; c.id=`yc_${idx}`;
  c.innerHTML=`
    <div class="yc-head">
      <span class="yb" id="yb_${idx}">${yr}</span>
      <input class="yi" type="number" value="${yr}" min="2000" max="2099"
        oninput="S.years[${idx}].label=this.value;document.getElementById('yb_${idx}').textContent=this.value">
      ${idx>=2?`<button class="yr-btn" onclick="removeSlot(${idx})">✕</button>`:''}
    </div>
    <label class="fd" id="fd_${idx}">
      <input type="file" accept=".xlsx,.xls" onchange="loadFile(event,${idx})">
      <div style="font-size:18px;margin-bottom:2px">📄</div>
      <div style="font-weight:600;font-size:11px">Clic para subir Excel</div>
    </label>
    <div class="fst" id="fst_${idx}"></div>
    <div class="mp" id="mp_${idx}">
      <div class="mlbl">Meses:</div>
      <div class="mcs" id="mcs_${idx}"></div>
      <div class="macts">
        <button class="mact" onclick="selAllM(${idx})">Todos</button>
        <button class="mact" onclick="clrM(${idx})">Ninguno</button>
      </div>
    </div>`;
  g.appendChild(c);
  if(S.years.length < 4) {
    const a = document.createElement('div');
    a.className='add-slot'; a.id='addSlotBtn';
    a.onclick=()=>addSlot(parseInt(S.years[S.years.length-1].label)+1);
    a.innerHTML='+ Agregar año';
    g.appendChild(a);
  }
}

function removeSlot(idx) {
  const saved = S.years.filter((_,i)=>i!==idx);
  S.years=[]; document.getElementById('yg').innerHTML='';
  saved.forEach((y,i)=>{ addSlot(parseInt(y.label)); if(y.allRows){S.years[i]=y;renderSlotLoaded(i);} });
  checkBtn();
}

function renderSlotLoaded(idx) {
  const y = S.years[idx];
  const c = document.getElementById(`yc_${idx}`); if(!c) return;
  c.classList.add('loaded');
  const fs = document.getElementById(`fst_${idx}`);
  fs.style.display='block';
  fs.textContent=`✅ ${y.fileName} · ${y.allRows.filter(r=>r.Aprobado).length.toLocaleString()} aprobados`;
  renderChips(idx);
}

// ════════════════════════════════════════════════════════════
// READ EXCEL
// ════════════════════════════════════════════════════════════
function loadFile(evt, idx) {
  const file = evt.target.files[0]; if(!file) return;
  toast(`⏳ Leyendo ${file.name}…`);
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(e.target.result,{type:'array',cellDates:true});
      const all = [];
      wb.SheetNames.forEach(sn => {
        const ws = wb.Sheets[sn];
        const raw = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
        if(!raw||raw.length<3) return;
        let hdr=-1;
        for(let i=0;i<Math.min(raw.length,10);i++){
          if(raw[i].map(v=>String(v).trim().toLowerCase()).includes('placa')){hdr=i;break;}
        }
        if(hdr===-1) return;
        const hs = raw[hdr].map(v=>String(v).trim());
        const cm={}; hs.forEach((hh,j)=>{cm[hh.toLowerCase()]=j;});
        const get=(row,...keys)=>{for(const k of keys){const j=cm[k.toLowerCase()];if(j!==undefined&&row[j]!==''&&row[j]!==undefined&&row[j]!==null)return String(row[j]).trim();}return '';};
        for(let i=hdr+1;i<raw.length;i++){
          const row=raw[i];
          const placa=get(row,'placa'); if(!placa||placa.toLowerCase()==='placa') continue;
          const aprobada=get(row,'aprobada','resultado');
          const aprobado=aprobada.toUpperCase()==='APROBADO'||aprobada.toUpperCase()==='SI';
          const fechaStr=get(row,'fecha final','fecha inicio','fecha');
          let mes='',mesNum=0,fechaDate=null;
          if(fechaStr){const d=new Date(fechaStr);if(!isNaN(d)){mesNum=d.getMonth();mes=MO[mesNum];fechaDate=d;}}
          let vencDate=null;
          if(aprobado&&fechaDate){vencDate=new Date(fechaDate);vencDate.setFullYear(vencDate.getFullYear()+1);}
          all.push({
            Placa:placa.toUpperCase().replace(/\s/g,''),
            Propietario:get(row,'propietario'),Identificacion:get(row,'identificacion'),
            Telefono:get(row,'telefono'),Correo:get(row,'correo'),
            Clase:get(row,'clase'),Servicio:get(row,'servicio'),
            Marca:get(row,'marca'),Linea:get(row,'linea'),
            Modelo:get(row,'modelo'),Color:get(row,'color'),
            Ciudad:get(row,'ciudad'),
            Aprobado:aprobado,Resultado:aprobada,
            FechaFinal:fechaStr,
            FechaDate:fechaDate?fechaDate.toISOString():null,
            VencDate:vencDate?vencDate.toISOString():null,
            Mes:mes,MesNum:mesNum,_hoja:sn,
          });
        }
      });
      if(!all.length){toast('Sin datos válidos','err');return;}
      S.years[idx].allRows=all;
      S.years[idx].avM=MO.filter(m=>all.some(r=>r.Mes===m));
      S.years[idx].selM=new Set(['__ALL__']);
      S.years[idx].fileName=file.name;
      applyFilter(idx);
      renderSlotLoaded(idx);
      const aprobados=all.filter(r=>r.Aprobado).length;
      toast(`✅ ${file.name} · ${aprobados.toLocaleString()} aprobados`,'ok');
      checkBtn();

      // Auto-save to Drive: detect period from filename or data
      if(S.folderId) autoSavePeriod(idx, all);
    } catch(err){toast('Error: '+err.message,'err');console.error(err);}
  };
  reader.readAsArrayBuffer(file);
}


// ════════════════════════════════════════════════════════════
// MULTI-FILE HANDLER (v13)
// ════════════════════════════════════════════════════════════
const FILE_QUEUE = {}; // key → { file, detected, override }

function handleFiles(files) {
  files.forEach(file => {
    const detected = parseFilename(file.name);
    const key = detected.key || file.name.replace(/\.(xlsx|xls|csv)$/i,'');
    FILE_QUEUE[key] = { file, detected, override: null, key };
  });
  renderFileQueue();
  checkBtn();
}

function renderFileQueue() {
  const el = document.getElementById('fileQueue'); if(!el) return;
  const entries = Object.values(FILE_QUEUE);
  if(!entries.length){ el.innerHTML=''; return; }
  el.innerHTML = entries.map(e => {
    const ok = e.detected.mes && e.detected.year;
    const displayMes = e.override?.mes || e.detected.mes || '?';
    const displayYear = e.override?.year || e.detected.year || '?';
    return `<div class="fq-item" id="fqi_${CSS.escape(e.key)}">
      <div class="fqi-info">
        <div class="fqi-name">${h(e.file.name)}</div>
        <div class="fqi-detected ${ok?'ok':'warn'}">
          ${ok ? `✓ ${displayMes} ${displayYear}` : '⚠️ No detectado — corrige abajo'}
        </div>
      </div>
      <div class="fqi-edit">
        <select class="fqi-sel" onchange="setFileOverride('${e.key}','mes',this.value)">
          ${MO.map(m=>`<option value="${m}" ${(e.override?.mes||e.detected.mes)===m?'selected':''}>${m}</option>`).join('')}
        </select>
        <select class="fqi-sel" onchange="setFileOverride('${e.key}','year',parseInt(this.value))">
          ${[2023,2024,2025,2026,2027].map(y=>`<option value="${y}" ${(e.override?.year||e.detected.year)===y?'selected':''}>${y}</option>`).join('')}
        </select>
        <button class="fqi-del" onclick="removeFromQueue('${e.key}')">✕</button>
      </div>
    </div>`;
  }).join('');
}

function setFileOverride(key, field, val) {
  if(FILE_QUEUE[key]) {
    FILE_QUEUE[key].override = FILE_QUEUE[key].override || {};
    FILE_QUEUE[key].override[field] = val;
    renderFileQueue();
  }
}
function removeFromQueue(key) {
  delete FILE_QUEUE[key];
  renderFileQueue();
  checkBtn();
}

async function autoSavePeriod(idx, rows) {
  // Detect period key from data (e.g. 2025_Enero)
  const year = S.years[idx].label;
  const months = [...new Set(rows.filter(r=>r.Mes).map(r=>r.Mes))];
  if(!months.length) return;
  for(const mes of months) {
    const key = `${year}_${mes}`;
    await savePeriodToDrive(key, rows.filter(r=>r.Mes===mes));
  }
  await refreshMonthsList();
}

function renderChips(idx){
  const y=S.years[idx];
  const c=document.getElementById(`mcs_${idx}`);if(!c)return;c.innerHTML='';
  const isAll=y.selM.has('__ALL__');
  const all=document.createElement('span');
  all.className='chip chip-all'+(isAll?' on':'');all.textContent='Todos';all.onclick=()=>selAllM(idx);
  c.appendChild(all);
  y.avM.forEach(mes=>{
    const ch=document.createElement('span');
    ch.className='chip'+(!isAll&&y.selM.has(mes)?' on':'');
    ch.textContent=mes;ch.onclick=()=>toggleM(idx,mes);c.appendChild(ch);
  });
}
function toggleM(idx,mes){const y=S.years[idx];y.selM.delete('__ALL__');y.selM.has(mes)?y.selM.delete(mes):y.selM.add(mes);if(y.selM.size===0)y.selM.add('__ALL__');renderChips(idx);applyFilter(idx);}
function selAllM(idx){S.years[idx].selM=new Set(['__ALL__']);renderChips(idx);applyFilter(idx);}
function clrM(idx){S.years[idx].selM.clear();renderChips(idx);applyFilter(idx);}

function applyFilter(idx){
  const y=S.years[idx];if(!y.allRows)return;
  const rows=(y.selM.has('__ALL__')||y.selM.size===0)?y.allRows:y.allRows.filter(r=>y.selM.has(r.Mes));
  const aprobados=rows.filter(r=>r.Aprobado);
  const byP={};aprobados.forEach(r=>{if(!byP[r.Placa]||r.FechaFinal>byP[r.Placa].FechaFinal)byP[r.Placa]=r;});
  y.filtered=aprobados;y.deduped=Object.values(byP);
}

function checkBtn(){
  const hasQueue = Object.keys(FILE_QUEUE).length > 0;
  const hasPeriods = S.selectedPeriods.size >= 1;
  document.getElementById('btnRun').disabled = !(hasQueue || hasPeriods);
}

// ════════════════════════════════════════════════════════════
// ANALYSIS
// ════════════════════════════════════════════════════════════
function runAnalysis(){
  const queueEntries = Object.values(FILE_QUEUE);
  if(!queueEntries.length && S.selectedPeriods.size < 1){
    toast('Agrega archivos Excel o selecciona períodos de Drive','err'); return;
  }
  document.getElementById('loadingRow').style.display='flex';
  document.getElementById('btnRun').disabled=true;

  // Process files sequentially then analyze
  processFileQueue(queueEntries, 0, () => {
    try{
      const lys = buildAnalysisLayers();
      if(lys.length < 1){ toast('Sin datos válidos para analizar','err'); return; }
      S.analysis = compute(lys);
      renderResults();
      document.getElementById('results').style.display='block';
      document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
      showTodayBanner();
      toast(`✅ ${lys.length} períodos analizados · ${S.analysis.noVolvieron.length.toLocaleString()} para recontactar`,'ok');
    }catch(e){toast('Error: '+e.message,'err');console.error(e);}
    document.getElementById('loadingRow').style.display='none';
    document.getElementById('btnRun').disabled=false;
  });
}

function processFileQueue(entries, idx, done) {
  if(idx >= entries.length){ done(); return; }
  const entry = entries[idx];
  const mes = entry.override?.mes || entry.detected.mes;
  const year = entry.override?.year || entry.detected.year;
  const mesNum = MO.indexOf(mes);
  if(!mes || !year){ processFileQueue(entries, idx+1, done); return; }

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(e.target.result, {type:'array', cellDates:true});
      const ws = wb.Sheets[wb.SheetNames[0]];
      // Find header row (first row with 'Placa')
      const range = XLSX.utils.decode_range(ws['!ref']||'A1:A1');
      let headerRow = 0;
      for(let r=range.s.r; r<=Math.min(range.s.r+4, range.e.r); r++){
        const raw = XLSX.utils.sheet_to_json(ws,{header:1,range:r,defval:''})[0]||[];
        if(raw.some(v=>String(v).toLowerCase().includes('placa'))){ headerRow=r; break; }
      }
      const raw = XLSX.utils.sheet_to_json(ws,{header:1,range:headerRow,defval:''});
      const hdrs = (raw[0]||[]).map(h=>String(h).toLowerCase().trim());
      const get = (row,...keys) => { for(const k of keys){ const i=hdrs.findIndex(h=>h.includes(k)); if(i>=0&&row[i]!=null) return String(row[i]).trim(); } return ''; };
      const rows = [];
      for(let i=1;i<raw.length;i++){
        const row=raw[i];
        const placa=get(row,'placa'); if(!placa||placa.toLowerCase()==='placa') continue;
        const aprobada=get(row,'aprobada','resultado');
        const aprobado=aprobada.toUpperCase()==='APROBADO'||aprobada.toUpperCase()==='SI';
        const fechaStr=get(row,'fecha final','fecha inicio','fecha');
        let fechaDate=null;
        if(fechaStr){const d=new Date(fechaStr);if(!isNaN(d))fechaDate=d;}
        let vencDate=null;
        if(aprobado&&fechaDate){vencDate=new Date(fechaDate);vencDate.setFullYear(vencDate.getFullYear()+1);}
        rows.push({
          Placa:placa.toUpperCase().replace(/\s/g,''),
          Propietario:get(row,'propietario'),
          Identificacion:get(row,'identificacion'),
          Telefono:get(row,'telefono'),Correo:get(row,'correo'),
          Clase:get(row,'clase'),Servicio:get(row,'servicio'),
          Marca:get(row,'marca'),Linea:get(row,'linea'),
          Modelo:get(row,'modelo'),Color:get(row,'color'),Ciudad:get(row,'ciudad'),
          Aprobado:aprobado,Resultado:aprobada,
          FechaFinal:fechaStr,
          FechaDate:fechaDate?fechaDate.toISOString():null,
          VencDate:vencDate?vencDate.toISOString():null,
          Mes:mes, MesNum:mesNum, Year:year,
        });
      }
      const aprobados = rows.filter(r=>r.Aprobado);
      const byP = {};
      aprobados.forEach(r=>{ if(!byP[r.Placa]||r.FechaFinal>byP[r.Placa].FechaFinal) byP[r.Placa]=r; });
      const key = `${mes} ${year}`;
      S.periods[key] = { label: key, year, month: mes, monthNum: mesNum, rows, deduped: Object.values(byP) };
      S.selectedPeriods.add(key);
      if(S.folderId) savePeriodToDrive(key, rows);
    } catch(err){ toast('Error en '+entry.file.name+': '+err.message,'err'); console.error(err); }
    processFileQueue(entries, idx+1, done);
  };
  reader.readAsArrayBuffer(entry.file);
}

function buildAnalysisLayers() {
  // v13: group periods by YEAR, aggregate all selected months per year
  // so "Enero 2024 + Febrero 2024" → one layer "2024"
  // This allows cross-year comparison while supporting month filter
  const yearMap = {}; // year → { rows[], deduped{} }
  const sortedKeys = [...S.selectedPeriods].sort((a,b)=>{
    // Sort by year then month
    const pa = S.periods[a], pb = S.periods[b];
    if(!pa||!pb) return 0;
    if(pa.year !== pb.year) return pa.year - pb.year;
    return pa.monthNum - pb.monthNum;
  });
  sortedKeys.forEach(key => {
    const p = S.periods[key]; if(!p) return;
    // Apply month filter if set
    if(S.filterMes && p.month !== S.filterMes) return;
    const yr = String(p.year);
    if(!yearMap[yr]) yearMap[yr] = { label: yr, year: p.year, rows: [], dedupedMap: {} };
    p.rows.filter(r=>r.Aprobado).forEach(r=>{
      yearMap[yr].rows.push(r);
      // Keep latest per placa per year
      if(!yearMap[yr].dedupedMap[r.Placa]||r.FechaFinal>yearMap[yr].dedupedMap[r.Placa].FechaFinal)
        yearMap[yr].dedupedMap[r.Placa] = r;
    });
  });
  return Object.values(yearMap)
    .sort((a,b)=>a.year-b.year)
    .map(y=>({ label: y.label, year: y.year, allRows: y.rows, filtered: y.rows, deduped: Object.values(y.dedupedMap) }));
}


function renderMonthFilterBar() {
  const months = getAvailableMonths();
  const chipsEl = document.getElementById('mfbChips');
  if(!chipsEl) return;
  // Populate venc filter select
  const vSel = document.getElementById('filterVencMes');
  if(vSel && vSel.options.length <= 1) {
    MO.forEach(m => { const o = document.createElement('option'); o.value=m; o.textContent=m; vSel.appendChild(o); });
  }
  const all = `<div class="mfb-chip ${!S.filterMes?'active':''}" onclick="setMesFilter(null)">Todos</div>`;
  const chips = months.map(m =>
    `<div class="mfb-chip ${S.filterMes===m?'active':''}" onclick="setMesFilter('${m}')">${m}</div>`
  ).join('');
  chipsEl.innerHTML = all + chips;
  // Populate venc filter with current year months
  if(vSel) vSel.value = S.filterVencMes || '';
}

function setMesFilter(mes) {
  S.filterMes = mes;
  renderMonthFilterBar();
  if(S.analysis) reRunAnalysis();
}
function setVencFilter(mes) {
  S.filterVencMes = mes || null;
  if(S.analysis) { applyVencFilter(); showTab(S.activeTab||'nov'); }
}
function applyVencFilter() {
  // Post-filter analysis results by vencimiento month
  if(!S.filterVencMes || !S.analysis) return;
  const targetMes = MO.indexOf(S.filterVencMes);
  const filterFn = arr => arr.filter(r => {
    const v = getVenc(r.Placa, r);
    return v.date && v.date.getMonth() === targetMes;
  });
  S.analysis._filtered = {
    noVolvieron: filterFn(S.analysis.noVolvieron),
    recurrentes: filterFn(S.analysis.recurrentes),
    nuevos: filterFn(S.analysis.nuevos),
  };
}
function reRunAnalysis() {
  const lys = buildAnalysisLayers();
  if(!lys.length){ toast('Sin períodos para el mes seleccionado','err'); return; }
  S.analysis = compute(lys);
  if(S.filterVencMes) applyVencFilter();
  renderResults();
  renderMonthFilterBar();
  if(S.activeTab) showTab(S.activeTab);
  toast('✅ Análisis actualizado','ok');
}

// RUNT pendientes: move to next month
function moverARunt(placa, mesDestino) {
  if(!S.runtPendientes) S.runtPendientes = {};
  S.runtPendientes[placa] = { mesDestino, fechaCreacion: new Date().toISOString() };
  if(!GESTION[placa]) GESTION[placa] = {estado:'pendiente',contactos:[]};
  GESTION[placa].runtPendiente = { mesDestino };
  GESTION[placa].nota = (GESTION[placa].nota||'') + ` [RUNT pendiente → ${mesDestino}]`;
  persistGestion();
  renderRuntBanner();
  toast(`📋 ${placa} movido a pendientes de ${mesDestino}`,'ok');
}
function renderRuntBanner() {
  const el = document.getElementById('runtBanner'); if(!el) return;
  const pendientes = Object.entries(GESTION).filter(([,g])=>g.runtPendiente);
  if(!pendientes.length){ el.style.display='none'; return; }
  el.style.display='block';
  el.innerHTML = `<div class="runt-banner">
    <div class="rb-title">⚠️ Pendientes de verificar en RUNT (${pendientes.length})</div>
    ${pendientes.map(([placa,g])=>{
      const row = S.analysis?.matrix?.find(r=>r.Placa===placa);
      return `<div class="rb-item">
        <span class="rb-placa">${placa}</span>
        <span class="rb-info">${row?.Propietario||''} · ${row?.Marca||''}</span>
        <span style="font-size:10px;color:var(--na)">→ ${g.runtPendiente.mesDestino}</span>
        <button class="rb-confirmar" onclick="confirmarRunt('${placa}')">✓ Confirmado</button>
        <a href="https://www.runt.com.co" target="_blank" style="font-size:10px;color:var(--az);font-weight:700">RUNT →</a>
      </div>`;
    }).join('')}
  </div>`;
}
function openMoverRunt(placa) {
  const row = S.analysis?.matrix?.find(r=>r.Placa===placa);
  const nombre = row?.Propietario || placa;
  const opts = MO.map(m=>`<option value="${m}">${m}</option>`).join('');
  // Simple inline modal via toast-style overlay
  const existing = document.getElementById('moverRuntPanel');
  if(existing) existing.remove();
  const div = document.createElement('div');
  div.id = 'moverRuntPanel';
  div.style.cssText = 'position:fixed;bottom:80px;right:24px;background:#fff;border:2px solid #fdba74;border-radius:12px;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,.2);z-index:9999;min-width:260px';
  div.innerHTML = `<div style="font-size:12px;font-weight:700;color:var(--na);margin-bottom:10px">📋 Mover RUNT pendiente</div>
    <div style="font-size:11px;color:var(--txt2);margin-bottom:10px">${h(nombre)} · ${placa}</div>
    <div style="font-size:11px;margin-bottom:6px">Asignar a mes de gestión:</div>
    <select id="mrSel" style="width:100%;border:1.5px solid var(--bd);border-radius:7px;padding:6px;font-family:var(--font);font-size:12px;margin-bottom:10px">${opts}</select>
    <div style="display:flex;gap:6px">
      <button onclick="moverARunt('${placa}',document.getElementById('mrSel').value);document.getElementById('moverRuntPanel').remove()" style="flex:1;background:var(--na);color:#fff;border:none;border-radius:7px;padding:7px;font-weight:700;cursor:pointer;font-family:var(--font)">Mover</button>
      <button onclick="document.getElementById('moverRuntPanel').remove()" style="background:var(--bg);border:1.5px solid var(--bd);border-radius:7px;padding:7px 12px;cursor:pointer;font-family:var(--font)">Cancelar</button>
    </div>`;
  document.body.appendChild(div);
}
function confirmarRunt(placa) {
  if(GESTION[placa]?.runtPendiente) delete GESTION[placa].runtPendiente;
  persistGestion();
  renderRuntBanner();
  openModal(placa); // open to confirm actual date
  toast('Confirma la fecha real del RUNT en el modal','ok');
}

function getAvailableMonths() {
  const months = new Set();
  Object.values(S.periods).forEach(p=>{ if(p.month) months.add(p.month); });
  return MO.filter(m=>months.has(m));
}
function getAvailableYears() {
  const years = new Set();
  Object.values(S.periods).forEach(p=>{ if(p.year) years.add(p.year); });
  return [...years].sort();
}

// ════════════════════════════════════════════════════════════
// COMPUTE
// ════════════════════════════════════════════════════════════
function compute(lys){
  const ymaps=lys.map(y=>{const m={};(y.deduped||[]).forEach(r=>{m[r.Placa]=r;});return{label:y.label,map:m};});
  const all=new Set();ymaps.forEach(ym=>Object.keys(ym.map).forEach(p=>all.add(p)));
  const recurrentes=[],parciales=[],noVolvieron=[],nuevos=[],matrix=[];
  all.forEach(placa=>{
    const pres=ymaps.map(ym=>!!ym.map[placa]);
    const enTodos=pres.every(Boolean);
    const enUltimo=pres[pres.length-1];
    const cuenta=pres.filter(Boolean).length;
    let info=null;for(let i=ymaps.length-1;i>=0;i--){if(ymaps[i].map[placa]){info=ymaps[i].map[placa];break;}}
    const row={...info,Placa:placa,_cnt:cuenta,_yrs:ymaps.filter((_,i)=>pres[i]).map(ym=>ym.label).join(', ')};
    ymaps.forEach((ym,i)=>{
      row[`_p${i}`]=pres[i]?'SI':'';
      row[`_r${i}`]=ym.map[placa]?.Resultado||'';
      row[`_m${i}`]=ym.map[placa]?.Mes||'';
      const vd=ym.map[placa]?.VencDate;
      row[`_v${i}`]=vd?(vd instanceof Date?vd:new Date(vd)):null;
    });
    let _vLast=null;for(let i=ymaps.length-1;i>=0;i--){if(row[`_v${i}`]){_vLast=row[`_v${i}`];break;}}
    row._vLast=_vLast;
    matrix.push(row);
    if(enTodos) recurrentes.push(row);
    else if(pres[0]&&!enUltimo) noVolvieron.push(row);
    else if(!pres[0]&&enUltimo) nuevos.push(row);
    else if(cuenta>=2) parciales.push(row);
  });
  noVolvieron.sort((a,b)=>{
    const va=getVenc(a.Placa,a).date||new Date('2099');
    const vb=getVenc(b.Placa,b).date||new Date('2099');
    return va-vb;
  });
  const statsByYear=ymaps.map((ym,i)=>{
    const rows=lys[i].filtered||[];
    return{label:ym.label,total:Object.keys(ym.map).length,totalRevs:rows.length,
      byClase:cntBy(Object.values(ym.map),'Clase'),byMarca:cntBy(Object.values(ym.map),'Marca'),
      byMes:cntByMes(rows),byServ:cntBy(Object.values(ym.map),'Servicio')};
  });
  // Fidelizacion: clientes 2+ years
  const fidelMap={g2:[],g3:[],g4:[],g5:[]};
  matrix.forEach(r=>{
    const cnt=r._cnt;
    if(cnt>=5&&ymaps.length>=5)fidelMap.g5.push(r);
    else if(cnt>=4&&ymaps.length>=4)fidelMap.g4.push(r);
    else if(cnt>=3&&ymaps.length>=3)fidelMap.g3.push(r);
    else if(cnt>=2)fidelMap.g2.push(r);
  });
  const fidelizacion={...fidelMap,total:fidelMap.g2.length+fidelMap.g3.length+fidelMap.g4.length+fidelMap.g5.length};
  // Extended stats
  const vencidosCount=matrix.filter(r=>{const v=getVenc(r.Placa,r).date;return v&&v<new Date();}).length;
  const urgentesCount=matrix.filter(r=>{const v=getVenc(r.Placa,r).date;if(!v)return false;const d=Math.ceil((v-new Date())/(864e5));return d>=0&&d<=DIAS_LLAMAR;}).length;
  return{ymaps,recurrentes,parciales,noVolvieron,nuevos,matrix,statsByYear,total:all.size,fidelizacion,vencidosCount,urgentesCount};
}
function cntBy(arr,k){const m={};arr.forEach(r=>{const v=(r[k]||'Sin dato').trim()||'Sin dato';m[v]=(m[v]||0)+1;});return Object.entries(m).sort((a,b)=>b[1]-a[1]);}
function cntByMes(arr){const m={};arr.forEach(r=>{if(r.Mes)m[r.Mes]=(m[r.Mes]||0)+1;});return MO.filter(mes=>m[mes]).map(mes=>[mes,m[mes]]);}

// ════════════════════════════════════════════════════════════
// VENCIMIENTO + OVERRIDE
// ════════════════════════════════════════════════════════════
function getVenc(placa, row){
  const override=GESTION[placa]?.vencOverride;
  if(override) return{date:new Date(override),isManual:true,isEstimada:false};
  if(row?._vLast){
    const d=row._vLast instanceof Date?row._vLast:new Date(row._vLast);
    // Si la fecha calculada es de un año anterior al actual, proyectar +1 año adicional
    // Esto cubre clientes de 2024 cuya revisión "venció" en 2025 y aún no han vuelto
    const currentYear=new Date().getFullYear();
    if(d.getFullYear()<currentYear){
      // Proyectar: misma fecha pero año actual (estimado, pendiente confirmar RUNT)
      const projected=new Date(d);
      projected.setFullYear(currentYear);
      return{date:projected,isManual:false,isEstimada:true,originalDate:d};
    }
    return{date:d,isManual:false,isEstimada:false};
  }
  return{date:null,isManual:false,isEstimada:false};
}
function saveVencOverride(placa,dateStr){
  if(!GESTION[placa])GESTION[placa]={estado:'pendiente',contactos:[]};
  GESTION[placa].vencOverride=dateStr;persistGestion();
}
function clearVencOverride(placa){if(GESTION[placa])delete GESTION[placa].vencOverride;persistGestion();}
function showVencEditor(placa){const el=document.getElementById(`ve_${placa}`);if(el)el.style.display=el.style.display==='none'?'flex':'none';}
function applyVencOverride(placa){
  const inp=document.getElementById(`vi_${placa}`);
  if(!inp?.value){toast('Selecciona una fecha','err');return;}
  saveVencOverride(placa,inp.value);
  const row=S.analysis?.matrix?.find(r=>r.Placa===placa);
  if(row){renderMVenc(placa,row);refreshVencCells();}
  toast('✅ Fecha actualizada','ok');showTodayBanner();
}
function vencCell(_, placa, row){
  const v=getVenc(placa,row);
  if(!v.date){
    if(placa)return`<div class="venc-edit-wrap"><span class="dash">Sin fecha</span><button class="btn-edit-venc" onclick="openModal('${placa}')">✏️ Agregar</button></div>`;
    return'<span class="dash">—</span>';
  }
  const now=new Date(),d=v.date,diff=Math.ceil((d-now)/(1000*60*60*24));
  const fecha=d.toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'numeric'});
  const llamarD=new Date(d);llamarD.setDate(llamarD.getDate()-DIAS_LLAMAR);
  const llamarFmt=llamarD.toLocaleDateString('es-CO',{day:'2-digit',month:'short'});
  let cls,lbl;
  if(diff<0){cls='v-vencido';lbl=`⛔ Vencido (${Math.abs(diff)}d)`;}
  else if(diff<=DIAS_LLAMAR){cls='v-urgente';lbl=`🔴 ¡Llamar ya! (${diff}d)`;}
  else if(diff<=30){cls='v-pronto';lbl=`🟡 Llamar antes del ${llamarFmt}`;}
  else{cls='v-ok';lbl=`🟢 Llamar el ${llamarFmt}`;}
  const manTag=v.isManual?'<span class="venc-manual-badge">✏️ Manual</span>':
               v.isEstimada?`<span class="venc-estimada-badge">⚠️ Estimada</span>`:'';
  const runtBtn=v.isEstimada&&placa?`<button style="font-size:9px;padding:2px 6px;border:1px solid #fdba74;border-radius:4px;background:#fff7ed;color:var(--na);cursor:pointer;margin-left:4px" onclick="openMoverRunt('${placa}')">📋 Mover mes</button>`:'';
  return`<div class="venc-edit-wrap"><div class="venc"><span class="venc-fecha">${fecha}</span><span class="venc-dias ${cls}">${lbl}</span></div><div style="display:flex;align-items:center;gap:2px">${manTag}${runtBtn}</div></div>`;
}
function vencText(vDate){if(!vDate)return'—';return new Date(vDate).toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'});}
function llamarFechaLabel(vDate){if(!vDate)return'';const d=new Date(vDate);d.setDate(d.getDate()-DIAS_LLAMAR);return d.toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'numeric'});}
function renderMVenc(placa,row){
  const v=getVenc(placa,row);const el=document.getElementById('mVenc');if(!el)return;
  const ds=v.date?v.date.toISOString().slice(0,10):'';
  const runtWarning=v.isEstimada?`
    <div style="background:#fff7ed;border:1.5px solid #fdba74;border-radius:8px;padding:9px 12px;margin:8px 0;font-size:11px;color:#7c2d12;line-height:1.6">
      <strong>⚠️ Fecha ESTIMADA — Solo último dato 2024</strong><br>
      La app proyectó el vencimiento asumiendo que este cliente renovó normalmente (fecha 2024 + 1 año = 2025 vencido, proyectado a 2026). 
      <strong>Debes confirmar la fecha real en RUNT</strong> antes de llamar.<br>
      <a href="https://www.runt.com.co" target="_blank" style="color:#7c2d12;font-weight:700;text-decoration:underline">→ Consultar en RUNT.com.co</a> · 
      Busca la placa <strong>${placa}</strong> y actualiza abajo.
    </div>`:'';
  el.innerHTML=`<div class="venc-info" style="${v.isEstimada?'border-color:#fdba74;background:#fff7ed':''}"><span>⏱</span><div style="flex:1">
    <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
      <strong>Vencimiento RTM: ${v.date?vencText(v.date):'<span style="color:var(--txt3)">Sin fecha</span>'}</strong>
      ${v.isManual?'<span class="venc-manual-badge">✏️ Manual</span>':v.isEstimada?'<span class="venc-estimada-badge">⚠️ Estimada</span>':''}
      ${v.isManual?`<button class="btn-edit-venc" onclick="clearVencOverride('${placa}');const r=S.analysis.matrix.find(x=>x.Placa==='${placa}');renderMVenc('${placa}',r);refreshVencCells()">↺ Usar calculada</button>`:''}
    </div>
    ${runtWarning}
    ${v.date&&!v.isEstimada?`<div style="font-size:10px;color:var(--na);margin-top:2px">📞 Llamar el ${llamarFechaLabel(v.date)}</div>`:''}
    <button class="btn-edit-venc" style="margin-top:4px" onclick="showVencEditor('${placa}')">
      ✏️ ${v.isManual?'Cambiar fecha':v.isEstimada?'Confirmar fecha real (RUNT)':'Corregir fecha'}
    </button>
    <div class="venc-override-row" id="ve_${placa}" style="display:none">
      <input type="date" id="vi_${placa}" value="${ds}" placeholder="Fecha real del RUNT">
      <button class="btn-save-venc" onclick="applyVencOverride('${placa}')">Confirmar</button>
      <button onclick="showVencEditor('${placa}')" style="background:var(--bg);color:var(--txt2);border:1.5px solid var(--bd);border-radius:6px;padding:4px 9px;font-family:var(--font);font-size:11px;cursor:pointer">Cancelar</button>
    </div>
  </div></div>`;
}
function refreshVencCells(){
  document.querySelectorAll('tbody tr').forEach(tr=>{
    const placa=tr.querySelector('.td-placa')?.textContent;
    if(!placa)return;
    const row=S.analysis?.matrix?.find(r=>r.Placa===placa);
    if(!row)return;
    tr.querySelectorAll('td').forEach(td=>{
      if(td.querySelector('.venc')||td.querySelector('.venc-edit-wrap'))
        td.innerHTML=vencCell(null,placa,row);
    });
  });
}

// ════════════════════════════════════════════════════════════
// RENDER RESULTS
// ════════════════════════════════════════════════════════════
function renderResults(){
  const a=S.analysis;
  const first=a.statsByYear[0];
  const ret=first.total>0?(a.recurrentes.length/first.total*100).toFixed(1):'0.0';
  const cp=a.ymaps.map(ym=>`<strong>${ym.label}</strong>`).join(' → ');
  document.getElementById('ctxBar').innerHTML=`🔍 Períodos: ${cp} <span style="opacity:.6">(solo aprobados)</span>`;
  const estimadasCount=a.matrix.filter(r=>{const v=getVenc(r.Placa,r);return v.isEstimada&&!v.isManual;}).length;
  const kpis=[
    {l:'Placas únicas',v:a.total.toLocaleString(),s:'en todos los períodos'},
    {l:'Recurrentes',v:a.recurrentes.length.toLocaleString(),s:'en todos los períodos'},
    {l:'Recontactar',v:a.noVolvieron.length.toLocaleString(),s:'no volvieron este año'},
    {l:'Retención',v:ret+'%',s:'del primer al último período'},
    {l:'Nuevos',v:a.nuevos.length.toLocaleString(),s:'solo en el último período'},
    {l:'🔴 Urgentes',v:(a.urgentesCount||0).toLocaleString(),s:'vencen en '+DIAS_LLAMAR+' días o menos'},
    ...(estimadasCount>0?[{l:'⚠️ Verificar RUNT',v:estimadasCount.toLocaleString(),s:'fechas estimadas de 2024'}]:[]),
  ];
  const kr=document.getElementById('kpiRow');kr.innerHTML='';
  kpis.forEach((k,i)=>{
    const d=document.createElement('div');d.className='kpi';d.style.animationDelay=`${i*.06}s`;
    d.innerHTML=`<div class="kpi-lbl">${k.l}</div><div class="kpi-val">${k.v}</div><div class="kpi-sub">${k.s}</div>`;
    kr.appendChild(d);
  });
  // Update statsbar
  const setN=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  setN('sb_urgente_n',(a.urgentesCount||0).toLocaleString());
  setN('sb_agenda_n',a.matrix.filter(r=>(GESTION[r.Placa]?.estado||'')==='agendado').length.toLocaleString());
  setN('sb_runt_n',estimadasCount.toLocaleString());
  setN('sb_recontactar_n',a.noVolvieron.length.toLocaleString());
  setN('sb_recurrentes_n',a.recurrentes.length.toLocaleString());
  setN('sb_ret_n',ret+'%');
  // Update sidebar badges
  const setSB=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  setSB('snb_nov',a.noVolvieron.length.toLocaleString());
  setSB('snb_cal',a.matrix.filter(r=>(GESTION[r.Placa]?.estado||'')==='agendado').length.toLocaleString());
  setSB('snb_rec',a.recurrentes.length.toLocaleString());
  setSB('snb_new',a.nuevos.length.toLocaleString());
  setSB('snb_par',a.parciales.length.toLocaleString());
  setSB('snb_fid',a.fidelizacion.total.toLocaleString());
  // Show sidebar nav + calendar
  document.getElementById('sideNav').style.display='block';
  document.getElementById('sideCalSection').style.display='block';
  const numYears=a.ymaps.length;
  if(numYears>=3)document.getElementById('sn_par').style.display='flex';
  // Draw sidebar mini calendar
  drawSideCalendar(a);
  // Month filter bar & RUNT banner
  renderMonthFilterBar();
  renderRuntBanner();
  const tabs=[
    {id:'nov',ico:'📞',lbl:'Recontactar',n:a.noVolvieron.length,urgent:true},
    {id:'rec',ico:'✅',lbl:'Recurrentes',n:a.recurrentes.length},
    {id:'new',ico:'🆕',lbl:'Nuevos',n:a.nuevos.length},
    ...(numYears>=3?[{id:'par',ico:'⚠️',lbl:'Parciales',n:a.parciales.length}]:[]),
    {id:'fid',ico:'🏆',lbl:`Fieles ${numYears>=2?'('+a.fidelizacion.total+')':''}`,n:null},
    {id:'mat',ico:'📋',lbl:'Matriz',n:a.total},
    {id:'hoy',ico:'📅',lbl:'Hoy',n:null},
    {id:'cal',ico:'📅',lbl:'Calendario',n:null},
    {id:'stat',ico:'📊',lbl:'Resumen',n:null},
    {id:'mes',ico:'📆',lbl:'Por mes',n:null},

  ];
  const tr=document.getElementById('tabsRow');tr.innerHTML='';
  tabs.forEach(t=>{
    const b=document.createElement('button');
    b.className='tab'+(t.urgent?' urgent':'');b.id=`tab_${t.id}`;b.onclick=()=>showTab(t.id);
    b.innerHTML=`${t.ico} ${t.lbl}${t.n!==null?`<span class="tab-n">${t.n.toLocaleString()}</span>`:''}`;
    tr.appendChild(b);
  });
  showTab('nov');
}

const PANEL_HDRS={
  nov:{ico:'📞',title:'Clientes a Recontactar',desc:'Clientes que vinieron el año anterior pero NO han regresado este año. Son la oportunidad más grande de recuperar ventas. Llama empezando por los que vencen primero (🔴 arriba).'},
  rec:{ico:'✅',title:'Clientes Recurrentes — Fieles',desc:'Han venido en TODOS los períodos cargados. Son tu base más estable. Contáctalos con anticipación para que renueven antes de vencer y no se pierdan.'},
  new:{ico:'🆕',title:'Clientes Nuevos',desc:'Aparecen por primera vez en el último período cargado. Son oportunidades de fidelización — contáctalos pronto para que el próximo año sean recurrentes.'},
  par:{ico:'⚠️',title:'Clientes Parciales',desc:'Vinieron en algunos períodos pero no en todos. Están en riesgo de perderse. Identifica por qué no volvieron en ciertos años y refuerza el contacto.'},
  mat:{ico:'📋',title:'Matriz Completa',desc:'Vista de todos los clientes con su historial período por período y estado de gestión actual. Útil para auditar y exportar la base completa.'},
  hoy:{ico:'📅',title:'Agenda del Día — Hoy',desc:'Tu lista de trabajo para hoy: seguimientos programados por ti + clientes urgentes (vencen en 8 días o menos). Empieza siempre aquí cada mañana.'},
  cal:{ico:'📅',title:'Calendario de Agenda',desc:'Vista mensual con todos los eventos: citas agendadas, vencimientos urgentes y seguimientos programados. Haz clic en un día para ver el detalle y gestionar clientes. Puedes agregar citas manuales para nuevos clientes.'},
  fid:{ico:'🏆',title:'Análisis de Fidelización — Clientes 2+ Años',desc:'Clientes que llevan 2 o más años viniendo al CDA. Segmentados por nivel de lealtad. Son tu activo más valioso — trátelos como VIP y no los pierdas.'},
  stat:{ico:'📊',title:'Resumen Estadístico Completo',desc:'Análisis profundo: tipos de vehículo, marcas, tendencias por mes, retención histórica y alertas de vencidos. Usa estas gráficas para tomar decisiones de gestión.'},
  mes:{ico:'📆',title:'Análisis por Mes',desc:'Tasa de recurrencia mes a mes: cuántos clientes de cada mes en 2024 volvieron en 2025 y 2026. Identifica qué meses tienen mayor fidelización y cuáles necesitan más gestión.'},

};
function showTab(id){
  if(!S.analysis){toast('Primero carga y analiza los períodos','err');return;}
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  document.getElementById(`tab_${id}`)?.classList.add('on');
  S.activeTab=id;
  const a=S.analysis,p=document.getElementById('mainPanel');
  const hdr=PANEL_HDRS[id];
  // Update sidebar active state
  document.querySelectorAll('.s-nav-item').forEach(el=>el.classList.remove('active'));
  const sn=document.getElementById('sn_'+id);if(sn)sn.classList.add('active');
  // Render new-style panel header
  const hdrEl=document.getElementById('mainPanelHdr');
  if(hdrEl&&hdr){
    hdrEl.innerHTML=`<div class="main-panel-hdr">
      <div class="mph-left">
        <div class="mph-title">${hdr.ico} ${hdr.title}</div>
        <div class="mph-desc">${hdr.desc}</div>
      </div>
      <div class="mph-tools" id="mph_tools_${id}"></div>
    </div>`;
  }
  const _f=a._filtered;
  if(id==='nov'){p.innerHTML=buildTable((_f&&S.filterVencMes?_f.noVolvieron:a.noVolvieron),'nov',a.ymaps,true);}
  else if(id==='rec'){p.innerHTML=buildTable((_f&&S.filterVencMes?_f.recurrentes:a.recurrentes),'rec',a.ymaps,true);}
  else if(id==='new'){p.innerHTML=buildTable((_f&&S.filterVencMes?_f.nuevos:a.nuevos),'new',a.ymaps,true);}
  else if(id==='par'){p.innerHTML=buildTable(a.parciales,'par',a.ymaps,true);}
  else if(id==='mat'){p.innerHTML='';renderMatrix(a,document.getElementById('mainPanel'));}
  else if(id==='hoy'){p.innerHTML='';renderHoy(a,document.getElementById('mainPanel'));}
  else if(id==='cal'){p.innerHTML='';renderCalendario(a,document.getElementById('mainPanel'));}
  else if(id==='fid'){p.innerHTML='';renderFidelizacion(a,document.getElementById('mainPanel'));}
  else if(id==='stat'){p.innerHTML='';renderStat(a,document.getElementById('mainPanel'));}
  else if(id==='mes'){p.innerHTML='';renderMesDash(a,document.getElementById('mainPanel'));}

}

// ════════════════════════════════════════════════════════════
// GESTIÓN BADGE
// ════════════════════════════════════════════════════════════
function gestBadge(placa){
  const g=GESTION[placa];const estado=g?.estado||'pendiente';
  const e=ESTADOS.find(x=>x.v===estado)||ESTADOS[0];
  return`<span class="gb ${e.cls}" onclick="openModal('${placa}')">${e.i} ${e.l}</span>`;
}
function refreshBadges(){
  document.querySelectorAll('.gb').forEach(el=>{
    const placa=el.closest('tr')?.querySelector('.td-placa')?.textContent;
    if(placa)el.outerHTML=gestBadge(placa);
  });
}

// ════════════════════════════════════════════════════════════
// BUILD TABLE
// ════════════════════════════════════════════════════════════
function buildTable(data,tid,ymaps,showVenc){
  if(!data.length)return`<div style="padding:40px;text-align:center;color:var(--txt3)"><div style="font-size:36px;margin-bottom:12px">📭</div><h3>Sin registros en esta vista</h3></div>`;
  const yHdrs=ymaps.map(ym=>`<th>${ym.label}</th>`).join('');
  const rows=data.map(r=>{
    const tel=r.Telefono||'';
    const telNum=tel.replace(/\D/g,'');
    const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
    const msgWA=encodeURIComponent(fillTplVariant(r));
    const telCell=tel
      ?`<div class="td-tel">${tel}</div><div class="call-row" style="margin-top:3px">
          <a class="btn-call btn-tel" href="tel:${tel}">📞 Llamar</a>
          <button class="btn-call btn-wa" onclick="openWA('${r.Placa}')">💬 WA</button>
        </div>`
      :`<span class="dash">Sin teléfono</span>`;
    const yCells=ymaps.map((_,i)=>`<td style="text-align:center">${r[`_p${i}`]==='SI'?'<span class="chk">✔</span>':'<span class="dash">—</span>'}</td>`).join('');
    const v12=getVenc(r.Placa,r);
    const v12d=v12.date;
    let v12html='';
    if(v12d){
      const now=new Date(),diff=Math.ceil((v12d-now)/(864e5));
      const fs=v12d.toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'numeric'});
      if(v12.isEstimada)v12html=`<span class="t12-venc-est">⚠️ ${fs} estim.</span>`;
      else if(diff<0)v12html=`<span class="t12-venc-urg">⛔ Vencido ${Math.abs(diff)}d</span>`;
      else if(diff<=DIAS_LLAMAR)v12html=`<span class="t12-venc-urg">🔴 ${fs} (${diff}d)</span>`;
      else if(diff<=30)v12html=`<span class="t12-venc-pronto">🟡 ${fs}</span>`;
      else v12html=`<span class="t12-venc-ok">🟢 ${fs}</span>`;
    }else{
      v12html=`<span style="font-size:10px;color:var(--txt3)">Sin fecha</span>`;
    }
    const vRow=showVenc?`<td>${v12html}</td>`:'';
    // Detect if already did revision in latest loaded year
    const latestYearLabel=ymaps[ymaps.length-1]?.label||'';
    const yaRealizo=r[`_p${ymaps.length-1}`]==='SI';
    const rowClass=yaRealizo?'row-realizo':'';
    const realizoBadge=yaRealizo
      ?`<div style="margin-top:3px"><span class="badge-realizo">✅ Ya renovó ${latestYearLabel}</span></div>
        <div style="margin-top:3px"><button class="badge-encuesta" onclick="sendGoogleReview('${r.Placa}')">⭐ Pedir reseña Google</button></div>`
      :'';
    const cc=r.Identificacion||r.Cedula||r.CedulaPropietario||r.NroDocumento||r.Documento||r.CC||r.NumeroDocumento||r.NroDoc||'';
    return`<tr class="${rowClass}" data-s="${h((r.Placa+r.Propietario+r.Marca+(r.Telefono||'')+(cc||'')).toLowerCase())}">
      <td><div class="t12-placa">${h(r.Placa)}</div></td>
      <td>
        <div class="t12-nombre">${h(r.Propietario||'—')}</div>
        ${cc?`<div class="t12-cc">CC ${h(cc)}</div>`:''}
        ${realizoBadge}
      </td>
      <td><div class="t12-veh">${h(r.Clase||'')} ${h(r.Marca||'')} ${h(r.Linea||'')}</div><div class="t12-veh" style="margin-top:1px">${h(r.Color||'')}${r.Modelo?' · '+h(r.Modelo):''}</div></td>
      <td>
        ${tel?`<div class="t12-tel">${tel}</div><div class="call-row" style="margin-top:3px">
          <a class="t12-act tel" href="tel:${tel}" title="Llamar">📞</a>
          <button class="t12-act wa" onclick="openWA('${r.Placa}')" title="WhatsApp">💬</button>
        </div>`:`<span style="color:var(--txt3);font-size:11px">Sin teléfono</span>`}
      </td>
      ${vRow}
      <td>${gestBadge(r.Placa)}</td>
      <td><div class="t12-acts">
        <button class="t12-act edit" onclick="openModal('${r.Placa}')" title="Gestionar">✏️</button>
        ${yaRealizo?`<button class="t12-act star" onclick="sendGoogleReview('${r.Placa}')" title="Pedir reseña Google">⭐</button>`:''}
      </div></td>
    </tr>`;
  }).join('');
  const gestOpts=ESTADOS.map(e=>`<option value="${e.v}">${e.i} ${e.l}</option>`).join('');
  return`
    <div class="fbar">
      <span class="fbar-lbl">Buscar:</span>
      <input type="text" placeholder="Placa, nombre…" oninput="filtTbl('${tid}',this)">
      <select onchange="filtTbl('${tid}',null)"><option value="">Estado gestión</option>${gestOpts}</select>
      <span class="fbar-cnt" id="cnt_${tid}">${data.length.toLocaleString()} registros</span>
      <button class="btn-csv" onclick="exportCSV('${tid}')">⬇ CSV</button>
    </div>
    <div class="tbl-wrap">
      <table><thead><tr>
        <th>Placa</th><th>Propietario · Vehículo</th><th>Teléfono</th>
        ${showVenc?'<th>Vencimiento · Llamar</th>':''}
        <th>Gestión</th>${yHdrs}
      </tr></thead><tbody id="tb_${tid}">${rows}</tbody></table>
    </div>`;
}
function filtTbl(tid,input){
  const fbar=document.querySelector(`#tb_${tid}`)?.closest('.panel')?.querySelector('.fbar');
  if(!fbar)return;
  const search=(fbar.querySelector('input')?.value||'').toLowerCase();
  const gest=(fbar.querySelectorAll('select')[0]?.value||'');
  let cnt=0;
  document.querySelectorAll(`#tb_${tid} tr`).forEach(tr=>{
    const placa=tr.querySelector('.td-placa')?.textContent||'';
    const gestE=GESTION[placa]?.estado||'pendiente';
    const ok=(!search||(tr.dataset.s||'').includes(search))&&(!gest||gestE===gest);
    tr.style.display=ok?'':'none';if(ok)cnt++;
  });
  const c=document.getElementById(`cnt_${tid}`);if(c)c.textContent=cnt.toLocaleString()+' registros';
}

// ════════════════════════════════════════════════════════════
// HOY
// ════════════════════════════════════════════════════════════
function showTodayBanner(){
  const today=new Date().toISOString().slice(0,10);
  const banner=document.getElementById('todayBanner');
  if(!S.analysis||!banner){if(banner)banner.style.display='none';return;}
  const list=S.analysis.matrix.filter(r=>GESTION[r.Placa]?.contactos?.some(c=>c.proxFecha===today));
  if(!list.length){banner.style.display='none';return;}
  banner.style.display='flex';
  document.getElementById('tbTitle').textContent=`Tienes ${list.length} cliente${list.length>1?'s':''} para llamar hoy`;
  document.getElementById('tbSub').textContent=list.slice(0,3).map(r=>r.Placa+' – '+(r.Propietario||'').split(' ')[0]).join(' · ')+(list.length>3?' · y '+(list.length-3)+' más':'');
}
function renderHoy(a,p){
  const today=new Date().toISOString().slice(0,10);
  const todayFmt=new Date().toLocaleDateString('es-CO',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const now=new Date();
  const seguimientos=a.matrix.filter(r=>GESTION[r.Placa]?.contactos?.some(c=>c.proxFecha===today));
  const urgentes=a.matrix.filter(r=>{
    if(GESTION[r.Placa]?.estado==='no-interesa')return false;
    const v=getVenc(r.Placa,r).date;if(!v)return false;
    return Math.ceil((v-now)/(1000*60*60*24))>=0&&Math.ceil((v-now)/(1000*60*60*24))<=DIAS_LLAMAR;
  });
  const proximos=a.matrix.filter(r=>{
    if(GESTION[r.Placa]?.estado==='no-interesa')return false;
    const v=getVenc(r.Placa,r).date;if(!v)return false;
    const d=Math.ceil((v-now)/(1000*60*60*24));return d>DIAS_LLAMAR&&d<=38;
  });
  const mkRows=(list,sNota)=>list.map(r=>{
    const tel=r.Telefono||'';const telNum=tel.replace(/\D/g,'');
    const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
    const msgWA=encodeURIComponent(fillTplVariant(r));
    const nota=sNota?(GESTION[r.Placa]?.contactos?.find(c=>c.proxFecha===today)?.nota||''):'';
    return`<tr>
      <td class="td-placa" style="font-size:12px">${h(r.Placa)}</td>
      <td><div style="font-weight:600;font-size:12px">${h(r.Propietario||'—')}</div><div style="font-size:10px;color:var(--txt2)">${h(r.Clase||'')} ${h(r.Marca||'')}</div></td>
      <td class="td-tel">${tel||'—'}</td>
      <td>${tel?`<div class="call-row"><a class="btn-call btn-tel" href="tel:${tel}">📞</a><a class="btn-call btn-wa" href="https://wa.me/${waNum}?text=${msgWA}" target="_blank">💬</a></div>`:'—'}</td>
      <td>${vencCell(null,r.Placa,r)}</td>
      <td>${gestBadge(r.Placa)}</td>
      ${sNota?`<td style="font-size:11px;color:var(--txt2);max-width:140px;white-space:normal">${h(nota)}</td>`:''}
    </tr>`;
  }).join('');
  const th=(sN)=>`<thead><tr><th>Placa</th><th>Cliente</th><th>Teléfono</th><th>Contactar</th><th>Vencimiento</th><th>Estado</th>${sN?'<th>Nota</th>':''}</tr></thead>`;
  p.innerHTML=`<div class="hoy-section">
    <div class="hoy-head" style="text-transform:capitalize">📅 ${todayFmt}</div>
    ${seguimientos.length
      ?`<div class="hoy-block seguimientos"><div class="hoy-block-title">⏰ Seguimientos hoy (${seguimientos.length})</div>
         <div class="tbl-wrap" style="max-height:240px"><table>${th(true)}<tbody>${mkRows(seguimientos,true)}</tbody></table></div></div>`
      :`<div class="hoy-block empty-block">✅ Sin seguimientos programados para hoy</div>`}
    ${urgentes.length?`<div class="hoy-block vencen"><div class="hoy-block-title">🔴 ¡Llamar urgente! — vencen en ${DIAS_LLAMAR} días (${urgentes.length})</div>
       <div class="tbl-wrap" style="max-height:240px"><table>${th(false)}<tbody>${mkRows(urgentes,false)}</tbody></table></div></div>`:''}
    ${proximos.length?`<div class="hoy-block" style="background:var(--az-l);border-color:rgba(0,56,147,.2)"><div class="hoy-block-title" style="color:var(--az)">📋 Próximos 30 días (${proximos.length})</div>
       <div class="tbl-wrap" style="max-height:240px"><table>${th(false)}<tbody>${mkRows(proximos,false)}</tbody></table></div></div>`:''}
  </div>`;
}

// ════════════════════════════════════════════════════════════
// MATRIX
// ════════════════════════════════════════════════════════════
function renderMatrix(a,p){
  const yH=a.ymaps.map(ym=>`<th>✔ ${ym.label}</th><th>Vence</th>`).join('');
  const rows=a.matrix.map(r=>{
    const yC=a.ymaps.map((_,i)=>`<td style="text-align:center">${r[`_p${i}`]==='SI'?'<span class="chk">✔</span>':'<span class="dash">—</span>'}</td><td>${r[`_p${i}`]==='SI'?vencCell(null,r.Placa,r):'<span class="dash">—</span>'}</td>`).join('');
    return`<tr data-s="${h((r.Placa+r.Propietario).toLowerCase())}">
      <td class="td-placa">${h(r.Placa)}</td>
      <td><div class="td-nombre">${h(r.Propietario||'')}</div><div style="font-size:10px;color:var(--txt2)">${h(r.Clase||'')} ${h(r.Marca||'')}</div></td>
      <td><span class="pill p-am">${r._cnt} / ${a.ymaps.length} períodos</span></td>
      <td>${gestBadge(r.Placa)}</td>${yC}
    </tr>`;
  }).join('');
  p.innerHTML=`<div class="fbar">
    <input type="text" placeholder="Placa o propietario…" oninput="filtMat(this.value)">
    <span class="fbar-cnt" id="cnt_mat">${a.matrix.length.toLocaleString()} registros</span>
    <button class="btn-csv" onclick="exportCSV('mat')">⬇ CSV</button>
  </div>
  <div class="tbl-wrap">
    <table><thead><tr><th>Placa</th><th>Propietario</th><th>Historial</th><th>Gestión</th>${yH}</tr></thead>
    <tbody id="tb_mat">${rows}</tbody></table>
  </div>`;
}
function filtMat(v){v=v.toLowerCase();let c=0;document.querySelectorAll('#tb_mat tr').forEach(tr=>{const ok=!v||(tr.dataset.s||'').includes(v);tr.style.display=ok?'':'none';if(ok)c++;});const e=document.getElementById('cnt_mat');if(e)e.textContent=c.toLocaleString()+' registros';}

// ════════════════════════════════════════════════════════════
// STATS
// ════════════════════════════════════════════════════════════
function renderStat(a,p){
  const now=new Date();
  const vencidos=a.matrix.filter(r=>{const v=getVenc(r.Placa,r).date;return v&&v<now;});
  const prox8=a.matrix.filter(r=>{const v=getVenc(r.Placa,r).date;if(!v)return false;const d=Math.ceil((v-now)/(864e5));return d>=0&&d<=DIAS_LLAMAR;});
  const prox30=a.matrix.filter(r=>{const v=getVenc(r.Placa,r).date;if(!v)return false;const d=Math.ceil((v-now)/(864e5));return d>DIAS_LLAMAR&&d<=30;});
  const C6l=['#003893','#1a6b3c','#CE1126','#c05e00','#5b21b6','#0891b2'];
  const CB=['#FCD116','#003893','#CE1126','#1a6b3c','#c05e00','#5b21b6'];
  const ret=a.statsByYear[0]?.total>0?(a.recurrentes.length/a.statsByYear[0].total*100).toFixed(1):'0.0';
  const mkBar=(items,colors,mx8=8)=>{const mx=items[0]?.[1]||1;return items.slice(0,mx8).map(([k,v],i)=>`
    <div class="bar-row"><div class="bar-lbl" title="${h(k)}">${h(k)}</div>
    <div class="bar-trk"><div class="bar-fill" style="width:${Math.round(v/mx*100)}%;background:${colors[i%colors.length]}"></div></div>
    <div class="bar-cnt">${v.toLocaleString()}</div></div>`).join('');};
  // Retención histórica bar
  const retBars=a.statsByYear.map((sy,i)=>`
    <div class="bar-row"><div class="bar-lbl">${sy.label}</div>
    <div class="bar-trk"><div class="bar-fill" style="width:${Math.min(100,Math.round(sy.total/Math.max(...a.statsByYear.map(s=>s.total))*100))}%;background:${C6l[i%C6l.length]}"></div></div>
    <div class="bar-cnt">${sy.total.toLocaleString()} placas</div></div>`).join('');
  const yrCards=a.statsByYear.map((sy,yi)=>`
    <div class="yr-stat" style="border-top-color:${C6l[yi%C6l.length]}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div><div style="font-family:var(--serif);font-size:15px;font-weight:900;color:${C6l[yi%C6l.length]}">${sy.label}</div>
          <div style="font-size:10px;color:var(--txt3)">${sy.totalRevs.toLocaleString()} revisiones · ${sy.total.toLocaleString()} placas únicas</div></div>
        <div style="text-align:right">
          <div style="font-family:var(--serif);font-size:28px;font-weight:900;color:${C6l[yi%C6l.length]}">${sy.total.toLocaleString()}</div>
          <div style="font-size:10px;color:var(--txt3)">vehículos</div>
        </div>
      </div>
      <div class="chart-row">
        <div class="cc">
          <div class="cc-hdr"><h3>🚗 Por tipo de vehículo</h3><span class="cc-sub">Top ${Math.min(sy.byClase.length,8)}</span></div>
          ${mkBar(sy.byClase,CB)}
        </div>
        <div class="cc">
          <div class="cc-hdr"><h3>🏷️ Top marcas</h3><span class="cc-sub">Top ${Math.min(sy.byMarca.length,8)}</span></div>
          ${mkBar(sy.byMarca,C6l)}
        </div>
      </div>
      ${sy.byMes.length?`<div class="cc" style="margin-top:10px">
        <div class="cc-hdr"><h3>📅 Revisiones por mes</h3><span class="cc-sub">${sy.totalRevs.toLocaleString()} total</span></div>
        ${mkBar(sy.byMes,CB,12)}
      </div>`:''}
      ${sy.byServ?.length>0?`<div class="cc" style="margin-top:10px">
        <div class="cc-hdr"><h3>🔧 Por tipo de servicio</h3></div>
        ${mkBar(sy.byServ,C6l,6)}
      </div>`:''}
    </div>`).join('');
  const hdrEl=p.querySelector('.panel-hdr');
  const statsHtml=`<div class="charts">
    <div class="stat-alerts">
      <div class="alert-card vencidos"><div class="ac-num" style="color:var(--ro)">${vencidos.length}</div><div class="ac-lbl">⛔ Ya vencidos</div></div>
      <div class="alert-card proximos"><div class="ac-num" style="color:var(--na)">${prox8.length}</div><div class="ac-lbl">🔴 Vencen ≤${DIAS_LLAMAR}d</div></div>
      <div class="alert-card ret-ok"><div class="ac-num" style="color:var(--vd)">${ret}%</div><div class="ac-lbl">📈 Retención</div></div>
      <div class="alert-card nuevos"><div class="ac-num" style="color:var(--mo)">${prox30.length}</div><div class="ac-lbl">🟡 Vencen en 30d</div></div>
    </div>
    ${a.ymaps.length>=2?`<div class="yr-stat" style="border-top-color:var(--az)">
      <div style="font-family:var(--serif);font-size:14px;font-weight:900;color:var(--az);margin-bottom:10px">📊 Evolución por período</div>
      ${retBars}
    </div>`:''}
    ${yrCards}
  </div>`;
  if(hdrEl)hdrEl.insertAdjacentHTML('afterend',statsHtml);
  else p.innerHTML+=statsHtml;
  setTimeout(()=>{p.querySelectorAll('.bar-fill').forEach((el,i)=>{const w=el.style.width;el.style.width='0';setTimeout(()=>el.style.width=w,i*12);});},80);
}

// ════════════════════════════════════════════════════════════
// RENDER MES DASHBOARD (v13)
// ════════════════════════════════════════════════════════════
function renderMesDash(a, container) {
  // Build month-by-month recurrencia stats
  const years = getAvailableYears();
  const months = getAvailableMonths();

  // For each month, count: total base year, returned in each subsequent year
  const mesStats = months.map(mes => {
    const mesNum = MO.indexOf(mes);
    const statByYear = {};
    years.forEach(yr => {
      const key = `${mes} ${yr}`;
      const p = S.periods[key];
      statByYear[yr] = p ? p.deduped.length : 0;
    });
    // Recurrencia: % of year[0] that appeared in year[N]
    const baseYear = years[0];
    const baseKey = `${mes} ${baseYear}`;
    const baseP = S.periods[baseKey];
    const basePlacas = baseP ? new Set(baseP.deduped.map(r=>r.Placa)) : new Set();
    const recurrByYear = {};
    years.slice(1).forEach(yr => {
      const key = `${mes} ${yr}`;
      const p = S.periods[key];
      if(!p || !basePlacas.size){ recurrByYear[yr]=0; return; }
      const returned = p.deduped.filter(r=>basePlacas.has(r.Placa)).length;
      recurrByYear[yr] = basePlacas.size > 0 ? Math.round(returned/basePlacas.size*100) : 0;
    });
    return { mes, mesNum, statByYear, recurrByYear, basePlacas };
  });

  // Annual totals
  const totalByYear = {};
  years.forEach(yr => {
    totalByYear[yr] = Object.values(S.periods)
      .filter(p=>p.year===yr)
      .reduce((s,p)=>s+p.deduped.length, 0);
  });

  const yearHeaders = years.map(y=>`<th style="text-align:right">${y}</th>`).join('');
  const recurrHeaders = years.slice(1).map(y=>`<th style="text-align:right">Recurrencia ${y}</th>`).join('');

  const rows = mesStats.map(ms => {
    const yCells = years.map(yr=>`<td style="text-align:right;font-family:var(--mono)">${(ms.statByYear[yr]||0).toLocaleString()}</td>`).join('');
    const rCells = years.slice(1).map(yr=>{
      const pct = ms.recurrByYear[yr]||0;
      const cls = pct>=60?'color:#15803d;font-weight:700':pct>=40?'color:var(--na);font-weight:700':'color:var(--ro)';
      return `<td style="text-align:right;font-family:var(--mono);${cls}">${pct}%</td>`;
    }).join('');
    const activeClass = S.filterMes===ms.mes?'background:var(--az-l)':'';
    return `<tr style="cursor:pointer;${activeClass}" onclick="setMesFilter(S.filterMes==='${ms.mes}'?null:'${ms.mes}')">
      <td><strong>${ms.mes}</strong></td>
      ${yCells}${rCells}
    </tr>`;
  });

  // Total row
  const totalYCells = years.map(yr=>`<td style="text-align:right;font-family:var(--mono);font-weight:700">${(totalByYear[yr]||0).toLocaleString()}</td>`).join('');

  container.innerHTML = `
    <div style="padding:16px;background:#fff;border-bottom:1px solid var(--bd)">
      <div style="font-size:11px;color:var(--txt2);margin-bottom:10px">
        💡 Haz clic en un mes para filtrar toda la app a ese mes. Recurrencia = % de clientes de ${years[0]||'año base'} que volvieron en años siguientes.
      </div>
      <div class="recurrencia-grid">
        ${mesStats.filter(ms=>years.length>=2).map(ms=>{
          const lastYear = years[years.length-1];
          const pct = ms.recurrByYear[lastYear]||0;
          const clr = pct>=60?'var(--vd)':pct>=40?'var(--na)':'var(--ro)';
          return `<div class="rec-mes-card ${S.filterMes===ms.mes?'active':''}" onclick="setMesFilter(S.filterMes==='${ms.mes}'?null:'${ms.mes}')">
            <div class="rmc-mes">${ms.mes}</div>
            <div class="rmc-pct" style="color:${clr}">${pct}%</div>
            <div class="rmc-sub">retención ${lastYear}</div>
          </div>`;
        }).join('')}
      </div>
    </div>
    <div style="padding:16px;overflow-x:auto">
      <table class="t12" style="min-width:500px">
        <thead><tr>
          <th>Mes</th>${yearHeaders}${recurrHeaders}
        </tr></thead>
        <tbody>
          ${rows.join('')}
          <tr style="border-top:2px solid var(--bd);background:#f8fafc">
            <td><strong>Total anual</strong></td>${totalYCells}
            ${years.slice(1).map(()=>'<td></td>').join('')}
          </tr>
        </tbody>
      </table>
    </div>`;
}

// ════════════════════════════════════════════════════════════
// MODAL GESTIÓN
// ════════════════════════════════════════════════════════════
function openModal(placa){
  S.modalPlaca=placa;
  const row=S.analysis?.matrix?.find(r=>r.Placa===placa);if(!row)return;
  const g=GESTION[placa]||{estado:'pendiente',contactos:[]};
  const tel=row.Telefono||'';
  const telNum=tel.replace(/\D/g,'');
  const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
  const msgWA=encodeURIComponent(fillTpl(TPLS.whatsapp,row));
  document.getElementById('mTitle').innerHTML=`${h(row.Placa)} <span style="font-size:13px;font-weight:400;color:var(--txt2)">— ${h(row.Propietario||'')}</span>`;
  // Cédula: buscar en campos comunes del Excel
  const cedula=row.Identificacion||row.Cedula||row.CedulaPropietario||row.NroDocumento||row.Documento||row.CC||row.NumeroDocumento||row.NroDoc||'';
  document.getElementById('mContact').innerHTML=`
    <div style="font-size:11px;color:var(--txt2);margin-bottom:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center">
      <span><strong>${h(row.Clase||'')} ${h(row.Marca||'')} ${h(row.Linea||'')}</strong> · ${h(row.Color||'')} · Modelo ${h(row.Modelo||'')} · 📍 ${h(row.Ciudad||'')}</span>
      ${cedula?`<span style="background:var(--az-l);color:var(--az);border:1px solid rgba(0,56,147,.2);border-radius:6px;padding:2px 8px;font-size:10px;font-weight:700">🪪 CC: ${h(cedula)}</span>`:''}
    </div>
    <div class="contact-cards">
      <div class="contact-card cc-tel">
        <div class="cc-lbl">📞 Teléfono</div>
        <div class="cc-num">${tel||'Sin número'}</div>
        ${tel?`<a class="btn-call btn-tel" href="tel:${tel}" style="display:inline-flex;padding:5px 12px">📞 Llamar ahora</a>`:''}
      </div>
      <div class="contact-card cc-wa">
        <div class="cc-lbl">💬 WhatsApp</div>
        <div class="cc-num">${tel||'Sin número'}</div>
        ${tel?(()=>{
          const vInf=getVenc(placa,row);
          const msg=fillTplVariant(row).replace(/</g,'&lt;');
          if(vInf.isEstimada){
            return`<div class="wa-msg-preview" id="waPreview_${placa}">${msg}</div>
              <div style="background:#fff7ed;border:1px solid #fdba74;border-radius:8px;padding:8px 11px;font-size:10px;color:#92400e;margin-bottom:6px;line-height:1.6">
                <strong>⚠️ Fecha estimada</strong> — Confirma primero en 
                <a href="https://www.runt.com.co" target="_blank" style="color:#92400e;font-weight:700">RUNT.com.co</a> 
                buscando la placa <strong>${placa}</strong>, luego actualiza la fecha arriba.<br>
                Si ya la confirmaste, puedes enviar el mensaje.
              </div>
              <div style="display:flex;gap:6px;flex-wrap:wrap">
                <button class="btn-wa-copy" onclick="copyMsg('${placa}')">📋 Copiar mensaje</button>
                <button class="btn-call btn-wa" onclick="openWA('${placa}')" style="display:inline-flex;padding:5px 12px;opacity:.6" title="Fecha pendiente de confirmar en RUNT">💬 Enviar igual</button>
              </div>`;
          }
          return`<div class="wa-msg-preview" id="waPreview_${placa}">${msg}</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <button class="btn-wa-copy" onclick="copyMsg('${placa}')">📋 Copiar mensaje</button>
              <button class="btn-call btn-wa" onclick="openWA('${placa}')" style="display:inline-flex;padding:5px 12px;margin-top:0">💬 Abrir WhatsApp</button>
            </div>`;
        })():''}
      </div>
    </div>`;
  renderMVenc(placa,row);
  const estOpts=ESTADOS.map(e=>`<option value="${e.v}"${g.estado===e.v?' selected':''}>${e.i} ${e.l}</option>`).join('');
  document.getElementById('mForm').innerHTML=`
    <div class="fr"><label>Estado</label><select id="mEstado" onchange="quickEstado()">${estOpts}</select></div>
    <div class="f2col">
      <div class="fr"><label>Tipo</label>
        <select id="mTipo"><option value="llamada">📞 Llamada</option><option value="whatsapp">💬 WhatsApp</option>
          <option value="sms">📱 SMS</option><option value="email">📧 Email</option><option value="visita">🚶 Visita</option></select>
      </div>
      <div class="fr"><label>Resultado</label>
        <select id="mRes"><option value="no-contestó">No contestó</option><option value="interesado">Interesado ✅</option>
          <option value="agendó-cita">Agendó cita 📅</option><option value="no-interesa">No le interesa ❌</option>
          <option value="ocupado">Ocupado / rellamar</option><option value="buzón">Buzón de voz</option>
          <option value="numero-errado">Número errado</option></select>
      </div>
    </div>
    <div class="fr"><label>Nota</label><textarea id="mNota" placeholder="Observaciones, acuerdos, próximos pasos…"></textarea></div>
    <div class="fr"><label>📅 Próximo seguimiento</label><input type="date" id="mProx" value="${new Date().toISOString().slice(0,10)}"></div>
    <button class="btn-save" onclick="saveContacto()">💾 Registrar contacto</button>`;
  renderHistorial(placa);
  document.getElementById('modalBg').classList.add('show');
}
function copyMsg(placa){
  const row=S.analysis?.matrix?.find(r=>r.Placa===placa);if(!row)return;
  const msg=fillTplVariant(row);
  navigator.clipboard.writeText(msg).then(()=>toast('Mensaje copiado — pégalo en WhatsApp Business','ok'));
}
function openWA(placa){
  const row=S.analysis?.matrix?.find(r=>r.Placa===placa);if(!row)return;
  const tel=(row.Telefono||'').replace(/\D/g,'');
  const waNum=tel.startsWith('57')?tel:'57'+tel;
  if(!tel){toast('Sin teléfono','err');return;}
  // Always copy first, then open WA (avoids encoding issues with emojis in URL)
  const msg=fillTplVariant(row);
  navigator.clipboard.writeText(msg).catch(()=>{});
  // Open WA without pre-filled text to avoid emoji corruption
  window.open('https://wa.me/'+waNum,'_blank');
  toast('Mensaje copiado — pégalo en el chat de WhatsApp','ok');
}
function quickEstado(){const p=S.modalPlaca;if(!GESTION[p])GESTION[p]={estado:'pendiente',contactos:[]};GESTION[p].estado=document.getElementById('mEstado').value;persistGestion();refreshBadges();}
async function saveContacto(){
  const p=S.modalPlaca;if(!GESTION[p])GESTION[p]={estado:'pendiente',contactos:[]};
  const g=GESTION[p];g.estado=document.getElementById('mEstado').value;
  g.contactos.unshift({tipo:document.getElementById('mTipo').value,resultado:document.getElementById('mRes').value,
    nota:document.getElementById('mNota').value.trim(),proxFecha:document.getElementById('mProx').value,
    fecha:new Date().toLocaleString('es-CO',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})});
  await persistGestion();renderHistorial(p);document.getElementById('mNota').value='';
  refreshBadges();showTodayBanner();toast('✅ Contacto guardado','ok');
}
function deleteContacto(p,i){GESTION[p]?.contactos?.splice(i,1);persistGestion();renderHistorial(p);toast('Eliminado');}
function renderHistorial(placa){
  const g=GESTION[placa];const el=document.getElementById('mHist');if(!el)return;
  if(!g?.contactos?.length){el.innerHTML='<div class="hist-wrap"><h4>Historial</h4><p style="font-size:11px;color:var(--txt2)">Sin contactos aún.</p></div>';return;}
  const rc=(r)=>{if(r?.includes('nteresado')||r?.includes('gendó'))return'ok';if(r?.includes('no-interesa')||r?.includes('errado'))return'bad';return'neutral';};
  const ti=(t)=>({llamada:'📞',whatsapp:'💬',sms:'📱',email:'📧',visita:'🚶'}[t]||'📞');
  el.innerHTML=`<div class="hist-wrap"><h4>Historial (${g.contactos.length})</h4>${g.contactos.map((c,i)=>`
    <div class="hi ${c.tipo}">
      <div class="hi-head"><span class="hi-tipo">${ti(c.tipo)} ${c.tipo}</span>
        <span class="hi-res ${rc(c.resultado)}">${c.resultado}</span>
        ${c.proxFecha?`<span class="hi-prox">📅 ${c.proxFecha}</span>`:''}
        <span class="hi-fecha">${c.fecha}</span>
        <button class="hi-del" onclick="deleteContacto('${placa}',${i})">✕</button>
      </div>${c.nota?`<div class="hi-nota">${h(c.nota)}</div>`:''}
    </div>`).join('')}</div>`;
}
function closeModal(){document.getElementById('modalBg').classList.remove('show');S.modalPlaca=null;}

// ════════════════════════════════════════════════════════════
// PLANTILLAS
// ════════════════════════════════════════════════════════════
const TPL_DEF={
  whatsapp:'{saludo} {nombre}, {intro} CDA Colombia {emoji}. La revisión técnico-mecánica de su {marca} placa *{placa}* vence *{vencimiento}* ({diasVenc}). Contamos con los precios más bajos del sector, instalaciones modernas y servicio rápido. {cierre}',
  sms:'CDA Colombia: Revisión placa {placa} vence {vencimiento}. Llámenos para agendar su cita.',
  recordatorio:'{saludo} {nombre}, le recordamos su cita en CDA Colombia para el vehículo placa {placa}. Cualquier inquietud con gusto le atendemos {emoji}'
};
let TPLS={};
try{TPLS=JSON.parse(localStorage.getItem('cda_tpls')||JSON.stringify(TPL_DEF));}catch{TPLS={...TPL_DEF};}
function fillTpl(tpl,row,variant){
  const v=getVenc(row.Placa,row);
  // Siempre mostrar la fecha (estimada o confirmada) — el cliente la necesita para sentir urgencia
  const vd=v.date?v.date.toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'}):'próximamente';
  const now=new Date();
  const diasVenc=v.date?Math.ceil((v.date-now)/(1000*60*60*24)):null;
  const dv=diasVenc!==null?(diasVenc<0?'ya venció':diasVenc===0?'hoy':'en '+diasVenc+' días'):'próximamente';
  // Anti-spam: deterministic variant based on placa hash so same client always gets same variant
  const vi=variant!==undefined?variant:(row.Placa||'').split('').reduce((a,c)=>a+c.charCodeAt(0),0)%5;
  return tpl
    .replace(/{nombre}/g,(row.Propietario||'Cliente').split(' ')[0])
    .replace(/{placa}/g,row.Placa||'')
    .replace(/{marca}/g,row.Marca||'')
    .replace(/{linea}/g,row.Linea||'')
    .replace(/{vencimiento}/g,vd)
    .replace(/{clase}/g,row.Clase||'')
    .replace(/{diasVenc}/g,dv)
    .replace(/{saludo}/g,WA_SALUDOS[vi])
    .replace(/{intro}/g,WA_INTROS[vi])
    .replace(/{cierre}/g,WA_CIERRES[vi])
    .replace(/{emoji}/g,WA_EMOJIS[vi]);
}
function fillTplVariant(row){
  // Generate one of 5 random but deterministic variants for anti-spam
  const vi=(row.Placa||'').split('').reduce((a,c)=>a+c.charCodeAt(0),0)%5;
  const tpl=TPLS.whatsapp;
  return fillTpl(tpl,row,vi);
}
function openTemplatesModal(){document.getElementById('tpl_wa').value=TPLS.whatsapp;document.getElementById('tpl_sms').value=TPLS.sms;document.getElementById('tpl_rec').value=TPLS.recordatorio;document.getElementById('tplBg').classList.add('show');}
function closeTemplatesModal(){document.getElementById('tplBg').classList.remove('show');}
function saveTemplates(){TPLS.whatsapp=document.getElementById('tpl_wa').value;TPLS.sms=document.getElementById('tpl_sms').value;TPLS.recordatorio=document.getElementById('tpl_rec').value;localStorage.setItem('cda_tpls',JSON.stringify(TPLS));closeTemplatesModal();toast('✅ Plantillas guardadas','ok');}
function resetTemplates(){document.getElementById('tpl_wa').value=TPL_DEF.whatsapp;document.getElementById('tpl_sms').value=TPL_DEF.sms;document.getElementById('tpl_rec').value=TPL_DEF.recordatorio;}

// ════════════════════════════════════════════════════════════
// SETUP MODAL
// ════════════════════════════════════════════════════════════
function openSetup(){showSetupStep(1);document.getElementById('setupBg').classList.add('show');}
function closeSetup(){document.getElementById('setupBg').classList.remove('show');}
function showSetupStep(n){
  [1,2,3].forEach(i=>{document.getElementById(`sp${i}`).style.display=i===n?'block':'none';document.getElementById(`ss${i}`).classList.toggle('on',i===n);});
  if(n===1&&localStorage.getItem('cda_clientId')) document.getElementById('cfg_clientId').value=localStorage.getItem('cda_clientId');
  if(n===3) checkSetupStatus();
}
function saveClientId(){
  const v=document.getElementById('cfg_clientId').value.trim();
  if(!v){toast('Pega tu Client ID','err');return;}
  localStorage.setItem('cda_clientId',v);
  APP_CONFIG.clientId=v;
  toast('✅ Client ID guardado — recarga la página para aplicar','ok');
  showSetupStep(2);
}
function checkSetupStatus(){
  const el=document.getElementById('setupStatus');
  const cid=localStorage.getItem('cda_clientId');
  if(!cid){el.innerHTML='⚠️ Aún no has guardado tu <strong>Client ID</strong>. Ve al paso 1.';return;}
  if(!S.folderId){el.innerHTML='⚠️ Client ID guardado, pero no estás conectado a Drive. Recarga la página e inicia sesión.';return;}
  el.innerHTML=`✅ <strong>Todo configurado.</strong><br>Client ID: <code style="font-size:10px">${cid.slice(0,30)}…</code><br>Carpeta Drive: <strong>${APP_CONFIG.folderName}</strong><br>Gestión: ${Object.keys(GESTION).length} placas guardadas.`;
}
async function testSetup(){
  const el=document.getElementById('setupStatus');
  el.innerHTML='⏳ Probando conexión con Drive…';
  try{await loadGestionFromDrive();el.innerHTML='✅ Conexión correcta con Google Drive.';}
  catch(e){el.innerHTML='❌ Error: '+h(e.message);}
}
function resetConfig(){if(!confirm('¿Borrar toda la configuración local?'))return;localStorage.clear();location.reload();}

// ════════════════════════════════════════════════════════════
// EXPORT CSV
// ════════════════════════════════════════════════════════════
function exportCSV(tid){
  const a=S.analysis;if(!a)return;
  const map={nov:a.noVolvieron,rec:a.recurrentes,new:a.nuevos,par:a.parciales,mat:a.matrix};
  const data=map[tid];if(!data?.length){toast('Sin datos','err');return;}
  const base=['Placa','Propietario','Identificacion','Telefono','Correo','Clase','Marca','Linea','Modelo','Color','Ciudad'];
  const yH=[];a.ymaps.forEach(ym=>yH.push(`Revisó_${ym.label}`,`Mes_${ym.label}`,`Venc_${ym.label}`,`Llamar_antes_${ym.label}`));
  yH.push('Estado_Gestion','Ultimo_Contacto','Ultima_Nota','Prox_Seguimiento','Venc_Override');
  const rows=data.map(r=>{
    const b=base.map(k=>`"${(r[k]||'').toString().replace(/"/g,'""')}"`);
    const y=[];a.ymaps.forEach((_,i)=>{
      const vd=r[`_v${i}`]?new Date(r[`_v${i}`]).toLocaleDateString('es-CO'):'';
      const ll=r[`_v${i}`]?llamarFechaLabel(r[`_v${i}`]):'';
      y.push(`"${r[`_p${i}`]||''}"`,`"${r[`_m${i}`]||''}"`,`"${vd}"`,`"${ll}"`);
    });
    const vEff=getVenc(r.Placa,r);const g=GESTION[r.Placa]||{};const ult=g.contactos?.[0];
    y.push(`"${g.estado||'pendiente'}"`,`"${ult?.fecha||''}"`,`"${(ult?.nota||'').replace(/"/g,'""')}"`,`"${ult?.proxFecha||''}"`,`"${g.vencOverride||''}"`);
    return[...b,...y].join(',');
  });
  const csv='\uFEFF'+[[...base,...yH].join(','),...rows].join('\n');
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  const a2=document.createElement('a');a2.href=url;a2.download=`CDA_${tid}_${new Date().toISOString().slice(0,10)}.csv`;a2.click();URL.revokeObjectURL(url);
  toast(`✅ Exportado`,'ok');
}

// ════════════════════════════════════════════════════════════
// SYNC UI
// ════════════════════════════════════════════════════════════
function setSyncState(state, label){
  const d=document.getElementById('syncDot');const l=document.getElementById('syncLabel');
  if(d){d.className='sync-dot '+state;}
  if(l)l.textContent=label||'';
}
function showSyncMsg(msg,type){
  const el=document.getElementById('syncMsg');if(!el)return;
  el.textContent=msg;el.className='sync-msg '+type;el.style.display='block';
  clearTimeout(el._t);el._t=setTimeout(()=>el.style.display='none',4000);
}

// ════════════════════════════════════════════════════════════
// HELPERS
// ════════════════════════════════════════════════════════════
function h(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg,type=''){const e=document.getElementById('notif');e.textContent=msg;e.className='notif show'+(type?' '+type:'');clearTimeout(e._t);e._t=setTimeout(()=>e.classList.remove('show'),3600);}

// ════════════════════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════════════════════

// ════════════════════════════════════════════════════════════
// AGENDA DE CITAS
// ════════════════════════════════════════════════════════════
function renderAgenda(a,container){
  const agendados=a.matrix.filter(r=>(GESTION[r.Placa]?.estado||'')==='agendado');
  const byFecha={};
  agendados.forEach(r=>{
    const g=GESTION[r.Placa];
    const ult=g?.contactos?.find(c=>c.proxFecha);
    const fecha=ult?.proxFecha||'Sin fecha';
    if(!byFecha[fecha])byFecha[fecha]=[];
    byFecha[fecha].push({row:r,nota:ult?.nota||''});
  });
  const sorted=Object.keys(byFecha).sort();
  const todayStr=new Date().toISOString().slice(0,10);
  if(!agendados.length){
    const el=container.querySelector('.panel-hdr')||container;
    el.insertAdjacentHTML('afterend',`<div class="agenda-empty">📅 Sin citas agendadas aún.<br><span style="font-size:11px;color:var(--txt3)">Cambia el estado de un cliente a "📅 Agendado" para que aparezca aquí.</span></div>`);
    return;
  }
  let html='<div class="agenda-section">';
  sorted.forEach(fecha=>{
    const isToday=fecha===todayStr;
    const fechaFmt=fecha==='Sin fecha'?'Sin fecha asignada':new Date(fecha+'T12:00:00').toLocaleDateString('es-CO',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
    const cnt=byFecha[fecha].length;
    html+=`<div class="agenda-day">
      <div class="agenda-day-hdr${isToday?' today':''}">
        <span>${isToday?'📍 HOY — ':''} ${fechaFmt.charAt(0).toUpperCase()+fechaFmt.slice(1)}</span>
        <span>${cnt} cita${cnt>1?'s':''}</span>
      </div>`;
    byFecha[fecha].forEach(({row,nota})=>{
      const tel=row.Telefono||'';const telNum=tel.replace(/\D/g,'');
      const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
      const msgWA=encodeURIComponent(fillTpl(TPLS.recordatorio,row));
      html+=`<div class="agenda-cita" onclick="openModal('${row.Placa}')">
        <div class="agenda-cita-ico">🚗</div>
        <div class="agenda-cita-info">
          <div class="agenda-cita-placa">${h(row.Placa)}</div>
          <div class="agenda-cita-nombre">${h(row.Propietario||'—')}</div>
          <div class="agenda-cita-tel">${tel||'Sin teléfono'}</div>
          ${nota?`<div class="agenda-cita-nota">📝 ${h(nota)}</div>`:''}
          <div style="font-size:10px;color:var(--txt3);margin-top:2px">${h(row.Clase||'')} ${h(row.Marca||'')} ${h(row.Linea||'')} · ${vencCell(null,row.Placa,row).replace(/<[^>]+>/g,' ').trim()}</div>
        </div>
        <div class="agenda-cita-actions">
          ${tel?`<a class="btn-call btn-tel" href="tel:${tel}" onclick="event.stopPropagation()" style="font-size:10px;padding:3px 8px">📞</a>
          <a class="btn-call btn-wa" href="https://wa.me/${waNum}?text=${msgWA}" target="_blank" onclick="event.stopPropagation()" style="font-size:10px;padding:3px 8px">💬</a>`:''}
        </div>
      </div>`;
    });
    html+='</div>';
  });
  html+='</div>';
  const hdrEl=container.querySelector('.panel-hdr');
  if(hdrEl)hdrEl.insertAdjacentHTML('afterend',html);
  else container.innerHTML+=html;
}

// ════════════════════════════════════════════════════════════
// FIDELIZACION — CLIENTES 2+ AÑOS
// ════════════════════════════════════════════════════════════
function renderFidelizacion(a,container){
  const f=a.fidelizacion;
  const numYears=a.ymaps.length;
  // Summary KPIs
  let html=`<div class="fidel-section">`;
  html+=`<div class="fidel-summary">
    <div class="fidel-kpi g2"><div class="fidel-kpi-val">${f.g2.length}</div><div class="fidel-kpi-lbl">⭐ 2 años</div></div>
    ${numYears>=3?`<div class="fidel-kpi g3"><div class="fidel-kpi-val">${f.g3.length}</div><div class="fidel-kpi-lbl">⭐⭐ 3 años</div></div>`:''}
    ${numYears>=4?`<div class="fidel-kpi g4"><div class="fidel-kpi-val">${f.g4.length}</div><div class="fidel-kpi-lbl">⭐⭐⭐ 4 años</div></div>`:''}
    ${numYears>=5?`<div class="fidel-kpi g5"><div class="fidel-kpi-val">${f.g5.length}</div><div class="fidel-kpi-lbl">👑 5+ años</div></div>`:''}
    <div class="fidel-kpi g2" style="border-color:var(--az)"><div class="fidel-kpi-val" style="color:var(--az)">${f.total}</div><div class="fidel-kpi-lbl">Total fieles</div></div>
  </div>`;
  // Insight panel
  const pct=a.total>0?(f.total/a.total*100).toFixed(1):0;
  html+=`<div style="background:var(--az-l);border-radius:var(--r2);padding:13px;font-size:11px;color:var(--az);border-left:4px solid var(--az)">
    <strong>📊 Análisis:</strong> El <strong>${pct}%</strong> de tu base (${f.total.toLocaleString()} clientes) han venido 2 o más años consecutivos. 
    Estos son tu activo más valioso — cuesta 5x más conseguir un cliente nuevo que retener uno fiel. 
    Prioriza su contacto con anticipación (mínimo 3 semanas antes del vencimiento).
  </div>`;
  // Tables by group
  const groups=[
    ...(numYears>=5&&f.g5.length?[{key:'g5',label:'👑 Clientes VIP — 5+ años seguidos',cls:'g5',rows:f.g5}]:[]),
    ...(numYears>=4&&f.g4.length?[{key:'g4',label:'⭐⭐⭐ Clientes Premium — 4 años',cls:'g4',rows:f.g4}]:[]),
    ...(numYears>=3&&f.g3.length?[{key:'g3',label:'⭐⭐ Clientes Leales — 3 años',cls:'g3',rows:f.g3}]:[]),
    ...(f.g2.length?[{key:'g2',label:'⭐ Clientes Habituales — 2 años',cls:'g2',rows:f.g2}]:[]),
  ];
  groups.forEach(g=>{
    html+=`<div><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <span class="fidel-badge ${g.cls}">${g.label}</span>
      <span style="font-size:11px;color:var(--txt2)">${g.rows.length} clientes</span>
    </div>
    <div class="tbl-wrap" style="max-height:320px">
      <table><thead><tr><th>Placa</th><th>Propietario · Vehículo</th><th>Teléfono</th><th>Vencimiento</th><th>Períodos</th><th>Gestión</th></tr></thead>
      <tbody>${g.rows.map(r=>{
        const tel=r.Telefono||'';const telNum=tel.replace(/\D/g,'');
        const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
        const msgWA=encodeURIComponent(fillTplVariant(r));
        return`<tr><td class="td-placa">${h(r.Placa)}</td>
          <td><div class="td-nombre">${h(r.Propietario||'—')}</div><div style="font-size:10px;color:var(--txt2)">${h(r.Clase||'')} ${h(r.Marca||'')} ${h(r.Linea||'')}</div></td>
          <td>${tel?`<div class="td-tel">${tel}</div><div class="call-row" style="margin-top:2px"><a class="btn-call btn-tel" href="tel:${tel}">📞</a><a class="btn-call btn-wa" href="https://wa.me/${waNum}?text=${msgWA}" target="_blank">💬</a></div>`:'<span class="dash">—</span>'}</td>
          <td>${vencCell(null,r.Placa,r)}</td>
          <td><span class="pill p-vd">${r._cnt} / ${a.ymaps.length}</span></td>
          <td>${gestBadge(r.Placa)}</td></tr>`;
      }).join('')}</tbody></table>
    </div></div>`;
  });
  html+=`</div>`;
  const hdrEl=container.querySelector('.panel-hdr');
  if(hdrEl)hdrEl.insertAdjacentHTML('afterend',html);
  else container.innerHTML+=html;
}

// ════════════════════════════════════════════════════════════
// ESTRATEGIA DE VENTAS
// ════════════════════════════════════════════════════════════
function renderEstrategia(a,container){
  const ret=a.statsByYear[0]?.total>0?(a.recurrentes.length/a.statsByYear[0].total*100).toFixed(1):'0.0';
  const html=`<div style="padding:16px;display:flex;flex-direction:column;gap:14px">
    <!-- PROPUESTA DE VALOR -->
    <div class="strategy-panel">
      <div class="strategy-header">
        <h3>🎯 Estrategia Comercial CDA Colombia</h3>
        <p>Guía de ventas basada en fortalezas reales del CDA · Actualizada para tu base actual</p>
      </div>
      <div class="strategy-body">
        <div style="font-size:11px;font-weight:700;color:var(--az);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">Propuesta de valor — ¿Por qué el cliente debe venir al CDA?</div>
        <div class="strategy-grid">
          <div class="strategy-card s1">
            <h4>💰 Precios más bajos del sector</h4>
            <p>Argumento principal de apertura. Menciona antes de que pregunte. "Tenemos las tarifas más económicas del sector sin sacrificar calidad."</p>
            <ul><li>Úsalo en la primera frase</li><li>No esperes a que pidan precio</li><li>Refuérzalo si hay duda</li></ul>
          </div>
          <div class="strategy-card s2">
            <h4>⚡ Rapidez en el servicio</h4>
            <p>El cliente valora su tiempo. "La revisión toma menos de 30 minutos — puede esperar o dejarnos el vehículo." Es un diferenciador real frente a centros con largas esperas.</p>
            <ul><li>Menciona tiempo promedio</li><li>Ofrece flexibilidad de horario</li><li>Sin citas largas de espera</li></ul>
          </div>
          <div class="strategy-card s3">
            <h4>🏢 Instalaciones modernas</h4>
            <p>Transmite confianza y profesionalismo. "Contamos con equipos de última tecnología y un espacio cómodo para que espere." Ideal para clientes que dudan de la calidad.</p>
            <ul><li>Menciona si tienen sala de espera</li><li>Equipos calibrados</li><li>Personal certificado</li></ul>
          </div>
          <div class="strategy-card s4">
            <h4>🔒 Seguridad en los resultados</h4>
            <p>Para clientes preocupados por el resultado. "La revisión es objetiva y técnica — cumplir la norma protege tu vehículo y tu tranquilidad." No vendemos aprobados, vendemos confianza.</p>
            <ul><li>Honestidad como valor</li><li>Resultados técnicos reales</li><li>Cumplimiento normativo</li></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- GUIÓN DE LLAMADA -->
    <div class="script-box">
      <h4>📞 Guión de llamada — Paso a paso (adaptar según el cliente)</h4>
      <div class="script-step"><div class="script-n">1</div><div class="script-text"><strong>Saludo personalizado:</strong> "Buenos días, ¿hablo con el propietario del vehículo placa [PLACA]?" — Si no es él: "¿Me podría comunicar con él?"</div></div>
      <div class="script-step"><div class="script-n">2</div><div class="script-text"><strong>Presentación + motivo:</strong> "Le llamamos del CDA Colombia. Le contactamos porque la revisión técnico-mecánica de su vehículo vence el [FECHA] — es decir, [X días]."</div></div>
      <div class="script-step"><div class="script-n">3</div><div class="script-text"><strong>Propuesta de valor inmediata:</strong> "Queremos avisarle con tiempo porque en el CDA tenemos los precios más bajos del sector y el servicio más rápido — en menos de 30 minutos queda listo." <em>(No esperes a que pregunte el precio)</em></div></div>
      <div class="script-step"><div class="script-n">4</div><div class="script-text"><strong>Llamado a la acción:</strong> "¿Le gustaría que le agendemos una cita esta semana para que quede tranquilo?" — Si duda: "No tiene que venir hoy, ¿cuándo le queda más cómodo?"</div></div>
      <div class="script-step"><div class="script-n">5</div><div class="script-text"><strong>Cierre o seguimiento:</strong> Si agenda: confirma fecha, envía recordatorio por WA. Si no decide: "Le envío la información por WhatsApp para que la tenga. ¿Le parece bien?" → cambia estado a En gestión + programa seguimiento.</div></div>
    </div>

    <!-- MANEJO DE OBJECIONES -->
    <div class="objection-box">
      <h4>🛡️ Manejo de objeciones — Respuestas clave</h4>
      <div class="objection-row"><div class="obj-q">"Ya lo voy a hacer yo mismo más adelante"</div><div class="obj-a">"Claro, lo entiendo. ¿Sabe que si se vence puede llevarse una multa? Le agenda para que lo haga antes y quede tranquilo — tarda menos de 30 min."</div></div>
      <div class="objection-row"><div class="obj-q">"¿Cuánto vale?"</div><div class="obj-a">"Somos el CDA más económico del sector. Le digo el valor exacto: [precio]. ¿Lo hacemos esta semana?"</div></div>
      <div class="objection-row"><div class="obj-q">"Ya lo hice en otro lado"</div><div class="obj-a">"¡Perfecto! ¿Cuándo fue? Si fue hace más de un año ya está próximo a vencer de nuevo. ¿Le avisamos cuando llegue la fecha?"</div></div>
      <div class="objection-row"><div class="obj-q">"No tengo tiempo"</div><div class="obj-a">"Por eso le llamo: la revisión toma menos de 30 minutos. ¿Qué día tiene 30 minutos libres esta semana?"</div></div>
      <div class="objection-row"><div class="obj-q">"Voy a consultar y llamo"</div><div class="obj-a">"Con gusto. Le envío los datos por WhatsApp para que los tenga. ¿Puedo llamarle el [día] para confirmar?"</div></div>
    </div>

    <!-- ESTRATEGIA POR SEGMENTO -->
    <div style="background:var(--card);border-radius:var(--r);padding:14px;box-shadow:var(--sh)">
      <div style="font-size:11px;font-weight:700;color:var(--az);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px">Estrategia por segmento de cliente — Basada en tu base actual</div>
      <table style="width:100%;border-collapse:collapse;font-size:11px">
        <thead><tr style="background:var(--az);color:#fff"><th style="padding:8px 12px;text-align:left">Segmento</th><th style="padding:8px 12px;text-align:left">N° clientes</th><th style="padding:8px 12px;text-align:left">Estrategia</th><th style="padding:8px 12px;text-align:left">Mensaje clave</th></tr></thead>
        <tbody>
          <tr style="background:var(--vd-l)"><td style="padding:8px 12px;font-weight:700;color:var(--vd)">✅ Recurrentes</td><td style="padding:8px 12px">${a.recurrentes.length}</td><td style="padding:8px 12px">Llamar 3 semanas antes. Recordatorio WA. Trato VIP.</td><td style="padding:8px 12px;color:var(--txt2)">"Como cliente fiel le avisamos con tiempo para que elija la mejor fecha."</td></tr>
          <tr style="background:var(--ro-l)"><td style="padding:8px 12px;font-weight:700;color:var(--ro)">📞 Recontactar</td><td style="padding:8px 12px">${a.noVolvieron.length}</td><td style="padding:8px 12px">Urgencia + precio. Máx. 3 intentos. Varía canal (tel/WA).</td><td style="padding:8px 12px;color:var(--txt2)">"Notamos que no ha renovado — le llamamos porque tenemos los mejores precios."</td></tr>
          <tr style="background:var(--mo-l)"><td style="padding:8px 12px;font-weight:700;color:var(--mo)">🆕 Nuevos</td><td style="padding:8px 12px">${a.nuevos.length}</td><td style="padding:8px 12px">Primera impresión. Atención premium. Pedir referido.</td><td style="padding:8px 12px;color:var(--txt2)">"Gracias por visitarnos. Para su próxima revisión le contactamos con anticipación."</td></tr>
          <tr style="background:var(--am-l)"><td style="padding:8px 12px;font-weight:700;color:#7a5200">🔴 Urgentes</td><td style="padding:8px 12px">${a.urgentesCount||0}</td><td style="padding:8px 12px">Máxima urgencia hoy. Enfatizar multa + tiempo.</td><td style="padding:8px 12px;color:var(--txt2)">"Vence en días — si no lo hace puede llevarse una multa. En 30 min queda listo."</td></tr>
        </tbody>
      </table>
    </div>

    <!-- META DIARIA -->
    <div style="background:var(--az);color:#fff;border-radius:var(--r);padding:14px 18px">
      <div style="font-family:var(--serif);font-size:15px;font-weight:900;margin-bottom:8px">📈 Meta diaria sugerida</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;font-size:11px">
        <div style="background:rgba(255,255,255,.12);border-radius:8px;padding:10px;text-align:center"><div style="font-size:22px;font-weight:900">${Math.min(a.urgentesCount||0,10)}</div><div style="opacity:.8">🔴 Urgentes a contactar</div></div>
        <div style="background:rgba(255,255,255,.12);border-radius:8px;padding:10px;text-align:center"><div style="font-size:22px;font-weight:900">20</div><div style="opacity:.8">📞 Recontactos por día</div></div>
        <div style="background:rgba(255,255,255,.12);border-radius:8px;padding:10px;text-align:center"><div style="font-size:22px;font-weight:900">40</div><div style="opacity:.8">💬 WA máx. por día</div></div>
        <div style="background:rgba(255,255,255,.12);border-radius:8px;padding:10px;text-align:center"><div style="font-size:22px;font-weight:900">${ret}%</div><div style="opacity:.8">📊 Retención actual</div></div>
      </div>
    </div>
  </div>`;
  const hdrEl=container.querySelector('.panel-hdr');
  if(hdrEl)hdrEl.insertAdjacentHTML('afterend',html);
  else container.innerHTML+=html;
}


// ════════════════════════════════════════════════════════════
// GOOGLE REVIEW — pedir reseña post-revisión
// ════════════════════════════════════════════════════════════
function sendGoogleReview(placa){
  const row=S.analysis?.matrix?.find(r=>r.Placa===placa);if(!row)return;
  const nombre=(row.Propietario||'Cliente').split(' ')[0];
  const tel=(row.Telefono||'').replace(/\D/g,'');
  const waNum=tel.startsWith('57')?tel:'57'+tel;
  if(!tel){toast('Sin teléfono para enviar','err');return;}
  const msg=`Hola ${nombre}, gracias por renovar su revisión técnico-mecánica con nosotros en CDA Colombia Sede Matatigres. Nos alegra haberle atendido.\n\nSi tuvo una buena experiencia, le agradecemos mucho si nos regala un minuto para dejarnos una resena en Google — nos ayuda a seguir mejorando y a que mas personas nos encuentren:\n${GOOGLE_REVIEW_URL}\n\nGracias por su confianza!`;
  navigator.clipboard.writeText(msg).then(()=>{
    window.open('https://wa.me/'+waNum,'_blank');
    toast('Mensaje de reseña copiado — pégalo en WhatsApp','ok');
  }).catch(()=>{
    window.open('https://wa.me/'+waNum,'_blank');
  });
}

// ════════════════════════════════════════════════════════════
// CALENDARIO DE AGENDA
// ════════════════════════════════════════════════════════════
let CAL_STATE={year:new Date().getFullYear(),month:new Date().getMonth()};

function drawSideCalendar(a){
  const wrap=document.getElementById('sideCalWrap');if(!wrap||!a)return;
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const todayStr=now.toISOString().slice(0,10);
  const monthName=new Date(year,month,1).toLocaleDateString('es-CO',{month:'long'});
  // Build event map
  const urgMap={},agMap={};
  a.matrix.forEach(r=>{
    const v=getVenc(r.Placa,r).date;
    if(v){const d=Math.ceil((v-now)/(864e5));if(d>=0&&d<=DIAS_LLAMAR){urgMap[v.toISOString().slice(0,10)]=true;}}
    const g=GESTION[r.Placa];
    if(g?.estado==='agendado'){const pf=g.contactos?.find(c=>c.proxFecha);if(pf?.proxFecha)agMap[pf.proxFecha]=true;}
  });
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const DAYS=['D','L','M','M','J','V','S'];
  let cells=DAYS.map(d=>`<div class="smc-dow">${d}</div>`).join('');
  for(let i=0;i<firstDay;i++)cells+=`<div class="smc-d smc-other"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    let cls='smc-d';
    if(ds===todayStr)cls+=' smc-today';
    else if(urgMap[ds])cls+=' smc-urgente';
    else if(agMap[ds])cls+=' smc-agendado';
    cells+=`<div class="${cls}" onclick="showTab('cal')" title="${ds}">${d}</div>`;
  }
  wrap.innerHTML=`<div class="smc-nav">
    <div class="smc-title">${monthName.charAt(0).toUpperCase()+monthName.slice(1)} ${year}</div>
    <button class="smc-btn" onclick="showTab('cal')">Ver →</button>
  </div>
  <div class="smc-grid">${cells}</div>
  <div class="smc-legend">
    <div class="smc-leg"><div class="smc-leg-dot" style="background:var(--ro)"></div>Urgente</div>
    <div class="smc-leg"><div class="smc-leg-dot" style="background:var(--az)"></div>Agendado</div>
  </div>`;
}
function renderCalendario(a,container){
  const hdrEl=container.querySelector('.panel-hdr');
  const wrap=document.createElement('div');wrap.className='cal-wrap';wrap.id='calWrap';
  if(hdrEl)hdrEl.insertAdjacentElement('afterend',wrap);
  else container.appendChild(wrap);
  CAL_STATE.year=new Date().getFullYear();CAL_STATE.month=new Date().getMonth();
  drawCalendar(a);
}

function drawCalendar(a){
  const wrap=document.getElementById('calWrap');if(!wrap)return;
  const {year,month}=CAL_STATE;
  const monthName=new Date(year,month,1).toLocaleDateString('es-CO',{month:'long',year:'numeric'});
  const todayStr=new Date().toISOString().slice(0,10);
  // Build event map: date -> {urgentes, agendados, seguimientos}
  const evMap={};
  const addEv=(dateStr,type)=>{if(!evMap[dateStr])evMap[dateStr]={urgentes:0,agendados:0,seguimientos:0};evMap[dateStr][type]++;};
  const now=new Date();
  a.matrix.forEach(r=>{
    // urgentes: vence en <=8 dias
    const v=getVenc(r.Placa,r).date;
    if(v){const d=Math.ceil((v-now)/(864e5));if(d>=0&&d<=DIAS_LLAMAR){const ds=v.toISOString().slice(0,10);addEv(ds,'urgentes');}}
    // agendados: proxFecha
    const g=GESTION[r.Placa];
    if(g?.estado==='agendado'){const pf=g.contactos?.find(c=>c.proxFecha);if(pf?.proxFecha)addEv(pf.proxFecha,'agendados');}
    // seguimientos
    if(g?.contactos){g.contactos.forEach(c=>{if(c.proxFecha&&c.proxFecha>=todayStr)addEv(c.proxFecha,'seguimientos');});}
  });
  // Also add manual clients from GESTION (clientes sin placa en matrix)
  Object.keys(GESTION).forEach(placa=>{
    const g=GESTION[placa];
    if(g?.esManual&&g?.estado==='agendado'){
      const pf=g.contactos?.find(c=>c.proxFecha);
      if(pf?.proxFecha)addEv(pf.proxFecha,'agendados');
    }
  });
  // Generate calendar
  const firstDay=new Date(year,month,1).getDay(); // 0=Sun
  const daysInMonth=new Date(year,month+1,0).getDate();
  const daysInPrev=new Date(year,month,0).getDate();
  const DAYS=['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
  let cells='';
  DAYS.forEach(d=>{cells+=`<div class="cal-dow">${d}</div>`;});
  // prev month padding
  for(let i=0;i<firstDay;i++){
    const day=daysInPrev-firstDay+1+i;
    cells+=`<div class="cal-cell other-month"><div class="cal-day">${day}</div></div>`;
  }
  // current month
  for(let day=1;day<=daysInMonth;day++){
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const ev=evMap[dateStr];
    const isToday=dateStr===todayStr;
    let cls='cal-cell';
    if(isToday)cls+=' today';
    if(ev?.urgentes)cls+=' has-urgent';
    else if(ev?.agendados)cls+=' has-agendado';
    else if(ev?.seguimientos)cls+=' has-events';
    let dots='';
    if(ev){
      if(ev.urgentes>0)dots+=`<div class="cal-dot urgente"></div>`.repeat(Math.min(ev.urgentes,3));
      if(ev.agendados>0)dots+=`<div class="cal-dot agendado"></div>`.repeat(Math.min(ev.agendados,3));
      if(ev.seguimientos>0)dots+=`<div class="cal-dot seguimiento"></div>`.repeat(Math.min(ev.seguimientos,2));
    }
    const total=(ev?.urgentes||0)+(ev?.agendados||0)+(ev?.seguimientos||0);
    cells+=`<div class="${cls}" onclick="showCalDay('${dateStr}',this)">
      <div class="cal-day">${day}</div>
      <div class="cal-dots">${dots}</div>
      ${total>3?`<div class="cal-count">+${total}</div>`:''}
    </div>`;
  }
  // next month padding
  const totalCells=firstDay+daysInMonth;const remainder=totalCells%7;
  if(remainder>0){for(let i=1;i<=7-remainder;i++)cells+=`<div class="cal-cell other-month"><div class="cal-day">${i}</div></div>`;}
  wrap.innerHTML=`
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="calNav(-1)">← Anterior</button>
      <div class="cal-title">${monthName.charAt(0).toUpperCase()+monthName.slice(1)}</div>
      <button class="cal-nav-btn" onclick="calNav(1)">Siguiente →</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:4px;font-size:10px"><div class="cal-dot urgente" style="display:inline-block"></div> Urgentes (≤${DIAS_LLAMAR}d)</div>
      <div style="display:flex;align-items:center;gap:4px;font-size:10px"><div class="cal-dot agendado" style="display:inline-block"></div> Citas agendadas</div>
      <div style="display:flex;align-items:center;gap:4px;font-size:10px"><div class="cal-dot seguimiento" style="display:inline-block"></div> Seguimientos</div>
      <button class="btn-nuevo-cliente" onclick="openNuevoCliente()" style="margin-left:auto">+ Nueva cita</button>
    </div>
    <div class="cal-grid">${cells}</div>
    <div id="calDetail"></div>`;
}

function calNav(dir){
  CAL_STATE.month+=dir;
  if(CAL_STATE.month>11){CAL_STATE.month=0;CAL_STATE.year++;}
  if(CAL_STATE.month<0){CAL_STATE.month=11;CAL_STATE.year--;}
  drawCalendar(S.analysis);
}

function showCalDay(dateStr,cell){
  // Highlight selected
  document.querySelectorAll('.cal-cell.selected-day').forEach(c=>c.classList.remove('selected-day'));
  cell.classList.add('selected-day');
  const a=S.analysis;const detail=document.getElementById('calDetail');if(!detail)return;
  const dateLabel=new Date(dateStr+'T12:00:00').toLocaleDateString('es-CO',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const todayStr=new Date().toISOString().slice(0,10);
  const isToday=dateStr===todayStr;
  // Find events for this day
  const urgentes=a.matrix.filter(r=>{
    const v=getVenc(r.Placa,r).date;
    return v&&v.toISOString().slice(0,10)===dateStr;
  });
  const agendados=a.matrix.filter(r=>{
    const g=GESTION[r.Placa];
    if(g?.estado!=='agendado')return false;
    return g.contactos?.some(c=>c.proxFecha===dateStr);
  });
  // Manual clients
  const manuales=Object.keys(GESTION).filter(p=>{
    const g=GESTION[p];
    return g?.esManual&&g.contactos?.some(c=>c.proxFecha===dateStr);
  }).map(p=>({...GESTION[p],_placa:p}));
  const seguimientos=a.matrix.filter(r=>{
    const g=GESTION[r.Placa];
    return g?.contactos?.some(c=>c.proxFecha===dateStr&&(GESTION[r.Placa]?.estado||'')==='en-gestion');
  });
  if(!urgentes.length&&!agendados.length&&!manuales.length&&!seguimientos.length){
    detail.innerHTML=`<div class="cal-detail"><div class="cal-detail-title">📅 ${dateLabel}</div><div style="font-size:12px;color:var(--txt2)">Sin eventos para este día. <button class="btn-nuevo-cliente" onclick="openNuevoCliente('${dateStr}')" style="margin-left:8px">+ Agregar cita</button></div></div>`;
    return;
  }
  const mkRow=(r,tipo)=>{
    const tel=(r.Telefono||'').replace(/\D/g,'');
    const placa=r.Placa||r._placa||'';
    const nombre=r.Propietario||r.nombre||'Cliente';
    return`<tr>
      <td class="td-placa" style="font-size:11px">${h(placa)}</td>
      <td style="font-size:11px;font-weight:500">${h(nombre)}</td>
      <td style="font-size:11px;color:var(--vd);font-family:monospace">${r.Telefono||r.telefono||'—'}</td>
      <td><span class="pill ${tipo==='urgente'?'p-ro':tipo==='agendado'?'p-az':'p-am'}">${tipo}</span></td>
      <td>${tel?`<div class="call-row"><a class="btn-call btn-tel" href="tel:${r.Telefono||r.telefono}">📞</a><button class="btn-call btn-wa" onclick="openWA('${placa}')">💬</button></div>`:'—'}</td>
      <td>${placa&&S.analysis?.matrix?.find(x=>x.Placa===placa)?gestBadge(placa):'—'}</td>
    </tr>`;
  };
  const rows=[
    ...urgentes.map(r=>mkRow(r,'urgente')),
    ...agendados.map(r=>mkRow(r,'agendado')),
    ...manuales.map(r=>mkRow(r,'agendado')),
    ...seguimientos.map(r=>mkRow(r,'seguimiento')),
  ].join('');
  detail.innerHTML=`<div class="cal-detail">
    <div class="cal-detail-title" style="justify-content:space-between">
      <span>${isToday?'📍 HOY — ':''}${dateLabel}</span>
      <button class="btn-nuevo-cliente" onclick="openNuevoCliente('${dateStr}')">+ Agregar cita</button>
    </div>
    <div class="tbl-wrap" style="max-height:300px">
      <table><thead><tr><th>Placa</th><th>Cliente</th><th>Teléfono</th><th>Tipo</th><th>Contactar</th><th>Estado</th></tr></thead>
      <tbody>${rows}</tbody></table>
    </div>
  </div>`;
}

// ════════════════════════════════════════════════════════════
// NUEVO CLIENTE MANUAL
// ════════════════════════════════════════════════════════════
function openNuevoCliente(fechaSugerida){
  const fecha=fechaSugerida||new Date().toISOString().slice(0,10);
  const bg=document.getElementById('modalBg');
  document.getElementById('mTitle').innerHTML='➕ Nueva cita — Cliente externo';
  document.getElementById('mContact').innerHTML=`
    <div style="background:var(--az-l);border-radius:var(--r2);padding:10px;font-size:11px;color:var(--az);margin-bottom:10px">
      Agrega clientes que llaman a pedir cita pero no están en la base. Se guardan en Drive y aparecen en el calendario.
    </div>
    <div class="f2col">
      <div class="fr"><label>Nombre completo</label><input type="text" id="nc_nombre" placeholder="Ej: Carlos Pérez"></div>
      <div class="fr"><label>Teléfono</label><input type="tel" id="nc_tel" placeholder="3001234567"></div>
    </div>
    <div class="f2col">
      <div class="fr"><label>Placa (si tiene)</label><input type="text" id="nc_placa" placeholder="ABC123" style="text-transform:uppercase"></div>
      <div class="fr"><label>Vehículo</label><input type="text" id="nc_vehiculo" placeholder="Ej: Chevrolet Spark"></div>
    </div>`;
  document.getElementById('mVenc').innerHTML='';
  document.getElementById('mForm').innerHTML=`
    <div class="fr"><label>Nota / motivo</label><textarea id="nc_nota" placeholder="Motivo de la cita, acuerdos…"></textarea></div>
    <div class="fr"><label>Fecha de cita</label><input type="date" id="nc_fecha" value="${fecha}"></div>
    <button class="btn-save" onclick="saveNuevoCliente()">💾 Guardar cita</button>`;
  document.getElementById('mHist').innerHTML='';
  bg.classList.add('show');S.modalPlaca='__nuevo__';
}
async function saveNuevoCliente(){
  const nombre=document.getElementById('nc_nombre')?.value?.trim();
  const tel=document.getElementById('nc_tel')?.value?.trim();
  const placa=(document.getElementById('nc_placa')?.value?.trim()||'').toUpperCase();
  const vehiculo=document.getElementById('nc_vehiculo')?.value?.trim();
  const nota=document.getElementById('nc_nota')?.value?.trim();
  const fecha=document.getElementById('nc_fecha')?.value;
  if(!nombre||!tel){toast('Nombre y teléfono son obligatorios','err');return;}
  const key=placa||('NC_'+Date.now());
  if(!GESTION[key])GESTION[key]={estado:'agendado',contactos:[],esManual:true};
  GESTION[key].nombre=nombre;GESTION[key].Telefono=tel;GESTION[key].telefono=tel;
  GESTION[key].vehiculo=vehiculo||'';GESTION[key].Propietario=nombre;
  GESTION[key].contactos.unshift({tipo:'visita',resultado:'agendó-cita',nota:nota||'',proxFecha:fecha,fecha:new Date().toLocaleString('es-CO',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})});
  await persistGestion();
  closeModal();
  if(S.activeTab==='cal')drawCalendar(S.analysis);
  toast('Cita guardada correctamente','ok');
}
window.addEventListener('DOMContentLoaded', () => {
  // Always clear any stale token on load — user must click sign in
  localStorage.removeItem('cda_token');
  initGoogleAuth();
});
</script>
</body>
</html>
