<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDA Colombia â€“ GestiÃ³n Comercial</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --am:#FCD116; --az:#003893; --ro:#CE1126;
  --am-l:#fffbe8; --az-l:#eef3ff; --ro-l:#fff0f0;
  --vd:#1a6b3c; --vd-l:#e8f7ee;
  --na:#c05e00; --na-l:#fff4e5;
  --mo:#5b21b6; --mo-l:#f0ebff;
  --bg:#f5f3ef; --card:#ffffff;
  --txt:#18181b; --txt2:#71717a; --txt3:#a1a1aa;
  --bd:#e4e4e7; --bd2:#d4d4d8;
  --sh:0 1px 3px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.07);
  --sh2:0 8px 32px rgba(0,0,0,.12);
  --r:12px; --r2:8px;
  --font:'DM Sans',sans-serif;
  --serif:'Fraunces',serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--txt);min-height:100vh;line-height:1.5;-webkit-font-smoothing:antialiased}

/* â”€â”€â”€ BANDERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.flag-stripe{height:8px;background:linear-gradient(to right,var(--am) 0 40%,var(--az) 40% 70%,var(--ro) 70% 100%)}

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header{background:var(--az);color:#fff;padding:18px 32px;display:flex;align-items:center;gap:16px;position:relative;overflow:hidden}
.header::after{content:'';position:absolute;right:-40px;top:-40px;width:240px;height:240px;background:rgba(255,255,255,.04);border-radius:50%}
.h-seal{width:54px;height:54px;background:var(--am);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;box-shadow:0 0 0 4px rgba(255,255,255,.18);position:relative;z-index:1}
.h-copy{position:relative;z-index:1}
.h-copy h1{font-family:var(--serif);font-size:clamp(16px,2.2vw,24px);font-weight:900;line-height:1;letter-spacing:-.3px}
.h-copy h1 span{color:var(--am)}
.h-copy p{font-size:11px;opacity:.65;margin-top:3px;font-weight:300;letter-spacing:.2px}
.flag-mini{margin-left:auto;width:44px;height:28px;border-radius:3px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 2px 8px rgba(0,0,0,.3);flex-shrink:0;z-index:1;position:relative}
.flag-mini div:nth-child(1){flex:2;background:var(--am)}
.flag-mini div:nth-child(2){flex:1;background:var(--az)}
.flag-mini div:nth-child(3){flex:1;background:var(--ro)}

/* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{max-width:1300px;margin:0 auto;padding:28px 20px 72px}

/* â”€â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:18px;flex-wrap:wrap}
.tbtn{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:var(--r2);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;border:1.5px solid var(--bd);background:var(--card);color:var(--txt2);transition:all .18s;white-space:nowrap}
.tbtn:hover{border-color:var(--az);color:var(--az);background:var(--az-l)}
.tbtn.sheets-on{background:var(--vd-l);border-color:var(--vd);color:var(--vd)}
#syncDot{width:7px;height:7px;border-radius:50%;background:var(--bd2);display:inline-block;transition:background .3s}
#syncDot.syncing{background:var(--am);animation:pulse .8s infinite}
#syncDot.synced{background:var(--vd)}
#syncDot.error{background:var(--ro)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* â”€â”€â”€ TODAY BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.today-banner{display:none;align-items:center;gap:14px;background:var(--az);color:#fff;border-radius:var(--r);padding:14px 20px;margin-bottom:18px;animation:slideDown .35s ease}
@keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.tb-ico{font-size:28px;flex-shrink:0}
.tb-copy strong{font-size:14px;font-weight:600;display:block}
.tb-copy span{font-size:11px;opacity:.75}
.tb-btn{margin-left:auto;background:var(--am);color:var(--az);border:none;border-radius:var(--r2);padding:8px 16px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0;transition:all .18s}
.tb-btn:hover{background:#ffe066}

/* â”€â”€â”€ UPLOAD BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.upload{background:var(--card);border-radius:var(--r);border:2px dashed var(--bd);padding:28px;margin-bottom:20px;box-shadow:var(--sh);transition:border-color .2s}
.upload:hover{border-color:var(--az)}
.upload-h{font-family:var(--serif);font-size:18px;color:var(--az);margin-bottom:3px}
.upload-s{font-size:12px;color:var(--txt2);margin-bottom:20px}
.sync-msg{font-size:11px;font-weight:600;padding:5px 12px;border-radius:6px;margin-bottom:14px;display:none}
.sync-msg.ok{background:var(--vd-l);color:var(--vd)}
.sync-msg.warn{background:var(--na-l);color:var(--na)}

/* â”€â”€â”€ YEAR GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.yg{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-bottom:18px}
.yc{border:2px solid var(--bd);border-radius:var(--r);padding:14px;background:var(--bg);transition:all .22s}
.yc.loaded{border-color:var(--vd);background:var(--vd-l)}
.yc-head{display:flex;align-items:center;gap:7px;margin-bottom:10px}
.yb{background:var(--az);color:#fff;border-radius:20px;padding:2px 11px;font-size:11px;font-weight:700}
.yc.loaded .yb{background:var(--vd)}
.yi{font-size:11px;border:1.5px solid var(--bd);border-radius:6px;padding:2px 7px;font-family:var(--font);width:68px;outline:none;transition:border-color .18s}
.yi:focus{border-color:var(--az)}
.yr{margin-left:auto;cursor:pointer;color:var(--ro);font-size:13px;opacity:.6;border:none;background:none;transition:opacity .18s}
.yr:hover{opacity:1}
.fd{border:1.5px dashed var(--bd);border-radius:var(--r2);padding:12px;text-align:center;font-size:11px;color:var(--txt2);cursor:pointer;background:#fff;transition:all .18s;display:block}
.fd:hover{border-color:var(--az);color:var(--az);background:var(--az-l)}
.fd input{display:none}
.fst{margin-top:6px;font-size:10px;font-weight:600;color:var(--vd);display:none;line-height:1.4}
.yc.loaded .fst{display:block}

/* Totales por mes */
.mtots{margin-top:9px;display:none}
.yc.loaded .mtots{display:block}
.mtots-lbl{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.mtots-row{display:flex;flex-wrap:wrap;gap:3px}
.mt-chip{background:#fff;border:1px solid var(--bd);border-radius:5px;padding:2px 7px;font-size:10px;display:flex;align-items:center;gap:3px}
.mt-chip .mn{color:var(--az);font-weight:700}
.mt-chip .mc{color:var(--vd);font-weight:700}

/* Chips de mes */
.mp{margin-top:9px;display:none}
.yc.loaded .mp{display:block}
.mlbl{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.mcs{display:flex;flex-wrap:wrap;gap:3px}
.chip{padding:2px 8px;border-radius:20px;font-size:10px;font-weight:600;cursor:pointer;border:1.5px solid var(--bd);background:#fff;color:var(--txt2);transition:all .15s;user-select:none}
.chip:hover{border-color:var(--az);color:var(--az)}
.chip.on{background:var(--az);color:#fff;border-color:var(--az)}
.chip-all{border-color:var(--az);color:var(--az)}
.chip-all.on{background:var(--az);color:#fff}
.macts{display:flex;gap:5px;margin-top:5px}
.mact{font-size:9px;font-weight:600;cursor:pointer;background:none;border:none;color:var(--txt2);text-decoration:underline;padding:0}
.mact:hover{color:var(--az)}

/* â”€â”€â”€ ANALYZE BTN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.add-slot{border:2px dashed var(--am);border-radius:var(--r);padding:14px;background:var(--am-l);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-size:12px;font-weight:700;color:#7a5200;transition:all .18s}
.add-slot:hover{background:var(--am);color:#3a2600}
.btn-analyze{background:var(--az);color:#fff;border:none;border-radius:var(--r);padding:12px 28px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .2s;box-shadow:0 3px 12px rgba(0,56,147,.25);letter-spacing:.2px}
.btn-analyze:hover:not(:disabled){background:#0044b3;transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,56,147,.35)}
.btn-analyze:disabled{background:var(--bd2);color:var(--txt3);box-shadow:none;cursor:not-allowed}
.loading-row{display:none;align-items:center;gap:10px}
.prog{flex:1;height:4px;background:var(--bd);border-radius:2px;overflow:hidden;min-width:100px}
.prog-fill{height:100%;background:var(--am);border-radius:2px;animation:prog 1.3s ease infinite;width:35%}
@keyframes prog{0%{margin-left:0;width:30%}50%{margin-left:30%;width:40%}100%{margin-left:65%;width:30%}}

/* â”€â”€â”€ KPI BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:12px;margin-bottom:18px}
.kpi{background:var(--card);border-radius:var(--r);padding:16px 14px;box-shadow:var(--sh);position:relative;overflow:hidden;animation:fadeUp .4s ease both}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--az)}
.kpi:nth-child(2)::before{background:var(--vd)}
.kpi:nth-child(3)::before{background:var(--ro)}
.kpi:nth-child(4)::before{background:var(--am)}
.kpi:nth-child(5)::before{background:var(--na)}
.kpi:nth-child(6)::before{background:var(--mo)}
.kpi-lbl{font-size:10px;font-weight:600;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.kpi-val{font-family:var(--serif);font-size:28px;font-weight:900;line-height:1;color:var(--az)}
.kpi:nth-child(2) .kpi-val{color:var(--vd)}
.kpi:nth-child(3) .kpi-val{color:var(--ro)}
.kpi:nth-child(4) .kpi-val{color:#7a5200}
.kpi:nth-child(5) .kpi-val{color:var(--na)}
.kpi:nth-child(6) .kpi-val{color:var(--mo)}
.kpi-sub{font-size:10px;color:var(--txt3);margin-top:3px}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€â”€ CONTEXT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ctx-bar{background:var(--az-l);border:1px solid rgba(0,56,147,.15);border-radius:var(--r2);padding:8px 14px;margin-bottom:14px;font-size:11px;color:var(--az);display:flex;align-items:center;gap:8px;flex-wrap:wrap}

/* â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{display:flex;gap:2px;background:var(--card);border-radius:var(--r) var(--r) 0 0;padding:8px 8px 0;border-bottom:2px solid var(--az);flex-wrap:wrap}
.tab{padding:8px 16px;border:none;border-radius:6px 6px 0 0;background:transparent;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:500;color:var(--txt2);transition:all .15s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.tab:hover{background:var(--az-l);color:var(--az)}
.tab.on{background:var(--az);color:#fff;font-weight:700}
.tab.urgent{color:var(--ro)}
.tab.urgent.on{background:var(--ro);color:#fff}
.tab-n{background:rgba(255,255,255,.22);border-radius:20px;padding:1px 6px;font-size:10px;font-weight:700}
.tab:not(.on) .tab-n{background:var(--bd);color:var(--txt2)}

/* â”€â”€â”€ PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel{background:var(--card);border-radius:0 0 var(--r) var(--r);box-shadow:var(--sh);overflow:hidden;min-height:200px}

/* â”€â”€â”€ FILTER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fbar{display:flex;align-items:center;gap:8px;padding:12px 18px;background:var(--bg);border-bottom:1px solid var(--bd);flex-wrap:wrap}
.fbar-lbl{font-size:10px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.3px}
.fbar input,.fbar select{border:1.5px solid var(--bd);border-radius:var(--r2);padding:6px 10px;font-family:var(--font);font-size:11px;background:#fff;color:var(--txt);outline:none;transition:border-color .18s}
.fbar input{width:170px}
.fbar input:focus,.fbar select:focus{border-color:var(--az)}
.fbar-cnt{font-size:11px;font-weight:600;color:var(--txt2);white-space:nowrap}
.btn-csv{background:var(--vd);color:#fff;border:none;border-radius:var(--r2);padding:6px 12px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .18s;margin-left:auto;white-space:nowrap}
.btn-csv:hover{background:#145c34}

/* â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbl-wrap{overflow:auto;max-height:540px}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:var(--az);color:#fff;padding:10px 14px;text-align:left;font-weight:600;font-size:11px;white-space:nowrap;position:sticky;top:0;z-index:2;letter-spacing:.2px}
tbody tr{border-bottom:1px solid var(--bd);transition:background .12s}
tbody tr:hover{background:var(--az-l)}
tbody td{padding:11px 14px;white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
.td-placa{font-weight:700;color:var(--az);font-size:13px;letter-spacing:.5px}
.td-nombre{font-weight:500;color:var(--txt)}
.td-tel{font-family:monospace;font-size:13px;font-weight:700;color:var(--vd)}

/* â”€â”€â”€ PILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pill{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.2px}
.p-az{background:var(--az-l);color:var(--az)}
.p-vd{background:var(--vd-l);color:var(--vd)}
.p-ro{background:var(--ro-l);color:var(--ro)}
.p-am{background:var(--am-l);color:#7a5200}
.p-na{background:var(--na-l);color:var(--na)}
.p-mo{background:var(--mo-l);color:var(--mo)}

/* â”€â”€â”€ VENCIMIENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.venc{display:inline-flex;flex-direction:column;gap:1px}
.venc-fecha{font-size:11px;font-weight:600;color:var(--txt)}
.venc-dias{font-size:10px;font-weight:700;border-radius:20px;padding:1px 7px;display:inline-block;margin-top:2px}
.v-vencido{background:var(--ro-l);color:var(--ro)}
.v-urgente{background:var(--ro-l);color:var(--ro)}    /* â‰¤8 dÃ­as */
.v-pronto{background:var(--na-l);color:var(--na)}     /* 9â€“30 dÃ­as */
.v-ok{background:var(--vd-l);color:var(--vd)}         /* >30 dÃ­as */

/* â”€â”€â”€ LLAMAR AHORA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.call-row{display:flex;align-items:center;gap:6px}
.btn-call{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:6px;font-size:10px;font-weight:700;text-decoration:none;border:none;cursor:pointer;font-family:var(--font);transition:all .15s;white-space:nowrap}
.btn-tel{background:var(--vd-l);color:var(--vd);border:1px solid #86efac}
.btn-tel:hover{background:var(--vd);color:#fff}
.btn-wa{background:#e7fce8;color:#128c7e;border:1px solid #86efac}
.btn-wa:hover{background:#25d366;color:#fff}

/* â”€â”€â”€ GESTIÃ“N BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gb{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;cursor:pointer;transition:all .18s;border:1.5px solid transparent}
.gb-pte{background:#f4f4f5;color:var(--txt2);border-color:var(--bd)}
.gb-pte:hover{border-color:var(--az);color:var(--az)}
.gb-gest{background:var(--am-l);color:#7a5200;border-color:#fcd116}
.gb-cont{background:var(--vd-l);color:var(--vd);border-color:#86efac}
.gb-agend{background:var(--az-l);color:var(--az);border-color:#93c5fd}
.gb-noint{background:var(--ro-l);color:var(--ro);border-color:#fca5a5}

/* â”€â”€â”€ CHECK / DASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chk{color:var(--vd);font-size:14px;font-weight:900;line-height:1}
.dash{color:var(--bd2);font-size:12px}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:56px 20px;color:var(--txt2)}
.empty-ico{font-size:48px;margin-bottom:10px}
.empty h3{font-family:var(--serif);color:var(--az);font-size:18px;margin-bottom:4px}
.empty p{font-size:12px}

/* â”€â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.charts{padding:22px;display:flex;flex-direction:column;gap:18px}
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:680px){.chart-grid{grid-template-columns:1fr}}
.cc{background:var(--bg);border-radius:var(--r);padding:16px}
.cc h3{font-family:var(--serif);font-size:13px;color:var(--az);margin-bottom:12px;font-weight:700}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;font-size:11px}
.bar-lbl{width:110px;flex-shrink:0;color:var(--txt2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-trk{flex:1;background:var(--bd);border-radius:20px;height:10px;overflow:hidden}
.bar-fill{height:100%;border-radius:20px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.bar-cnt{width:32px;text-align:right;font-weight:700;color:var(--txt)}

/* â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.modal-bg.show{display:flex}
.modal{background:var(--card);border-radius:16px;padding:24px;max-width:520px;width:94vw;max-height:90vh;overflow-y:auto;position:relative;box-shadow:var(--sh2);animation:modalIn .22s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal h3{font-family:var(--serif);font-size:18px;color:var(--az);margin-bottom:12px;font-weight:900;padding-right:24px}
.mcl{position:absolute;top:16px;right:16px;background:none;border:none;font-size:18px;cursor:pointer;color:var(--txt2);line-height:1;transition:color .15s}
.mcl:hover{color:var(--ro)}

/* Contacto cards en modal */
.contact-cards{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
.contact-card{flex:1;min-width:150px;border-radius:var(--r);padding:14px;text-align:center}
.cc-tel{background:var(--vd-l);border:1.5px solid #86efac}
.cc-wa{background:#e7fce8;border:1.5px solid #a7f3d0}
.cc-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px}
.cc-tel .cc-lbl{color:var(--vd)}
.cc-wa .cc-lbl{color:#128c7e}
.cc-num{font-family:monospace;font-size:19px;font-weight:700;letter-spacing:.5px;margin-bottom:8px}
.cc-tel .cc-num{color:var(--vd)}
.cc-wa .cc-num{color:#128c7e}

/* Venc info en modal */
.venc-info{background:var(--am-l);border:1.5px solid var(--am);border-radius:var(--r2);padding:9px 14px;font-size:11px;margin-bottom:14px;display:flex;align-items:center;gap:8px}

/* Form */
.fr{display:flex;flex-direction:column;gap:3px;margin-bottom:10px}
.fr label{font-size:10px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.3px}
.fr input,.fr select,.fr textarea{border:1.5px solid var(--bd);border-radius:var(--r2);padding:8px 10px;font-family:var(--font);font-size:12px;color:var(--txt);outline:none;transition:border-color .18s;background:#fff}
.fr input:focus,.fr select:focus,.fr textarea:focus{border-color:var(--az)}
.fr textarea{resize:vertical;min-height:64px}
.f2col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn-save{background:var(--az);color:#fff;border:none;border-radius:var(--r);padding:10px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;width:100%;margin-top:4px;transition:all .18s;letter-spacing:.2px}
.btn-save:hover{background:#0044b3}

/* Historial */
.hist-wrap{border-top:1px solid var(--bd);margin-top:14px;padding-top:12px}
.hist-wrap h4{font-size:11px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px}
.hi{background:var(--bg);border-radius:var(--r2);padding:9px 12px;margin-bottom:6px;border-left:3px solid var(--az)}
.hi.llamada{border-left-color:var(--vd)}
.hi.whatsapp{border-left-color:#25d366}
.hi.sms{border-left-color:var(--na)}
.hi.email{border-left-color:var(--az)}
.hi.visita{border-left-color:var(--mo)}
.hi-head{display:flex;align-items:center;gap:6px;margin-bottom:3px;flex-wrap:wrap}
.hi-tipo{font-size:10px;font-weight:700;text-transform:uppercase;color:var(--txt)}
.hi-res{font-size:9px;font-weight:700;padding:1px 6px;border-radius:20px}
.hi-res.ok{background:var(--vd-l);color:var(--vd)}
.hi-res.bad{background:var(--ro-l);color:var(--ro)}
.hi-res.neutral{background:var(--bg);color:var(--txt2);border:1px solid var(--bd)}
.hi-fecha{font-size:9px;color:var(--txt3);margin-left:auto}
.hi-prox{font-size:9px;color:var(--na);font-weight:600}
.hi-nota{font-size:11px;color:var(--txt);margin-top:3px;line-height:1.4}
.hi-del{background:none;border:none;cursor:pointer;color:var(--txt3);font-size:12px;transition:color .15s;padding:0 2px;margin-left:2px}
.hi-del:hover{color:var(--ro)}

/* â”€â”€â”€ SHEETS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.info-box{background:var(--az-l);border-radius:var(--r2);padding:12px 14px;margin-bottom:14px;font-size:11px;color:var(--az);line-height:1.7}
.info-box a{color:var(--az);font-weight:600}
.btn-secondary{width:100%;margin-top:8px;background:var(--ro-l);color:var(--ro);border:1.5px solid #fca5a5;border-radius:var(--r);padding:9px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;transition:all .18s}
.btn-secondary:hover{background:var(--ro);color:#fff}

/* â”€â”€â”€ TEMPLATES MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tpl-vars{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px}
.tpl-var{background:var(--bg);border:1px solid var(--bd);border-radius:5px;padding:2px 7px;font-size:10px;font-family:monospace;color:var(--txt2)}
.btn-ghost{background:var(--bg);color:var(--txt2);border:1.5px solid var(--bd);border-radius:var(--r);padding:9px;font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:all .18s}
.btn-ghost:hover{border-color:var(--az);color:var(--az)}

/* â”€â”€â”€ HOY VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hoy-section{padding:20px}
.hoy-head{font-family:var(--serif);font-size:15px;color:var(--az);margin-bottom:12px;font-weight:700}
.hoy-block{border-radius:var(--r);padding:14px;margin-bottom:16px;border:1.5px solid}
.hoy-block.seguimientos{background:var(--vd-l);border-color:#86efac}
.hoy-block.vencen{background:var(--na-l);border-color:#fbbf24}
.hoy-block.empty-block{background:var(--bg);border-color:var(--bd);text-align:center;color:var(--txt2);font-size:12px;padding:18px}
.hoy-block-title{font-size:12px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.hoy-block.seguimientos .hoy-block-title{color:var(--vd)}
.hoy-block.vencen .hoy-block-title{color:var(--na)}

/* â”€â”€â”€ RESUMEN VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stat-alerts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px}
.alert-card{border-radius:var(--r);padding:16px;text-align:center}
.alert-card.vencidos{background:var(--ro-l);border:1.5px solid #fca5a5}
.alert-card.proximos{background:var(--na-l);border:1.5px solid #fbbf24}
.alert-card .ac-num{font-family:var(--serif);font-size:36px;font-weight:900}
.alert-card.vencidos .ac-num{color:var(--ro)}
.alert-card.proximos .ac-num{color:var(--na)}
.alert-card .ac-lbl{font-size:11px;font-weight:600;margin-top:3px}
.alert-card.vencidos .ac-lbl{color:var(--ro)}
.alert-card.proximos .ac-lbl{color:var(--na)}

/* â”€â”€â”€ YEAR STAT CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.yr-stat{background:var(--card);border-radius:var(--r);padding:18px;box-shadow:var(--sh);border-top:3px solid var(--az)}

/* â”€â”€â”€ VENC EDITABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.venc-edit-wrap{display:flex;flex-direction:column;gap:2px}
.venc-manual-badge{background:var(--mo-l);color:var(--mo);border:1.5px dashed var(--mo);border-radius:6px;padding:2px 8px;font-size:9px;font-weight:700;display:inline-block;margin-top:2px}
.btn-edit-venc{background:none;border:none;font-size:10px;color:var(--txt3);cursor:pointer;text-decoration:underline;padding:0;margin-top:2px;font-family:var(--font)}
.btn-edit-venc:hover{color:var(--mo)}
.venc-override-row{display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap}
.venc-override-row input{border:1.5px solid var(--mo);border-radius:6px;padding:4px 8px;font-family:var(--font);font-size:11px;outline:none;background:var(--mo-l)}
.venc-override-row button{padding:4px 10px;border-radius:6px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;border:none}
.btn-save-venc{background:var(--mo);color:#fff}
.btn-save-venc:hover{background:#4c1d95}
.btn-cancel-venc{background:var(--bg);color:var(--txt2);border:1.5px solid var(--bd) !important}

/* â”€â”€â”€ CONFIG STEPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cfg-step{padding:6px 12px;border:1.5px solid var(--bd);border-radius:20px;font-family:var(--font);font-size:11px;font-weight:600;cursor:pointer;background:#fff;color:var(--txt2);transition:all .18s}
.cfg-step:hover{border-color:var(--az);color:var(--az)}
.cfg-step.on{background:var(--az);color:#fff;border-color:var(--az)}

/* â”€â”€â”€ NOTIF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notif{position:fixed;bottom:18px;right:18px;background:var(--az);color:#fff;padding:10px 16px;border-radius:var(--r);font-size:12px;font-weight:500;box-shadow:var(--sh2);transform:translateY(80px);transition:transform .3s cubic-bezier(.4,0,.2,1);z-index:200;max-width:280px;line-height:1.4}
.notif.show{transform:translateY(0)}
.notif.ok{background:var(--vd)}
.notif.err{background:var(--ro)}

footer{text-align:center;padding:14px;font-size:10px;color:var(--txt3)}
footer em{color:var(--az);font-style:normal;font-weight:600}

@media(max-width:560px){
  .header{padding:12px}
  .main{padding:14px 10px 40px}
  .upload{padding:18px 14px}
  .fbar input{width:100%}
  .stat-alerts{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="flag-stripe"></div>

<header class="header">
  <div class="h-seal">ğŸš—</div>
  <div class="h-copy">
    <h1>CDA <span>Colombia</span></h1>
    <p>GestiÃ³n Comercial Â· RevisiÃ³n TÃ©cnico-MecÃ¡nica Â· RetenciÃ³n de clientes</p>
  </div>
  <div class="flag-mini"><div></div><div></div><div></div></div>
</header>

<div class="main">

  <!-- TODAY BANNER -->
  <div class="today-banner" id="todayBanner">
    <div class="tb-ico">ğŸ“…</div>
    <div class="tb-copy">
      <strong id="tbTitle">Tienes seguimientos para hoy</strong>
      <span id="tbSub"></span>
    </div>
    <button class="tb-btn" onclick="showTab('hoy')">Ver lista â†’</button>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <button class="tbtn" id="btnSheets" onclick="openSheetsModal()">
      <span id="syncDot"></span> â˜ï¸ Google Sheets
    </button>
    <button class="tbtn" onclick="openTemplatesModal()">âœï¸ Plantillas</button>
  </div>

  <!-- UPLOAD -->
  <div class="upload">
    <h2 class="upload-h">ğŸ“‚ Bases de datos por aÃ±o</h2>
    <p class="upload-s">Solo vehÃ­culos <strong>APROBADOS</strong> Â· Vencimiento = Fecha Final + 1 aÃ±o Â· La gestiÃ³n se guarda automÃ¡ticamente</p>
    <div id="syncMsg" class="sync-msg"></div>
    <div class="yg" id="yg"></div>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <button class="btn-analyze" id="btnRun" onclick="runAnalysis()" disabled>ğŸ” Analizar datos</button>
      <div class="loading-row" id="loadingRow">
        <span style="font-size:11px;color:var(--txt2)">Procesandoâ€¦</span>
        <div class="prog"><div class="prog-fill"></div></div>
      </div>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results" style="display:none">
    <div class="kpi-row" id="kpiRow"></div>
    <div class="ctx-bar" id="ctxBar"></div>
    <div class="tabs" id="tabsRow"></div>
    <div class="panel" id="mainPanel">
      <div class="empty"><div class="empty-ico">ğŸ“Š</div><h3>Selecciona una pestaÃ±a</h3></div>
    </div>
  </div>

</div><!-- /main -->

<!-- â”€â”€ MODAL GESTIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-bg" id="modalBg" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="mcl" onclick="closeModal()">âœ•</button>
    <h3 id="mTitle"></h3>
    <div id="mContact"></div>
    <div id="mVenc"></div>
    <div id="mForm"></div>
    <div id="mHist"></div>
  </div>
</div>

<!-- â”€â”€ MODAL SHEETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-bg" id="sheetsBg" onclick="if(event.target===this)closeSheetsModal()">
  <div class="modal" style="max-width:520px">
    <button class="mcl" onclick="closeSheetsModal()">âœ•</button>
    <h3>â˜ï¸ Conectar Google Sheets</h3>

    <!-- STEP TABS -->
    <div style="display:flex;gap:4px;margin-bottom:16px" id="cfgSteps">
      <button class="cfg-step on" id="cfgS1" onclick="showCfgStep(1)">1 Â· Crear hoja</button>
      <button class="cfg-step" id="cfgS2" onclick="showCfgStep(2)">2 Â· Apps Script</button>
      <button class="cfg-step" id="cfgS3" onclick="showCfgStep(3)">3 Â· API Key</button>
      <button class="cfg-step" id="cfgS4" onclick="showCfgStep(4)">4 Â· Conectar</button>
    </div>

    <!-- STEP 1: Crear hoja -->
    <div id="cfgPane1">
      <div class="info-box">
        <strong>Crear la hoja de cÃ¡lculo:</strong><br><br>
        1. Ve a <a href="https://sheets.google.com" target="_blank">sheets.google.com</a> y crea una hoja nueva<br>
        2. NÃ³mbrala como quieras, ej: <strong>CDA GestiÃ³n Comercial</strong><br>
        3. En la primera pestaÃ±a (abajo), haz doble clic y renÃ³mbrala exactamente: <code>GestiÃ³n</code><br>
        4. Haz clic en <strong>Compartir</strong> â†’ <em>Cualquiera con el enlace</em> â†’ <strong>Lector</strong><br>
        5. Copia el ID de la URL:<br>
        <code style="font-size:10px">docs.google.com/spreadsheets/d/<strong style="background:var(--am);padding:0 3px">[ESTE ES EL ID]</strong>/edit</code>
      </div>
      <button class="btn-save" onclick="showCfgStep(2)">Siguiente â†’</button>
    </div>

    <!-- STEP 2: Apps Script -->
    <div id="cfgPane2" style="display:none">
      <div class="info-box">
        <strong>Crear el script para guardar datos:</strong><br><br>
        1. En la hoja de Google, ve a <strong>Extensiones â†’ Apps Script</strong><br>
        2. Borra todo el cÃ³digo que aparece y pega exactamente esto:<br>
      </div>
      <div style="background:#1e1e2e;border-radius:8px;padding:14px;margin-bottom:12px;position:relative">
        <pre id="scriptCode" style="color:#cdd6f4;font-family:monospace;font-size:11px;white-space:pre-wrap;margin:0;line-height:1.6">function doGet(e){
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sh = ss.getSheetByName('GestiÃ³n');
    if(!sh) sh = ss.insertSheet('GestiÃ³n');
    var action = e.parameter.action;
    if(action === 'read') {
      var val = sh.getRange('B1').getValue();
      return ContentService
        .createTextOutput(JSON.stringify({ok:true, data:val}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    if(action === 'write') {
      sh.getRange('A1').setValue('CDA_JSON');
      sh.getRange('B1').setValue(e.parameter.data);
      return ContentService
        .createTextOutput(JSON.stringify({ok:true}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(JSON.stringify({ok:false,error:'action requerida'})).setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({ok:false,error:err.message})).setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
        <button onclick="copyScript()" style="position:absolute;top:8px;right:8px;background:var(--az);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:10px;font-weight:700;cursor:pointer">ğŸ“‹ Copiar</button>
      </div>
      <div class="info-box">
        3. Haz clic en <strong>Guardar</strong> (Ã­cono de disco o Ctrl+S)<br>
        4. Haz clic en <strong>Implementar â†’ Nueva implementaciÃ³n</strong><br>
        5. Tipo: <strong>AplicaciÃ³n web</strong><br>
        6. Ejecutar como: <strong>Yo</strong><br>
        7. QuiÃ©n tiene acceso: <strong>Cualquier usuario</strong><br>
        8. Clic en <strong>Implementar</strong> â†’ copia la <strong>URL de la aplicaciÃ³n web</strong>
      </div>
      <div class="fr"><label>URL de la aplicaciÃ³n web (Apps Script)</label>
        <input id="cfg_script" type="text" placeholder="https://script.google.com/macros/s/â€¦/exec">
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-ghost" onclick="showCfgStep(1)" style="flex:1">â† AtrÃ¡s</button>
        <button class="btn-save" onclick="showCfgStep(3)" style="flex:2">Siguiente â†’</button>
      </div>
    </div>

    <!-- STEP 3: API Key -->
    <div id="cfgPane3" style="display:none">
      <div class="info-box">
        <strong>Crear API Key para leer la hoja:</strong><br><br>
        1. Ve a <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a><br>
        2. Crea un proyecto nuevo (o usa uno existente)<br>
        3. Ve a <strong>APIs y servicios â†’ Biblioteca</strong><br>
        4. Busca <strong>Google Sheets API</strong> â†’ Activar<br>
        5. Ve a <strong>APIs y servicios â†’ Credenciales</strong><br>
        6. Clic en <strong>Crear credencial â†’ Clave de API</strong><br>
        7. Copia la clave generada (empieza por <code>AIzaSyâ€¦</code>)
      </div>
      <div class="fr"><label>API Key de Google</label>
        <input id="cfg_key" type="text" placeholder="AIzaSyâ€¦">
      </div>
      <div class="fr"><label>ID de la hoja de cÃ¡lculo</label>
        <input id="cfg_id" type="text" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms">
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-ghost" onclick="showCfgStep(2)" style="flex:1">â† AtrÃ¡s</button>
        <button class="btn-save" onclick="showCfgStep(4)" style="flex:2">Siguiente â†’</button>
      </div>
    </div>

    <!-- STEP 4: Test & Connect -->
    <div id="cfgPane4" style="display:none">
      <div class="info-box" id="cfgTestMsg" style="min-height:60px">
        Haz clic en <strong>Probar y conectar</strong> para verificar que todo funciona.
      </div>
      <button class="btn-save" onclick="testConnection()">ğŸ”Œ Probar conexiÃ³n</button>
    <button class="btn-save" id="btnFinalConnect" onclick="saveSheetsConfig()" style="margin-top:8px;background:var(--vd);display:none">âœ… Conectar y sincronizar</button>
      <button class="btn-secondary" onclick="disconnectSheets()">Desconectar Google Sheets</button>
      <button class="btn-ghost" onclick="showCfgStep(3)" style="width:100%;margin-top:8px">â† AtrÃ¡s</button>
    </div>

  </div>
</div>

<!-- â”€â”€ MODAL PLANTILLAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-bg" id="tplBg" onclick="if(event.target===this)closeTemplatesModal()">
  <div class="modal" style="max-width:540px">
    <button class="mcl" onclick="closeTemplatesModal()">âœ•</button>
    <h3>âœï¸ Plantillas de mensaje</h3>
    <p style="font-size:11px;color:var(--txt2);margin-bottom:10px">Variables disponibles:</p>
    <div class="tpl-vars">
      <span class="tpl-var">{nombre}</span><span class="tpl-var">{placa}</span>
      <span class="tpl-var">{marca}</span><span class="tpl-var">{linea}</span>
      <span class="tpl-var">{vencimiento}</span><span class="tpl-var">{clase}</span>
    </div>
    <div class="fr"><label>ğŸ’¬ WhatsApp</label><textarea id="tpl_wa" style="min-height:80px"></textarea></div>
    <div class="fr"><label>ğŸ“± SMS corto</label><textarea id="tpl_sms" style="min-height:50px"></textarea></div>
    <div class="fr"><label>ğŸ“… Recordatorio de cita</label><textarea id="tpl_rec" style="min-height:50px"></textarea></div>
    <div style="display:flex;gap:8px">
      <button class="btn-save" style="flex:1" onclick="saveTemplates()">ğŸ’¾ Guardar</button>
      <button class="btn-ghost" onclick="resetTemplates()">â†º Restaurar</button>
    </div>
  </div>
</div>

<footer><em>CDA Colombia</em> Â· GestiÃ³n local + Google Sheets Â· Sin envÃ­o de datos a terceros</footer>
<div class="notif" id="notif"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MO=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const C6=['#003893','#1a6b3c','#CE1126','#c05e00','#5b21b6','#0891b2'];
const CB=['#FCD116','#003893','#CE1126','#1a6b3c','#c05e00','#5b21b6'];
const DIAS_LLAMAR = 8; // dÃ­as antes del vencimiento para llamar

const ESTADOS=[
  {v:'pendiente',  l:'Pendiente',   cls:'gb-pte',  i:'â³'},
  {v:'en-gestion', l:'En gestiÃ³n',  cls:'gb-gest', i:'ğŸ“'},
  {v:'contactado', l:'Contactado',  cls:'gb-cont', i:'âœ…'},
  {v:'agendado',   l:'Agendado',    cls:'gb-agend',i:'ğŸ“…'},
  {v:'no-interesa',l:'No interesa', cls:'gb-noint',i:'ğŸš«'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSISTENCIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let GS = {};
try { GS = JSON.parse(localStorage.getItem('cda_gs')||'{}'); } catch{}

let GESTION = {};
try { GESTION = JSON.parse(localStorage.getItem('cda_gestion')||'{}'); } catch{}

async function persistGestion() {
  localStorage.setItem('cda_gestion', JSON.stringify(GESTION));
  if(GS.configured) await syncSheets();
}

// â”€â”€ Google Sheets (Apps Script write + API Key read) â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function syncSheets() {
  if(!GS.configured||!GS.scriptUrl) return;
  setSyncDot('syncing');
  try {
    const val = encodeURIComponent(JSON.stringify(GESTION));
    // Apps Script doGet write â€” uses no-cors friendly URL param approach
    const url = `${GS.scriptUrl}?action=write&data=${val}`;
    const res = await fetch(url, {method:'GET', mode:'no-cors'});
    // no-cors means we can't read response, but if no exception it worked
    setSyncDot('synced');
    showSyncMsg('âœ… Guardado en Google Sheets','ok');
  } catch(e) {
    setSyncDot('error');
    showSyncMsg('âš ï¸ Error al guardar: '+e.message,'warn');
  }
}

async function loadFromSheets() {
  if(!GS.configured) return;
  setSyncDot('syncing');
  try {
    // Read via Apps Script (returns JSON with CORS headers)
    if(GS.scriptUrl) {
      const res = await fetch(`${GS.scriptUrl}?action=read`);
      const data = await res.json();
      if(data.ok && data.data) {
        GESTION = JSON.parse(data.data);
        localStorage.setItem('cda_gestion', JSON.stringify(GESTION));
        setSyncDot('synced');
        showSyncMsg(`â˜ï¸ ${Object.keys(GESTION).length} gestiones cargadas desde Sheets`,'ok');
        return;
      }
    }
    // Fallback: read via API Key (public read)
    if(GS.key && GS.id) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${GS.id}/values/Gesti%C3%B3n!B1?key=${GS.key}`;
      const res = await fetch(url);
      const data = await res.json();
      if(data.error) throw new Error(data.error.message);
      const val = data.values?.[0]?.[0];
      if(val) {
        GESTION = JSON.parse(val);
        localStorage.setItem('cda_gestion', JSON.stringify(GESTION));
        setSyncDot('synced');
        showSyncMsg(`â˜ï¸ ${Object.keys(GESTION).length} gestiones cargadas`,'ok');
      } else {
        setSyncDot('synced');
        showSyncMsg('â˜ï¸ Conectado â€” hoja vacÃ­a, empezando desde cero','ok');
      }
    }
  } catch(e) {
    setSyncDot('error');
    showSyncMsg('âš ï¸ No se pudo cargar desde Sheets: '+e.message,'warn');
  }
}

async function testConnection() {
  const script = document.getElementById('cfg_script')?.value.trim();
  const key    = document.getElementById('cfg_key')?.value.trim();
  const id     = document.getElementById('cfg_id')?.value.trim();
  const msgEl  = document.getElementById('cfgTestMsg');

  if(!script&&(!key||!id)){ 
    msgEl.innerHTML='<span style="color:var(--ro)">âš ï¸ Completa al menos el Script URL (paso 2) o la API Key + ID (paso 3)</span>';
    return; 
  }
  msgEl.innerHTML='â³ Probando conexiÃ³nâ€¦';

  let scriptOk=false, apiOk=false, title='';
  
  // Test Apps Script
  if(script) {
    try {
      const res = await fetch(`${script}?action=read`);
      const data = await res.json();
      scriptOk = data.ok !== undefined; // any valid JSON response = script works
      if(scriptOk) msgEl.innerHTML='âœ… Script conectado correctamente<br>';
    } catch(e) { msgEl.innerHTML=`<span style="color:var(--ro)">âŒ Script error: ${e.message}</span><br>`; }
  }

  // Test API Key
  if(key && id) {
    try {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${id}?key=${key}`);
      const data = await res.json();
      if(data.error) throw new Error(data.error.message);
      apiOk = true;
      title = data.properties?.title||'Hoja sin nombre';
      msgEl.innerHTML += `âœ… API Key OK Â· Hoja: <strong>${title}</strong>`;
    } catch(e) { msgEl.innerHTML += `<span style="color:var(--ro)">âŒ API Key error: ${e.message}</span>`; }
  }

  if(!scriptOk && !apiOk) return;

  // Save config
  GS = {scriptUrl:script||'', key:key||'', id:id||'', configured:true, title};
  localStorage.setItem('cda_gs', JSON.stringify(GS));
  updateSheetsBtn();
  msgEl.innerHTML += '<br><br>ğŸ‰ Â¡Todo listo! Haz clic en <strong>Conectar y sincronizar</strong>.';
  const fb=document.getElementById('btnFinalConnect');if(fb)fb.style.display='block';
}

function setSyncDot(state) {
  const d=document.getElementById('syncDot');
  if(d){ d.className=''; d.classList.add(state); }
}
function showSyncMsg(msg,type) {
  const el=document.getElementById('syncMsg');
  if(!el) return;
  el.textContent=msg; el.className='sync-msg '+type; el.style.display='block';
  clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',4000);
}

// â”€â”€ Config Sheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCfgStep(n) {
  [1,2,3,4].forEach(i=>{
    const pane=document.getElementById(`cfgPane${i}`);
    const btn=document.getElementById(`cfgS${i}`);
    if(pane) pane.style.display = i===n ? 'block' : 'none';
    if(btn) btn.classList.toggle('on', i===n);
  });
  // Pre-fill fields from saved config
  if(n>=2&&GS.scriptUrl) document.getElementById('cfg_script').value=GS.scriptUrl;
  if(n>=3&&GS.key)        document.getElementById('cfg_key').value=GS.key;
  if(n>=3&&GS.id)         document.getElementById('cfg_id').value=GS.id;
}

function copyScript() {
  const code = document.getElementById('scriptCode').textContent;
  navigator.clipboard.writeText(code).then(()=>toast('âœ… CÃ³digo copiado','ok'));
}

function openSheetsModal() {
  showCfgStep(GS.configured ? 4 : 1);
  if(GS.configured){const fb=document.getElementById('btnFinalConnect');if(fb)fb.style.display='block';
    const m=document.getElementById('cfgTestMsg');if(m)m.innerHTML=`Conectado a <strong>${GS.title||'Sheets'}</strong>. Haz clic en <em>Conectar y sincronizar</em> para recargar los datos.`;}
  document.getElementById('sheetsBg').classList.add('show');
}
function closeSheetsModal(){document.getElementById('sheetsBg').classList.remove('show');}

async function saveSheetsConfig() {
  if(!GS.configured) { await testConnection(); return; }
  const msgEl = document.getElementById('cfgTestMsg');
  msgEl.innerHTML='â³ Cargando datos desde Sheetsâ€¦';
  try {
    await loadFromSheets();
    toast(`âœ… Sincronizado Â· ${Object.keys(GESTION).length} gestiones`,'ok');
    closeSheetsModal();
  } catch(e) { toast('âŒ Error: '+e.message,'err'); }
}

function disconnectSheets(){
  GS={};localStorage.removeItem('cda_gs');
  updateSheetsBtn();closeSheetsModal();toast('Desconectado de Google Sheets');
}
function updateSheetsBtn(){
  const btn=document.getElementById('btnSheets');
  if(!btn) return;
  if(GS.configured){
    btn.innerHTML=`<span id="syncDot" class="synced"></span> âœ… Sheets: ${GS.title||'Conectado'}`;
    btn.classList.add('sheets-on');
  } else {
    btn.innerHTML=`<span id="syncDot"></span> â˜ï¸ Google Sheets`;
    btn.classList.remove('sheets-on');
  }
}

// â”€â”€ Plantillas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TPL_DEF={
  whatsapp:'Hola {nombre}, le saludamos del CDA Colombia ğŸš—. Le informamos que la revisiÃ³n tÃ©cnico-mecÃ¡nica de su {marca} {linea} placa *{placa}* vence el *{vencimiento}*. Lo esperamos para renovar su certificado. Â¿Desea agendar una cita?',
  sms:'CDA Colombia: Su revisiÃ³n placa {placa} ({marca}) vence el {vencimiento}. ComunÃ­quese para agendar.',
  recordatorio:'Hola {nombre}, le recordamos su cita en CDA Colombia. Su {clase} placa {placa} estÃ¡ programado. Cualquier inquietud con gusto le atendemos ğŸ“‹'
};
let TPLS={};
try{TPLS=JSON.parse(localStorage.getItem('cda_tpls')||JSON.stringify(TPL_DEF));}catch{TPLS={...TPL_DEF};}

function fillTpl(tpl,row){
  const _vr=getVenc(row.Placa,row);
  const vd=_vr.date?_vr.date.toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'}):'prÃ³ximamente';
  return tpl.replace(/{nombre}/g,(row.Propietario||'Cliente').split(' ')[0])
    .replace(/{placa}/g,row.Placa||'').replace(/{marca}/g,row.Marca||'')
    .replace(/{linea}/g,row.Linea||'').replace(/{vencimiento}/g,vd)
    .replace(/{clase}/g,row.Clase||'');
}

function openTemplatesModal(){
  document.getElementById('tpl_wa').value=TPLS.whatsapp;
  document.getElementById('tpl_sms').value=TPLS.sms;
  document.getElementById('tpl_rec').value=TPLS.recordatorio;
  document.getElementById('tplBg').classList.add('show');
}
function closeTemplatesModal(){document.getElementById('tplBg').classList.remove('show');}
function saveTemplates(){
  TPLS.whatsapp=document.getElementById('tpl_wa').value;
  TPLS.sms=document.getElementById('tpl_sms').value;
  TPLS.recordatorio=document.getElementById('tpl_rec').value;
  localStorage.setItem('cda_tpls',JSON.stringify(TPLS));
  closeTemplatesModal();toast('âœ… Plantillas guardadas','ok');
}
function resetTemplates(){
  document.getElementById('tpl_wa').value=TPL_DEF.whatsapp;
  document.getElementById('tpl_sms').value=TPL_DEF.sms;
  document.getElementById('tpl_rec').value=TPL_DEF.recordatorio;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S={years:[],analysis:null,activeTab:null,modalPlaca:null};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  addSlot(2024); addSlot(2025);
  updateSheetsBtn();
  if(GS.configured) loadFromSheets();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SLOTS DE AÃ‘O
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSlot(yr){
  const idx=S.years.length;
  if(idx>=4){toast('MÃ¡ximo 4 aÃ±os','err');return;}
  S.years.push({label:String(yr),allRows:null,avM:[],selM:new Set(['__ALL__']),filtered:[],deduped:[],fileName:''});
  const g=document.getElementById('yg');
  document.getElementById('addSlotBtn')?.remove();
  const c=document.createElement('div');
  c.className='yc';c.id=`yc_${idx}`;
  c.innerHTML=`
    <div class="yc-head">
      <span class="yb" id="yb_${idx}">${yr}</span>
      <input class="yi" type="number" value="${yr}" min="2000" max="2099"
        oninput="S.years[${idx}].label=this.value;document.getElementById('yb_${idx}').textContent=this.value">
      ${idx>=2?`<button class="yr" onclick="removeSlot(${idx})">âœ•</button>`:''}
    </div>
    <label class="fd" id="fd_${idx}">
      <input type="file" accept=".xlsx,.xls" onchange="loadFile(event,${idx})">
      <div style="font-size:20px;margin-bottom:2px">ğŸ“„</div>
      <div style="font-weight:600">Clic para subir Excel</div>
      <div style="font-size:9px;opacity:.6;margin-top:1px">.xlsx Â· una o varias hojas</div>
    </label>
    <div class="fst" id="fst_${idx}"></div>
    <div class="mtots" id="mt_${idx}">
      <div class="mtots-lbl">Totales por mes (aprobados)</div>
      <div class="mtots-row" id="mtr_${idx}"></div>
    </div>
    <div class="mp" id="mp_${idx}">
      <div class="mlbl">Filtrar meses:</div>
      <div class="mcs" id="mcs_${idx}"></div>
      <div class="macts">
        <button class="mact" onclick="selAllM(${idx})">Todos</button>
        <button class="mact" onclick="clrM(${idx})">Ninguno</button>
      </div>
    </div>`;
  g.appendChild(c);
  if(S.years.length<4){
    const a=document.createElement('div');
    a.className='add-slot';a.id='addSlotBtn';
    a.onclick=()=>addSlot(parseInt(S.years[S.years.length-1].label)+1);
    a.innerHTML='+ Agregar aÃ±o';
    g.appendChild(a);
  }
}

function removeSlot(idx){
  if(S.years.length<=2){toast('MÃ­nimo 2 aÃ±os','err');return;}
  const saved=S.years.filter((_,i)=>i!==idx);
  S.years=[];document.getElementById('yg').innerHTML='';
  saved.forEach((y,i)=>{
    addSlot(parseInt(y.label));
    if(y.allRows){S.years[i]=y;renderSlotLoaded(i);}
  });
  checkBtn();
}

function renderSlotLoaded(idx){
  const y=S.years[idx];
  const c=document.getElementById(`yc_${idx}`);
  c.classList.add('loaded');
  const fs=document.getElementById(`fst_${idx}`);
  const aprobados=y.allRows.filter(r=>r.Aprobado).length;
  fs.style.display='block';
  fs.textContent=`âœ… ${y.fileName} Â· ${aprobados.toLocaleString()} aprobados de ${y.allRows.length.toLocaleString()}`;
  renderMtots(idx);
  renderChips(idx);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEER EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadFile(evt,idx){
  const file=evt.target.files[0];if(!file)return;
  toast(`â³ Leyendo ${file.name}â€¦`);
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'array',cellDates:true});
      const all=[];
      wb.SheetNames.forEach(sn=>{
        const ws=wb.Sheets[sn];
        const raw=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
        if(!raw||raw.length<3)return;
        let hdr=-1;
        for(let i=0;i<Math.min(raw.length,10);i++){
          if(raw[i].map(v=>String(v).trim().toLowerCase()).includes('placa')){hdr=i;break;}
        }
        if(hdr===-1)return;
        const hs=raw[hdr].map(v=>String(v).trim());
        const cm={};hs.forEach((h,j)=>{cm[h.toLowerCase()]=j;});
        const get=(row,...keys)=>{for(const k of keys){const j=cm[k.toLowerCase()];if(j!==undefined&&row[j]!==''&&row[j]!==undefined&&row[j]!==null)return String(row[j]).trim();}return '';};
        for(let i=hdr+1;i<raw.length;i++){
          const row=raw[i];
          const placa=get(row,'placa');
          if(!placa||placa.toLowerCase()==='placa')continue;
          const aprobada=get(row,'aprobada','resultado');
          const aprobado=aprobada.toUpperCase()==='APROBADO'||aprobada.toUpperCase()==='SI';
          const fechaStr=get(row,'fecha final','fecha inicio','fecha');
          let mes='',mesNum=0,fechaDate=null;
          if(fechaStr){const d=new Date(fechaStr);if(!isNaN(d)){mesNum=d.getMonth();mes=MO[mesNum];fechaDate=d;}}
          let vencDate=null;
          if(aprobado&&fechaDate){vencDate=new Date(fechaDate);vencDate.setFullYear(vencDate.getFullYear()+1);}
          all.push({
            Placa:placa.toUpperCase().replace(/\s/g,''),
            Propietario:get(row,'propietario'),Identificacion:get(row,'identificacion'),
            Telefono:get(row,'telefono'),Correo:get(row,'correo'),
            Direccion:get(row,'direccion'),Ciudad:get(row,'ciudad'),
            Clase:get(row,'clase'),Servicio:get(row,'servicio'),
            Marca:get(row,'marca'),Linea:get(row,'linea'),
            Modelo:get(row,'modelo'),Color:get(row,'color'),
            Kilometraje:get(row,'kilometraje'),Resultado:aprobada,
            Aprobado:aprobado,TipoIngreso:get(row,'tipo ingreso'),
            FechaFinal:fechaStr,FechaDate:fechaDate,VencDate:vencDate,
            Mes:mes,MesNum:mesNum,_hoja:sn,
          });
        }
      });
      if(!all.length){toast('Sin datos vÃ¡lidos','err');return;}
      S.years[idx].allRows=all;
      S.years[idx].avM=MO.filter(m=>all.some(r=>r.Mes===m));
      S.years[idx].selM=new Set(['__ALL__']);
      S.years[idx].fileName=file.name;
      applyFilter(idx);
      renderSlotLoaded(idx);
      toast(`âœ… ${file.name} Â· ${all.filter(r=>r.Aprobado).length.toLocaleString()} aprobados`,'ok');
      checkBtn();
    }catch(err){toast('Error: '+err.message,'err');console.error(err);}
  };
  reader.readAsArrayBuffer(file);
}

function renderMtots(idx){
  const y=S.years[idx];
  const c=document.getElementById(`mtr_${idx}`);if(!c)return;c.innerHTML='';
  MO.forEach(mes=>{
    const tot=y.allRows.filter(r=>r.Mes===mes&&r.Aprobado).length;
    if(!tot)return;
    const ch=document.createElement('div');ch.className='mt-chip';
    ch.innerHTML=`<span class="mn">${mes.slice(0,3)}</span><span class="mc">${tot}</span>`;
    c.appendChild(ch);
  });
}

function renderChips(idx){
  const y=S.years[idx];
  const c=document.getElementById(`mcs_${idx}`);if(!c)return;c.innerHTML='';
  const isAll=y.selM.has('__ALL__');
  const all=document.createElement('span');
  all.className='chip chip-all'+(isAll?' on':'');all.textContent='Todos';all.onclick=()=>selAllM(idx);
  c.appendChild(all);
  y.avM.forEach(mes=>{
    const ch=document.createElement('span');
    ch.className='chip'+(!isAll&&y.selM.has(mes)?' on':'');
    ch.textContent=mes;ch.onclick=()=>toggleM(idx,mes);c.appendChild(ch);
  });
}
function toggleM(idx,mes){
  const y=S.years[idx];y.selM.delete('__ALL__');
  y.selM.has(mes)?y.selM.delete(mes):y.selM.add(mes);
  if(y.selM.size===0)y.selM.add('__ALL__');
  renderChips(idx);applyFilter(idx);
}
function selAllM(idx){S.years[idx].selM=new Set(['__ALL__']);renderChips(idx);applyFilter(idx);}
function clrM(idx){S.years[idx].selM.clear();renderChips(idx);applyFilter(idx);}

function applyFilter(idx){
  const y=S.years[idx];if(!y.allRows)return;
  const rows=(y.selM.has('__ALL__')||y.selM.size===0)?y.allRows:y.allRows.filter(r=>y.selM.has(r.Mes));
  const aprobados=rows.filter(r=>r.Aprobado);
  const byP={};aprobados.forEach(r=>{if(!byP[r.Placa]||r.FechaFinal>byP[r.Placa].FechaFinal)byP[r.Placa]=r;});
  y.filtered=aprobados;y.deduped=Object.values(byP);
}
function checkBtn(){
  document.getElementById('btnRun').disabled=S.years.filter(y=>y.allRows).length<2;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANÃLISIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runAnalysis(){
  S.years.forEach((y,i)=>{if(y.allRows)applyFilter(i);});
  document.getElementById('loadingRow').style.display='flex';
  document.getElementById('btnRun').disabled=true;
  setTimeout(()=>{
    try{
      S.analysis=compute(S.years.filter(y=>y.allRows));
      renderResults();
      document.getElementById('results').style.display='block';
      document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
      toast(`âœ… ${S.analysis.noVolvieron.length.toLocaleString()} clientes para recontactar`,'ok');
    }catch(e){toast('Error: '+e.message,'err');console.error(e);}
    document.getElementById('loadingRow').style.display='none';
    document.getElementById('btnRun').disabled=false;
  },250);
}

function compute(lys){
  const ymaps=lys.map(y=>{const m={};(y.deduped||[]).forEach(r=>{m[r.Placa]=r;});return{label:y.label,map:m};});
  const all=new Set();ymaps.forEach(ym=>Object.keys(ym.map).forEach(p=>all.add(p)));
  const recurrentes=[],parciales=[],noVolvieron=[],nuevos=[],matrix=[];
  all.forEach(placa=>{
    const pres=ymaps.map(ym=>!!ym.map[placa]);
    const enTodos=pres.every(Boolean);
    const enPrimero=pres[0];const enUltimo=pres[pres.length-1];
    const cuenta=pres.filter(Boolean).length;
    let info=null;for(let i=ymaps.length-1;i>=0;i--){if(ymaps[i].map[placa]){info=ymaps[i].map[placa];break;}}
    const row={...info,Placa:placa,_cnt:cuenta,_yrs:ymaps.filter((_,i)=>pres[i]).map(ym=>ym.label).join(', ')};
    ymaps.forEach((ym,i)=>{row[`_p${i}`]=pres[i]?'SI':'';row[`_r${i}`]=ym.map[placa]?.Resultado||'';row[`_m${i}`]=ym.map[placa]?.Mes||'';row[`_v${i}`]=ym.map[placa]?.VencDate||null;});
    // _vLast = vencimiento del aÃ±o mÃ¡s reciente en que aparece la placa
    let _vLast=null;for(let i=ymaps.length-1;i>=0;i--){if(row[`_v${i}`]){_vLast=row[`_v${i}`];break;}}
    row._vLast=_vLast;
    matrix.push(row);
    if(enTodos) recurrentes.push(row);
    else if(enPrimero&&!enUltimo) noVolvieron.push(row);
    else if(!enPrimero&&enUltimo) nuevos.push(row);
    else if(cuenta>=2) parciales.push(row);
  });

  // Ordenar noVolvieron: primero vencen pronto, luego ya vencidos, luego sin fecha
  const now=new Date();
  noVolvieron.sort((a,b)=>{
    const va=getVenc(a.Placa,a).date||new Date('2099');
    const vb=getVenc(b.Placa,b).date||new Date('2099');
    return va-vb;
  });

  const statsByYear=ymaps.map((ym,i)=>{
    const rows=lys[i].filtered||[];
    return{label:ym.label,total:Object.keys(ym.map).length,totalRevs:rows.length,
      byClase:cntBy(Object.values(ym.map),'Clase'),byMarca:cntBy(Object.values(ym.map),'Marca'),
      byMes:cntByMes(rows),byServ:cntBy(Object.values(ym.map),'Servicio')};
  });
  return{ymaps,recurrentes,parciales,noVolvieron,nuevos,matrix,statsByYear,total:all.size};
}

function cntBy(arr,k){const m={};arr.forEach(r=>{const v=(r[k]||'Sin dato').trim()||'Sin dato';m[v]=(m[v]||0)+1;});return Object.entries(m).sort((a,b)=>b[1]-a[1]);}
function cntByMes(arr){const m={};arr.forEach(r=>{if(r.Mes)m[r.Mes]=(m[r.Mes]||0)+1;});return MO.filter(mes=>m[mes]).map(mes=>[mes,m[mes]]);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER RESULTADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(){
  const a=S.analysis;
  const first=a.statsByYear[0];
  const ret=first.total>0?(a.recurrentes.length/first.total*100).toFixed(1):'0.0';

  // Context bar
  const cp=S.years.filter(y=>y.allRows).map(y=>{
    const isAll=y.selM.has('__ALL__')||y.selM.size===0;
    return `<strong>${y.label}:</strong> ${isAll?'todos los meses':[...y.selM].join(', ')}`;
  });
  document.getElementById('ctxBar').innerHTML='ğŸ” PerÃ­odo analizado â€” '+cp.join(' &nbsp;|&nbsp; ')+' <span style="opacity:.6">(solo aprobados)</span>';

  // KPIs
  const kpis=[
    {l:'VehÃ­culos Ãºnicos',v:a.total.toLocaleString(),s:'aprobados en el perÃ­odo'},
    {l:'Recurrentes',v:a.recurrentes.length.toLocaleString(),s:'vinieron todos los aÃ±os'},
    {l:'Para recontactar',v:a.noVolvieron.length.toLocaleString(),s:`de ${a.ymaps[0].label} no volvieron`},
    {l:'RetenciÃ³n',v:ret+'%',s:`${a.ymaps[0].label} â†’ ${a.ymaps[a.ymaps.length-1].label}`},
    {l:'Nuevos',v:a.nuevos.length.toLocaleString(),s:`solo en ${a.ymaps[a.ymaps.length-1].label}`},
  ];
  const kr=document.getElementById('kpiRow');kr.innerHTML='';
  kpis.forEach((k,i)=>{
    const d=document.createElement('div');d.className='kpi';d.style.animationDelay=`${i*.07}s`;
    d.innerHTML=`<div class="kpi-lbl">${k.l}</div><div class="kpi-val">${k.v}</div><div class="kpi-sub">${k.s}</div>`;
    kr.appendChild(d);
  });

  // Tabs â€” parciales solo si hay 3+ aÃ±os
  const numYears=a.ymaps.length;
  const tabs=[
    {id:'nov',ico:'ğŸ“',lbl:'Recontactar',n:a.noVolvieron.length,urgent:true},
    {id:'rec',ico:'âœ…',lbl:'Recurrentes',n:a.recurrentes.length},
    {id:'new',ico:'ğŸ†•',lbl:'Nuevos',n:a.nuevos.length},
    ...(numYears>=3?[{id:'par',ico:'âš ï¸',lbl:'Parciales',n:a.parciales.length}]:[]),
    {id:'mat',ico:'ğŸ“‹',lbl:'Matriz',n:a.total},
    {id:'hoy',ico:'ğŸ“…',lbl:'Hoy',n:null},
    {id:'stat',ico:'ğŸ“Š',lbl:'Resumen',n:null},
  ];
  const tr=document.getElementById('tabsRow');tr.innerHTML='';
  tabs.forEach(t=>{
    const b=document.createElement('button');
    b.className='tab'+(t.urgent?' urgent':'');b.id=`tab_${t.id}`;b.onclick=()=>showTab(t.id);
    b.innerHTML=`${t.ico} ${t.lbl}${t.n!==null?`<span class="tab-n">${t.n.toLocaleString()}</span>`:''}`;
    tr.appendChild(b);
  });

  showTab('nov');
  showTodayBanner();
  updateSheetsBtn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOW TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(id){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  document.getElementById(`tab_${id}`)?.classList.add('on');
  S.activeTab=id;
  const a=S.analysis,p=document.getElementById('mainPanel');
  if(id==='nov')  p.innerHTML=buildTable(a.noVolvieron,'nov',a.ymaps,true);
  else if(id==='rec') p.innerHTML=buildTable(a.recurrentes,'rec',a.ymaps,false);
  else if(id==='new') p.innerHTML=buildTable(a.nuevos,'new',a.ymaps,false);
  else if(id==='par') p.innerHTML=buildTable(a.parciales,'par',a.ymaps,false);
  else if(id==='mat') renderMatrix(a,p);
  else if(id==='hoy') renderHoy(a,p);
  else if(id==='stat') renderStat(a,p);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VENCIMIENTO DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function vencCell(vDateOrObj, placa, row){
  // Accept either a Date/raw value or use getVenc if placa provided
  let vDate = vDateOrObj;
  let isManual = false;
  if(placa && row) {
    const v = getVenc(placa, row);
    vDate = v.date;
    isManual = v.isManual;
  }
  if(!vDate) {
    // No date at all â€” show edit button if placa provided
    if(placa) return `<div class="venc-edit-wrap"><span class="dash">Sin fecha</span><button class="btn-edit-venc" onclick="openModal('${placa}')">âœï¸ Agregar fecha</button></div>`;
    return '<span class="dash">â€”</span>';
  }
  const now=new Date(),d=new Date(vDate),diff=Math.ceil((d-now)/(1000*60*60*24));
  const fecha=d.toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'numeric'});
  const llamarD=new Date(d);llamarD.setDate(llamarD.getDate()-DIAS_LLAMAR);
  const llamarFmt=llamarD.toLocaleDateString('es-CO',{day:'2-digit',month:'short'});
  let cls,lbl;
  if(diff<0){cls='v-vencido';lbl=`â›” Vencido (${Math.abs(diff)}d)`;}
  else if(diff<=DIAS_LLAMAR){cls='v-urgente';lbl=`ğŸ”´ Â¡Llamar ya! (${diff}d)`;}
  else if(diff<=30){cls='v-pronto';lbl=`ğŸŸ¡ Llamar antes del ${llamarFmt}`;}
  else{cls='v-ok';lbl=`ğŸŸ¢ Llamar el ${llamarFmt}`;}
  const manualTag = isManual ? '<span class="venc-manual-badge">âœï¸ Manual</span>' : '';
  return `<div class="venc-edit-wrap"><div class="venc"><span class="venc-fecha">${fecha}</span><span class="venc-dias ${cls}">${lbl}</span></div>${manualTag}</div>`;
}

function vencText(vDate){
  if(!vDate)return 'â€”';
  return new Date(vDate).toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'});
}

function llamarFechaLabel(vDate){
  if(!vDate)return '';
  const d=new Date(vDate);
  d.setDate(d.getDate()-DIAS_LLAMAR);
  return d.toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'numeric'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTIÃ“N BADGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gestBadge(placa){
  const g=GESTION[placa];
  const estado=g?.estado||'pendiente';
  const e=ESTADOS.find(x=>x.v===estado)||ESTADOS[0];
  return `<span class="gb ${e.cls}" onclick="openModal('${placa}')">${e.i} ${e.l}</span>`;
}

function refreshBadges(){
  document.querySelectorAll('.gb').forEach(el=>{
    const tr=el.closest('tr');
    const placa=tr?.querySelector('.td-placa')?.textContent;
    if(placa)el.outerHTML=gestBadge(placa);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD TABLE (limpia, menos columnas)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTable(data,tid,ymaps,showVenc){
  if(!data.length) return `<div class="empty"><div class="empty-ico">ğŸ“­</div><h3>Sin registros</h3><p>No hay datos en esta categorÃ­a</p></div>`;

  // Para la tabla principal: Placa Â· Propietario Â· TelÃ©fono+WA Â· Venc(si aplica) Â· GestiÃ³n
  // Columnas de aÃ±o solo como checkmarks compactos
  const yHdrs=ymaps.map(ym=>`<th>${ym.label}</th>`).join('');

  const rows=data.map(r=>{
    const tel=r.Telefono||'';
    const telNum=tel.replace(/\D/g,'');
    const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
    const msgWA=encodeURIComponent(fillTpl(TPLS.whatsapp,r));

    const telCell=tel
      ?`<div class="td-tel">${tel}</div>
        <div class="call-row" style="margin-top:4px">
          <a class="btn-call btn-tel" href="tel:${tel}">ğŸ“ Llamar</a>
          <a class="btn-call btn-wa" href="https://wa.me/${waNum}?text=${msgWA}" target="_blank">ğŸ’¬ WA</a>
        </div>`
      :`<span class="dash">Sin telÃ©fono</span>`;

    const yCells=ymaps.map((ym,i)=>{
      const si=r[`_p${i}`]==='SI';
      return `<td style="text-align:center">${si?'<span class="chk">âœ”</span>':'<span class="dash">â€”</span>'}</td>`;
    }).join('');

    const vRow=showVenc?`<td>${vencCell(null,r.Placa,r)}</td>`:'';

    return `<tr data-s="${h((r.Placa+r.Propietario+r.Marca+r.Correo+tel).toLowerCase())}">
      <td class="td-placa">${h(r.Placa)}</td>
      <td>
        <div class="td-nombre">${h(r.Propietario||'â€”')}</div>
        <div style="font-size:10px;color:var(--txt2);margin-top:2px">${h(r.Clase||'')} ${h(r.Marca||'')} ${h(r.Linea||'')}</div>
      </td>
      <td>${telCell}</td>
      ${vRow}
      <td>${gestBadge(r.Placa)}</td>
      ${yCells}
    </tr>`;
  }).join('');

  const claseOpts=uniq(data,'Clase').map(c=>`<option value="${h(c)}">${h(c)}</option>`).join('');
  const marcaOpts=uniq(data,'Marca').map(c=>`<option value="${h(c)}">${h(c)}</option>`).join('');
  const mesOpts=uniq(data,'Mes',true).map(c=>`<option value="${h(c)}">${h(c)}</option>`).join('');
  const gestOpts=ESTADOS.map(e=>`<option value="${e.v}">${e.i} ${e.l}</option>`).join('');

  return `
    <div class="fbar">
      <span class="fbar-lbl">Buscar:</span>
      <input type="text" placeholder="Placa, nombre, correoâ€¦" oninput="filtTbl('${tid}',this)">
      <select onchange="filtTbl('${tid}',null)"><option value="">Tipo</option>${claseOpts}</select>
      <select onchange="filtTbl('${tid}',null)"><option value="">Marca</option>${marcaOpts}</select>
      <select onchange="filtTbl('${tid}',null)"><option value="">Mes</option>${mesOpts}</select>
      <select onchange="filtTbl('${tid}',null)"><option value="">Estado gestiÃ³n</option>${gestOpts}</select>
      <span class="fbar-cnt" id="cnt_${tid}">${data.length.toLocaleString()} registros</span>
      <button class="btn-csv" onclick="exportCSV('${tid}')">â¬‡ CSV</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>Placa</th>
          <th>Propietario Â· VehÃ­culo</th>
          <th>TelÃ©fono</th>
          ${showVenc?'<th>Vencimiento Â· Llamar</th>':''}
          <th>GestiÃ³n</th>
          ${yHdrs}
        </tr></thead>
        <tbody id="tb_${tid}">${rows}</tbody>
      </table>
    </div>`;
}

function filtTbl(tid,input){
  const fbar=document.querySelector(`#tb_${tid}`)?.closest('.panel')?.querySelector('.fbar');
  if(!fbar)return;
  const sels=fbar.querySelectorAll('select');
  const search=(fbar.querySelector('input')?.value||'').toLowerCase();
  const clase=(sels[0]?.value||'').toLowerCase();
  const marca=(sels[1]?.value||'').toLowerCase();
  const mes=(sels[2]?.value||'').toLowerCase();
  const gest=(sels[3]?.value||'');
  let cnt=0;
  document.querySelectorAll(`#tb_${tid} tr`).forEach(tr=>{
    const s=tr.dataset.s||'',t=tr.textContent.toLowerCase();
    const placa=tr.querySelector('.td-placa')?.textContent||'';
    const gestE=GESTION[placa]?.estado||'pendiente';
    const ok=(!search||s.includes(search))&&(!clase||t.includes(clase))&&(!marca||t.includes(marca))&&(!mes||t.includes(mes))&&(!gest||gestE===gest);
    tr.style.display=ok?'':'none';if(ok)cnt++;
  });
  const c=document.getElementById(`cnt_${tid}`);if(c)c.textContent=cnt.toLocaleString()+' registros';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTodayBanner(){
  const today=new Date().toISOString().slice(0,10);
  const banner=document.getElementById('todayBanner');
  if(!S.analysis||!banner){if(banner)banner.style.display='none';return;}
  const list=S.analysis.matrix.filter(r=>GESTION[r.Placa]?.contactos?.some(c=>c.proxFecha===today));
  if(!list.length){banner.style.display='none';return;}
  banner.style.display='flex';
  document.getElementById('tbTitle').textContent=`Tienes ${list.length} cliente${list.length>1?'s':''} para llamar hoy`;
  document.getElementById('tbSub').textContent=list.slice(0,3).map(r=>r.Placa+' â€“ '+(r.Propietario||'').split(' ')[0]).join(' Â· ')+(list.length>3?' Â· y '+(list.length-3)+' mÃ¡s':'');
}

function renderHoy(a,panel){
  const today=new Date().toISOString().slice(0,10);
  const todayFmt=new Date().toLocaleDateString('es-CO',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const now=new Date();

  // Seguimientos programados hoy
  const seguimientos=a.matrix.filter(r=>GESTION[r.Placa]?.contactos?.some(c=>c.proxFecha===today));

  // Vencen en los prÃ³ximos 8 dÃ­as (urgentes ahora mismo)
  const urgentes=a.matrix.filter(r=>{
    if(GESTION[r.Placa]?.estado==='no-interesa')return false;
    const v=getVenc(r.Placa,r).date;if(!v)return false;
    const diff=Math.ceil((v-now)/(1000*60*60*24));
    return diff>=0&&diff<=DIAS_LLAMAR;
  });

  // PrÃ³ximos 30 dÃ­as (para planificar)
  const proximos=a.matrix.filter(r=>{
    if(GESTION[r.Placa]?.estado==='no-interesa')return false;
    const v=getVenc(r.Placa,r).date;if(!v)return false;
    const diff=Math.ceil((v-now)/(1000*60*60*24));
    return diff>DIAS_LLAMAR&&diff<=38;
  });

  const makeRows=(list,showNota=false)=>list.map(r=>{
    const tel=r.Telefono||'';
    const telNum=tel.replace(/\D/g,'');
    const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
    const msgWA=encodeURIComponent(fillTpl(TPLS.whatsapp,r));
    const g=GESTION[r.Placa];
    const nota=showNota?(g?.contactos?.find(c=>c.proxFecha===today)?.nota||''):'';
    return `<tr>
      <td class="td-placa" style="font-size:12px">${h(r.Placa)}</td>
      <td><div style="font-weight:600;font-size:12px">${h(r.Propietario||'â€”')}</div><div style="font-size:10px;color:var(--txt2)">${h(r.Clase||'')} ${h(r.Marca||'')}</div></td>
      <td class="td-tel" style="font-size:13px">${tel||'â€”'}</td>
      <td>
        ${tel?`<div class="call-row">
          <a class="btn-call btn-tel" href="tel:${tel}">ğŸ“ Llamar</a>
          <a class="btn-call btn-wa" href="https://wa.me/${waNum}?text=${msgWA}" target="_blank">ğŸ’¬ WA</a>
        </div>`:'â€”'}
      </td>
      <td>${vencCell(null,r.Placa,r)}</td>
      <td>${gestBadge(r.Placa)}</td>
      ${showNota?`<td style="font-size:11px;color:var(--txt2);max-width:160px;white-space:normal">${h(nota)}</td>`:''}
    </tr>`;
  }).join('');

  const tblHead=(showNota)=>`<thead><tr>
    <th>Placa</th><th>Cliente</th><th>TelÃ©fono</th><th>Contactar</th><th>Vencimiento</th><th>Estado</th>
    ${showNota?'<th>Nota</th>':''}
  </tr></thead>`;

  panel.innerHTML=`
    <div class="hoy-section">
      <div class="hoy-head" style="text-transform:capitalize">ğŸ“… ${todayFmt}</div>

      ${seguimientos.length?`
        <div class="hoy-block seguimientos">
          <div class="hoy-block-title">â° Seguimientos programados para hoy â€” ${seguimientos.length} cliente${seguimientos.length>1?'s':''}</div>
          <div class="tbl-wrap" style="max-height:260px">
            <table>${tblHead(true)}<tbody>${makeRows(seguimientos,true)}</tbody></table>
          </div>
        </div>`:`
        <div class="hoy-block empty-block">âœ… No hay seguimientos programados para hoy</div>`}

      ${urgentes.length?`
        <div class="hoy-block vencen">
          <div class="hoy-block-title">ğŸ”´ Vencen en los prÃ³ximos ${DIAS_LLAMAR} dÃ­as â€” Â¡Llamar urgente! (${urgentes.length})</div>
          <div class="tbl-wrap" style="max-height:260px">
            <table>${tblHead(false)}<tbody>${makeRows(urgentes)}</tbody></table>
          </div>
        </div>`:''} 

      ${proximos.length?`
        <div class="hoy-block" style="background:var(--az-l);border-color:rgba(0,56,147,.2)">
          <div class="hoy-block-title" style="color:var(--az)">ğŸ“‹ PrÃ³ximos a vencer â€” planificar llamadas (${proximos.length})</div>
          <div class="tbl-wrap" style="max-height:260px">
            <table>${tblHead(false)}<tbody>${makeRows(proximos)}</tbody></table>
          </div>
        </div>`:''} 
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATRIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMatrix(a,panel){
  const yHdrs=a.ymaps.map(ym=>`<th>âœ” ${ym.label}</th><th>Vence</th>`).join('');
  const rows=a.matrix.map(r=>{
    const yCells=a.ymaps.map((_,i)=>{
      const si=r[`_p${i}`]==='SI';
      return `<td style="text-align:center">${si?'<span class="chk">âœ”</span>':'<span class="dash">â€”</span>'}</td><td>${si?vencCell(null,r.Placa,r):'<span class="dash">â€”</span>'}</td>`;
    }).join('');
    return `<tr data-s="${h((r.Placa+r.Propietario).toLowerCase())}">
      <td class="td-placa">${h(r.Placa)}</td>
      <td><div class="td-nombre">${h(r.Propietario||'')}</div><div style="font-size:10px;color:var(--txt2)">${h(r.Clase||'')} ${h(r.Marca||'')}</div></td>
      <td><span class="pill p-am">${r._cnt} de ${a.ymaps.length} aÃ±os</span></td>
      <td>${gestBadge(r.Placa)}</td>
      ${yCells}
    </tr>`;
  }).join('');
  panel.innerHTML=`
    <div class="fbar">
      <span class="fbar-lbl">Buscar:</span>
      <input type="text" placeholder="Placa o propietarioâ€¦" oninput="filtMat(this.value)">
      <span class="fbar-cnt" id="cnt_mat">${a.matrix.length.toLocaleString()} registros</span>
      <button class="btn-csv" onclick="exportCSV('mat')">â¬‡ CSV</button>
    </div>
    <div class="tbl-wrap">
      <table><thead><tr>
        <th>Placa</th><th>Propietario Â· VehÃ­culo</th><th>Historial</th><th>GestiÃ³n</th>${yHdrs}
      </tr></thead>
      <tbody id="tb_mat">${rows}</tbody></table>
    </div>`;
}
function filtMat(v){v=v.toLowerCase();let c=0;document.querySelectorAll('#tb_mat tr').forEach(tr=>{const ok=!v||(tr.dataset.s||'').includes(v);tr.style.display=ok?'':'none';if(ok)c++;});const e=document.getElementById('cnt_mat');if(e)e.textContent=c.toLocaleString()+' registros';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESUMEN ESTADÃSTICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStat(a,panel){
  const now=new Date();
  const vencidos=a.matrix.filter(r=>{const v=getVenc(r.Placa,r).date;return v&&v<now;});
  const prox8=a.matrix.filter(r=>{const v=getVenc(r.Placa,r).date;if(!v)return false;const d=Math.ceil((v-now)/(1000*60*60*24));return d>=0&&d<=DIAS_LLAMAR;});

  const mkBar=(items,colors,max8=8)=>{const mx=items[0]?.[1]||1;return items.slice(0,max8).map(([k,v],i)=>`
    <div class="bar-row"><div class="bar-lbl" title="${h(k)}">${h(k)}</div>
    <div class="bar-trk"><div class="bar-fill" style="width:${Math.round(v/mx*100)}%;background:${colors[i%colors.length]}"></div></div>
    <div class="bar-cnt">${v}</div></div>`).join('');};

  const retBars=a.statsByYear.map((sy,i)=>{
    const rec=a.recurrentes.filter(r=>r[`_p${i}`]==='SI').length;
    const pct=sy.total>0?Math.round(rec/sy.total*100):0;
    return `<div class="bar-row">
      <div class="bar-lbl"><strong>${sy.label}</strong><br><small style="color:var(--txt3)">${sy.total.toLocaleString()} Ãºnicos</small></div>
      <div class="bar-trk"><div class="bar-fill" style="width:${pct}%;background:${C6[i%C6.length]}"></div></div>
      <div class="bar-cnt">${pct}%</div></div>`;
  }).join('');

  const yrCards=a.statsByYear.map((sy,yi)=>`
    <div class="yr-stat" style="border-top-color:${C6[yi%C6.length]}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
        <div>
          <div style="font-family:var(--serif);font-size:17px;font-weight:900;color:${C6[yi%C6.length]}">${sy.label}</div>
          <div style="font-size:10px;color:var(--txt3);margin-top:2px">${sy.totalRevs.toLocaleString()} revisiones totales</div>
        </div>
        <div style="font-family:var(--serif);font-size:32px;font-weight:900;color:${C6[yi%C6.length]}">${sy.total.toLocaleString()}</div>
      </div>
      <div class="chart-grid">
        <div class="cc"><h3>Por tipo de vehÃ­culo</h3>${mkBar(sy.byClase,CB)}</div>
        <div class="cc"><h3>Top marcas</h3>${mkBar(sy.byMarca,C6)}</div>
      </div>
      <div class="cc" style="margin-top:12px"><h3>ğŸ“… Revisiones por mes</h3>${sy.byMes.length?mkBar(sy.byMes,CB,12):'<p style="font-size:11px;color:var(--txt2)">Sin datos de fecha</p>'}</div>
    </div>`).join('');

  panel.innerHTML=`
    <div class="charts">
      <div class="stat-alerts">
        <div class="alert-card vencidos">
          <div class="ac-num">${vencidos.length}</div>
          <div class="ac-lbl">â›” Ya vencidos</div>
        </div>
        <div class="alert-card proximos">
          <div class="ac-num">${prox8.length}</div>
          <div class="ac-lbl">ğŸ”´ Vencen en ${DIAS_LLAMAR} dÃ­as</div>
        </div>
      </div>
      <div class="yr-stat" style="border-top-color:var(--am)">
        <div style="font-family:var(--serif);font-size:15px;font-weight:700;color:var(--az);margin-bottom:12px">ğŸ“ˆ Tasa de retenciÃ³n por aÃ±o</div>
        ${retBars}
      </div>
      ${yrCards}
    </div>`;

  setTimeout(()=>{panel.querySelectorAll('.bar-fill').forEach((el,i)=>{const w=el.style.width;el.style.width='0';setTimeout(()=>{el.style.width=w;},i*14);});},60);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL GESTIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(placa){
  S.modalPlaca=placa;
  const a=S.analysis;
  const row=a?.matrix?.find(r=>r.Placa===placa);
  if(!row)return;
  const g=GESTION[placa]||{estado:'pendiente',contactos:[]};
  const tel=row.Telefono||'';
  const telNum=tel.replace(/\D/g,'');
  const waNum=telNum.startsWith('57')?telNum:'57'+telNum;
  const msgWA=encodeURIComponent(fillTpl(TPLS.whatsapp,row));

  document.getElementById('mTitle').innerHTML=`${h(row.Placa)} <span style="font-size:14px;font-weight:400;color:var(--txt2)">â€” ${h(row.Propietario||'Sin nombre')}</span>`;

  document.getElementById('mContact').innerHTML=`
    <div style="font-size:11px;color:var(--txt2);margin-bottom:12px">
      <strong>${h(row.Clase||'')} ${h(row.Marca||'')} ${h(row.Linea||'')}</strong> Â· ${h(row.Color||'')} Â· Modelo ${h(row.Modelo||'')}
      &nbsp;Â·&nbsp; ğŸ“ ${h(row.Ciudad||'')}
    </div>
    <div class="contact-cards">
      <div class="contact-card cc-tel">
        <div class="cc-lbl">ğŸ“ TelÃ©fono</div>
        <div class="cc-num">${tel||'Sin nÃºmero'}</div>
        ${tel?`<a class="btn-call btn-tel" href="tel:${tel}" style="display:inline-flex;padding:5px 14px">ğŸ“ Llamar ahora</a>`:''}
      </div>
      <div class="contact-card cc-wa">
        <div class="cc-lbl">ğŸ’¬ WhatsApp</div>
        <div class="cc-num">${tel||'Sin nÃºmero'}</div>
        ${tel?`
          <a class="btn-call btn-wa" href="https://wa.me/${waNum}?text=${msgWA}" target="_blank" style="display:inline-flex;padding:5px 14px;margin-bottom:5px">ğŸ’¬ Abrir chat</a><br>
          <button onclick="copyMsg('${placa}')" style="background:none;border:none;font-size:10px;color:#128c7e;cursor:pointer;text-decoration:underline">ğŸ“‹ Copiar mensaje</button>`
        :''}
      </div>
    </div>`;

  renderMVenc(placa, row);

  const estOpts=ESTADOS.map(e=>`<option value="${e.v}"${g.estado===e.v?' selected':''}>${e.i} ${e.l}</option>`).join('');
  document.getElementById('mForm').innerHTML=`
    <div class="fr"><label>Estado de gestiÃ³n</label>
      <select id="mEstado" onchange="quickEstado()">${estOpts}</select>
    </div>
    <div class="f2col">
      <div class="fr"><label>Tipo de contacto</label>
        <select id="mTipo">
          <option value="llamada">ğŸ“ Llamada</option>
          <option value="whatsapp">ğŸ’¬ WhatsApp</option>
          <option value="sms">ğŸ“± SMS</option>
          <option value="email">ğŸ“§ Email</option>
          <option value="visita">ğŸš¶ Visita</option>
        </select>
      </div>
      <div class="fr"><label>Resultado</label>
        <select id="mRes">
          <option value="no-contestÃ³">No contestÃ³</option>
          <option value="interesado">Interesado âœ…</option>
          <option value="agendÃ³-cita">AgendÃ³ cita ğŸ“…</option>
          <option value="no-interesa">No le interesa âŒ</option>
          <option value="ocupado">Ocupado / rellamar</option>
          <option value="buzÃ³n">BuzÃ³n de voz</option>
          <option value="numero-errado">NÃºmero errado</option>
        </select>
      </div>
    </div>
    <div class="fr"><label>Nota</label>
      <textarea id="mNota" placeholder="Ej: Dijo que viene la prÃ³xima semana, prefiere que llamen en la maÃ±anaâ€¦"></textarea>
    </div>
    <div class="fr"><label>ğŸ“… PrÃ³ximo seguimiento</label>
      <input type="date" id="mProx" value="${new Date().toISOString().slice(0,10)}">
    </div>
    <button class="btn-save" onclick="saveContacto()">ğŸ’¾ Registrar contacto</button>`;

  renderHistorial(placa);
  document.getElementById('modalBg').classList.add('show');
}

function copyMsg(placa){
  const row=S.analysis?.matrix?.find(r=>r.Placa===placa);if(!row)return;
  navigator.clipboard.writeText(fillTpl(TPLS.whatsapp,row)).then(()=>toast('âœ… Mensaje copiado','ok'));
}

function quickEstado(){
  const placa=S.modalPlaca;
  if(!GESTION[placa])GESTION[placa]={estado:'pendiente',contactos:[]};
  GESTION[placa].estado=document.getElementById('mEstado').value;
  persistGestion();refreshBadges();
}

async function saveContacto(){
  const placa=S.modalPlaca;
  if(!GESTION[placa])GESTION[placa]={estado:'pendiente',contactos:[]};
  const g=GESTION[placa];
  g.estado=document.getElementById('mEstado').value;
  g.contactos.unshift({
    tipo:document.getElementById('mTipo').value,
    resultado:document.getElementById('mRes').value,
    nota:document.getElementById('mNota').value.trim(),
    proxFecha:document.getElementById('mProx').value,
    fecha:new Date().toLocaleString('es-CO',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}),
  });
  await persistGestion();
  renderHistorial(placa);
  document.getElementById('mNota').value='';
  refreshBadges();showTodayBanner();
  toast('âœ… Contacto guardado','ok');
}

function deleteContacto(placa,idx){
  GESTION[placa]?.contactos?.splice(idx,1);
  persistGestion();renderHistorial(placa);toast('Contacto eliminado');
}

function renderHistorial(placa){
  const g=GESTION[placa];
  const el=document.getElementById('mHist');if(!el)return;
  if(!g?.contactos?.length){
    el.innerHTML='<div class="hist-wrap"><h4>Historial</h4><p style="font-size:11px;color:var(--txt2)">Sin contactos aÃºn.</p></div>';return;
  }
  const resCls=(r)=>{if(r?.includes('nteresado')||r?.includes('gendÃ³'))return 'ok';if(r?.includes('no-interesa')||r?.includes('errado'))return 'bad';return 'neutral';};
  const tipoI=(t)=>({llamada:'ğŸ“',whatsapp:'ğŸ’¬',sms:'ğŸ“±',email:'ğŸ“§',visita:'ğŸš¶'}[t]||'ğŸ“');
  el.innerHTML=`
    <div class="hist-wrap">
      <h4>Historial de contactos (${g.contactos.length})</h4>
      ${g.contactos.map((c,i)=>`
        <div class="hi ${c.tipo}">
          <div class="hi-head">
            <span class="hi-tipo">${tipoI(c.tipo)} ${c.tipo}</span>
            <span class="hi-res ${resCls(c.resultado)}">${c.resultado}</span>
            ${c.proxFecha?`<span class="hi-prox">ğŸ“… ${c.proxFecha}</span>`:''}
            <span class="hi-fecha">${c.fecha}</span>
            <button class="hi-del" onclick="deleteContacto('${placa}',${i})">âœ•</button>
          </div>
          ${c.nota?`<div class="hi-nota">${h(c.nota)}</div>`:''}
        </div>`).join('')}
    </div>`;
}

function closeModal(){document.getElementById('modalBg').classList.remove('show');S.modalPlaca=null;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(tid){
  const a=S.analysis;if(!a)return;
  const map={nov:a.noVolvieron,rec:a.recurrentes,new:a.nuevos,par:a.parciales,mat:a.matrix};
  const data=map[tid];if(!data?.length){toast('Sin datos','err');return;}
  const base=['Placa','Propietario','Identificacion','Telefono','Correo','Clase','Marca','Linea','Modelo','Color','Ciudad'];
  const yH=[];a.ymaps.forEach(ym=>yH.push(`RevisÃ³_${ym.label}`,`Mes_${ym.label}`,`Venc_${ym.label}`,`Llamar_antes_${ym.label}`));
  yH.push('Estado_Gestion','Ultimo_Contacto','Ultima_Nota','Prox_Seguimiento');
  const rows=data.map(r=>{
    const b=base.map(k=>`"${(r[k]||'').toString().replace(/"/g,'""')}"`);
    const y=[];a.ymaps.forEach((_,i)=>{
      const eff=getVenc(r.Placa,r);
      const vd=eff.date?eff.date.toLocaleDateString('es-CO'):'';
      const ll=eff.date?llamarFechaLabel(eff.date):'';
      y.push(`"${r[`_p${i}`]||''}"`,`"${r[`_m${i}`]||''}"`,`"${vd}"`,`"${ll}"`);
    });
    const g=GESTION[r.Placa]||{};const ult=g.contactos?.[0];
    y.push(`"${g.estado||'pendiente'}"`,`"${ult?.fecha||''}"`,`"${(ult?.nota||'').replace(/"/g,'""')}"`,`"${ult?.proxFecha||''}"`);
    return[...b,...y].join(',');
  });
  const csv='\uFEFF'+[[...base,...yH].join(','),...rows].join('\n');
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  const a2=document.createElement('a');a2.href=url;a2.download=`CDA_${tid}_${new Date().toISOString().slice(0,10)}.csv`;a2.click();URL.revokeObjectURL(url);
  toast(`âœ… Exportado CDA_${tid}.csv`,'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VENCIMIENTO CON OVERRIDE MANUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getVenc(placa, row) {
  // Priority: manual override â†’ last year's calculated date
  const override = GESTION[placa]?.vencOverride;
  if(override) return { date: new Date(override), isManual: true };
  if(row?._vLast) return { date: new Date(row._vLast), isManual: false };
  return { date: null, isManual: false };
}

function saveVencOverride(placa, dateStr) {
  if(!GESTION[placa]) GESTION[placa]={estado:'pendiente',contactos:[]};
  GESTION[placa].vencOverride = dateStr;
  persistGestion();
}

function clearVencOverride(placa) {
  if(GESTION[placa]) delete GESTION[placa].vencOverride;
  persistGestion();
}

function showVencEditor(placa) {
  const el = document.getElementById(`venc_editor_${placa}`);
  if(el) el.style.display = el.style.display==='none' ? 'flex' : 'none';
}

function applyVencOverride(placa) {
  const inp = document.getElementById(`venc_inp_${placa}`);
  if(!inp?.value){ toast('Selecciona una fecha','err'); return; }
  saveVencOverride(placa, inp.value);
  // Refresh the modal venc section and table
  const row = S.analysis?.matrix?.find(r=>r.Placa===placa);
  if(row){ renderMVenc(placa,row); refreshVencCells(placa,row); }
  toast('âœ… Fecha de vencimiento actualizada','ok');
  showTodayBanner();
}

function renderMVenc(placa, row) {
  const v = getVenc(placa, row);
  const el = document.getElementById('mVenc');
  if(!el) return;
  const hasAuto = row?._vLast;
  const isManual = v.isManual;
  const dateStr = v.date ? v.date.toISOString().slice(0,10) : '';
  el.innerHTML = `
    <div class="venc-info">
      <span>â±</span>
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap">
          <strong>Vencimiento RTM: ${v.date ? vencText(v.date) : '<span style="color:var(--txt3)">Sin fecha</span>'}</strong>
          ${isManual ? '<span class="venc-manual-badge">âœï¸ Manual</span>' : ''}
          ${isManual ? `<button class="btn-edit-venc" onclick="clearVencOverride('${placa}');renderMVenc('${placa}',S.analysis.matrix.find(r=>r.Placa==='${placa}'));refreshVencCells('${placa}',S.analysis.matrix.find(r=>r.Placa==='${placa}'))">â†º Usar calculada</button>` : ''}
        </div>
        ${v.date ? `<div style="font-size:10px;color:var(--na);margin-top:2px">ğŸ“ Llamar el ${llamarFechaLabel(v.date)}</div>` : ''}
        ${!hasAuto && !isManual ? '<div style="font-size:10px;color:var(--ro);margin-top:2px">âš ï¸ Este cliente no tiene revisiÃ³n en el Ãºltimo aÃ±o cargado</div>' : ''}
        <button class="btn-edit-venc" style="margin-top:4px" onclick="showVencEditor('${placa}')">
          ${isManual ? 'âœï¸ Cambiar fecha' : 'âœï¸ Corregir fecha manualmente'}
        </button>
        <div class="venc-override-row" id="venc_editor_${placa}" style="display:none">
          <input type="date" id="venc_inp_${placa}" value="${dateStr}" placeholder="Fecha de vencimiento real">
          <button class="btn-save-venc" onclick="applyVencOverride('${placa}')">Guardar</button>
          <button class="btn-cancel-venc" onclick="showVencEditor('${placa}')" style="background:var(--bg);color:var(--txt2);border:1.5px solid var(--bd);border-radius:6px;padding:4px 10px;font-family:var(--font);font-size:11px;cursor:pointer">Cancelar</button>
        </div>
      </div>
    </div>`;
}

function refreshVencCells(placa, row) {
  // Update venc cells in all visible tables for this placa
  document.querySelectorAll(`tr`).forEach(tr=>{
    if(tr.querySelector('.td-placa')?.textContent === placa) {
      const v = getVenc(placa, row);
      tr.querySelectorAll('td').forEach(td=>{
        if(td.querySelector('.venc')||td.querySelector('.venc-dias')) {
          td.innerHTML = vencCell(v.date, placa, row);
        }
      });
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function h(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function uniq(arr,k,ord=false){const s=new Set(arr.map(r=>(r[k]||'').trim()).filter(Boolean));return ord?MO.filter(m=>s.has(m)):[...s].sort();}
function toast(msg,type=''){const e=document.getElementById('notif');e.textContent=msg;e.className='notif show'+(type?' '+type:'');clearTimeout(e._t);e._t=setTimeout(()=>e.classList.remove('show'),3600);}
</script>
</body>
</html>
